const matchCache = {};
const FIELD_CONTENT_REGEXP = /^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;
const KEY_REGEXP = /(?:^|;) *([^=]*)=[^;]*/g;
const SAME_SITE_REGEXP = /^(?:lax|none|strict)$/i;
function getPattern(name) {
    if (name in matchCache) {
        return matchCache[name];
    }
    return matchCache[name] = new RegExp(`(?:^|;) *${name.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&")}=([^;]*)`);
}
function pushCookie(headers, cookie) {
    if (cookie.overwrite) {
        for (let i = headers.length - 1; i >= 0; i--) {
            if (headers[i].indexOf(`${cookie.name}=`) === 0) {
                headers.splice(i, 1);
            }
        }
    }
    headers.push(cookie.toHeader());
}
function validateCookieProperty(key, value) {
    if (value && !FIELD_CONTENT_REGEXP.test(value)) {
        throw new TypeError(`The ${key} of the cookie (${value}) is invalid.`);
    }
}
class Cookie {
    domain;
    expires;
    httpOnly = true;
    maxAge;
    name;
    overwrite = false;
    path = "/";
    sameSite = false;
    secure = false;
    signed;
    value;
    constructor(name, value, attributes) {
        validateCookieProperty("name", name);
        validateCookieProperty("value", value);
        this.name = name;
        this.value = value ?? "";
        Object.assign(this, attributes);
        if (!this.value) {
            this.expires = new Date(0);
            this.maxAge = undefined;
        }
        validateCookieProperty("path", this.path);
        validateCookieProperty("domain", this.domain);
        if (this.sameSite && typeof this.sameSite === "string" &&
            !SAME_SITE_REGEXP.test(this.sameSite)) {
            throw new TypeError(`The sameSite of the cookie ("${this.sameSite}") is invalid.`);
        }
    }
    toHeader() {
        let header = this.toString();
        if (this.maxAge) {
            this.expires = new Date(Date.now() + (this.maxAge * 1000));
        }
        if (this.path) {
            header += `; path=${this.path}`;
        }
        if (this.expires) {
            header += `; expires=${this.expires.toUTCString()}`;
        }
        if (this.domain) {
            header += `; domain=${this.domain}`;
        }
        if (this.sameSite) {
            header += `; samesite=${this.sameSite === true ? "strict" : this.sameSite.toLowerCase()}`;
        }
        if (this.secure) {
            header += "; secure";
        }
        if (this.httpOnly) {
            header += "; httponly";
        }
        return header;
    }
    toString() {
        return `${this.name}=${this.value}`;
    }
}
export class Cookies {
    #cookieKeys;
    #keys;
    #request;
    #response;
    #secure;
    #requestKeys = () => {
        if (this.#cookieKeys) {
            return this.#cookieKeys;
        }
        const result = this.#cookieKeys = [];
        const header = this.#request.headers.get("cookie");
        if (!header) {
            return result;
        }
        let matches;
        while ((matches = KEY_REGEXP.exec(header))) {
            const [, key] = matches;
            result.push(key);
        }
        return result;
    };
    constructor(request, response, options = {}) {
        const { keys, secure } = options;
        this.#keys = keys;
        this.#request = request;
        this.#response = response;
        this.#secure = secure;
    }
    delete(name, options = {}) {
        this.set(name, null, options);
        return true;
    }
    *entries() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = this.get(key);
            if (value) {
                yield [key, value];
            }
        }
    }
    forEach(callback, thisArg = null) {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = this.get(key);
            if (value) {
                callback.call(thisArg, key, value, this);
            }
        }
    }
    get(name, options = {}) {
        const signed = options.signed ?? !!this.#keys;
        const nameSig = `${name}.sig`;
        const header = this.#request.headers.get("cookie");
        if (!header) {
            return;
        }
        const match = header.match(getPattern(name));
        if (!match) {
            return;
        }
        const [, value] = match;
        if (!signed) {
            return value;
        }
        const digest = this.get(nameSig, { signed: false });
        if (!digest) {
            return;
        }
        const data = `${name}=${value}`;
        if (!this.#keys) {
            throw new TypeError("keys required for signed cookies");
        }
        const index = this.#keys.indexOf(data, digest);
        if (index < 0) {
            this.delete(nameSig, { path: "/", signed: false });
        }
        else {
            if (index) {
                this.set(nameSig, this.#keys.sign(data), { signed: false });
            }
            return value;
        }
    }
    *keys() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = this.get(key);
            if (value) {
                yield key;
            }
        }
    }
    set(name, value, options = {}) {
        const request = this.#request;
        const response = this.#response;
        let headers = response.headers.get("Set-Cookie") ?? [];
        if (typeof headers === "string") {
            headers = [headers];
        }
        const secure = this.#secure !== undefined ? this.#secure : request.secure;
        const signed = options.signed ?? !!this.#keys;
        if (!secure && options.secure) {
            throw new TypeError("Cannot send secure cookie over unencrypted connection.");
        }
        const cookie = new Cookie(name, value, options);
        cookie.secure = options.secure ?? secure;
        pushCookie(headers, cookie);
        if (signed) {
            if (!this.#keys) {
                throw new TypeError(".keys required for signed cookies.");
            }
            cookie.value = this.#keys.sign(cookie.toString());
            cookie.name += ".sig";
            pushCookie(headers, cookie);
        }
        for (const header of headers) {
            response.headers.append("Set-Cookie", header);
        }
        return this;
    }
    *values() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = this.get(key);
            if (value) {
                yield value;
            }
        }
    }
    *[Symbol.iterator]() {
        const keys = this.#requestKeys();
        for (const key of keys) {
            const value = this.get(key);
            if (value) {
                yield [key, value];
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29va2llcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvb2tpZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZ0NBLE1BQU0sVUFBVSxHQUEyQixFQUFFLENBQUM7QUFHOUMsTUFBTSxvQkFBb0IsR0FBRyx1Q0FBdUMsQ0FBQztBQUNyRSxNQUFNLFVBQVUsR0FBRyx5QkFBeUIsQ0FBQztBQUM3QyxNQUFNLGdCQUFnQixHQUFHLHdCQUF3QixDQUFDO0FBRWxELFNBQVMsVUFBVSxDQUFDLElBQVk7SUFDOUIsSUFBSSxJQUFJLElBQUksVUFBVSxFQUFFO1FBQ3RCLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3pCO0lBRUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxNQUFNLENBQ2xDLFlBQVksSUFBSSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsRUFBRSxNQUFNLENBQUMsVUFBVSxDQUN2RSxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLE9BQWlCLEVBQUUsTUFBYztJQUNuRCxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzVDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDL0MsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDdEI7U0FDRjtLQUNGO0lBQ0QsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRUQsU0FBUyxzQkFBc0IsQ0FDN0IsR0FBVyxFQUNYLEtBQWdDO0lBRWhDLElBQUksS0FBSyxJQUFJLENB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LENBQUMsQ0FBQzthQUNwQjtTQUNGO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyMCB0aGUgb2FrIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG4vLyBUaGlzIHdhcyBoZWF2aWx5IGluZmx1ZW5jZWQgYnlcbi8vIFtjb29raWVzXShodHRwczovL2dpdGh1Yi5jb20vcGlsbGFyanMvY29va2llcy9ibG9iL21hc3Rlci9pbmRleC5qcylcblxuaW1wb3J0IHR5cGUgeyBLZXlTdGFjayB9IGZyb20gXCIuL2tleVN0YWNrLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFJlcXVlc3QgfSBmcm9tIFwiLi9yZXF1ZXN0LnRzXCI7XG5pbXBvcnQgdHlwZSB7IFJlc3BvbnNlIH0gZnJvbSBcIi4vcmVzcG9uc2UudHNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDb29raWVzT3B0aW9ucyB7XG4gIGtleXM/OiBLZXlTdGFjaztcbiAgc2VjdXJlPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb29raWVzR2V0T3B0aW9ucyB7XG4gIHNpZ25lZD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29va2llc1NldERlbGV0ZU9wdGlvbnMge1xuICBkb21haW4/OiBzdHJpbmc7XG4gIGV4cGlyZXM/OiBEYXRlO1xuICBodHRwT25seT86IGJvb2xlYW47XG4gIG1heEFnZT86IG51bWJlcjtcbiAgb3ZlcndyaXRlPzogYm9vbGVhbjtcbiAgcGF0aD86IHN0cmluZztcbiAgc2VjdXJlPzogYm9vbGVhbjtcbiAgc2FtZVNpdGU/OiBcInN0cmljdFwiIHwgXCJsYXhcIiB8IFwibm9uZVwiIHwgYm9vbGVhbjtcbiAgc2lnbmVkPzogYm9vbGVhbjtcbn1cblxudHlwZSBDb29raWVBdHRyaWJ1dGVzID0gQ29va2llc1NldERlbGV0ZU9wdGlvbnM7XG5cbmNvbnN0IG1hdGNoQ2FjaGU6IFJlY29yZDxzdHJpbmcsIFJlZ0V4cD4gPSB7fTtcblxuLy8gZGVuby1saW50LWlnbm9yZSBuby1jb250cm9sLXJlZ2V4XG5jb25zdCBGSUVMRF9DT05URU5UX1JFR0VYUCA9IC9eW1xcdTAwMDlcXHUwMDIwLVxcdTAwN2VcXHUwMDgwLVxcdTAwZmZdKyQvO1xuY29uc3QgS0VZX1JFR0VYUCA9IC8oPzpefDspICooW149XSopPVteO10qL2c7XG5jb25zdCBTQU1FX1NJVEVfUkVHRVhQID0gL14oPzpsYXh8bm9uZXxzdHJpY3QpJC9pO1xuXG5mdW5jdGlvbiBnZXRQYXR0ZXJuKG5hbWU6IHN0cmluZyk6IFJlZ0V4cCB7XG4gIGlmIChuYW1lIGluIG1hdGNoQ2FjaGUpIHtcbiAgICByZXR1cm4gbWF0Y2hDYWNoZVtuYW1lXTtcbiAgfVxuXG4gIHJldHVybiBtYXRjaENhY2hlW25hbWVdID0gbmV3IFJlZ0V4cChcbiAgICBgKD86Xnw7KSAqJHtuYW1lLnJlcGxhY2UoL1stW1xcXXt9KCkqKz8uLFxcXFxeJHwjXFxzXS9nLCBcIlxcXFwkJlwiKX09KFteO10qKWAsXG4gICk7XG59XG5cbmZ1bmN0aW9uIHB1c2hDb29raWUoaGVhZGVyczogc3RyaW5nW10sIGNvb2tpZTogQ29va2llKTogdm9pZCB7XG4gIGlmIChjb29raWUub3ZlcndyaXRlKSB7XG4gICAgZm9yIChsZXQgaSA9IGhlYWRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGlmIChoZWFkZXJzW2ldLmluZGV4T2YoYCR7Y29va2llLm5hbWV9PWApID09PSAwKSB7XG4gICAgICAgIGhlYWRlcnMuc3BsaWNlKGksIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBoZWFkZXJzLnB1c2goY29va2llLnRvSGVhZGVyKCkpO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUNvb2tpZVByb3BlcnR5KFxuICBrZXk6IHN0cmluZyxcbiAgdmFsdWU6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwsXG4pOiB2b2lkIHtcbiAgaWYgKHZhbHVlICYmICFGSUVMRF9DT05URU5UX1JFR0VYUC50ZXN0KHZhbHVlKSkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYFRoZSAke2tleX0gb2YgdGhlIGNvb2tpZSAoJHt2YWx1ZX0pIGlzIGludmFsaWQuYCk7XG4gIH1cbn1cblxuY2xhc3MgQ29va2llIGltcGxlbWVudHMgQ29va2llQXR0cmlidXRlcyB7XG4gIGRvbWFpbj86IHN0cmluZztcbiAgZXhwaXJlcz86IERhdGU7XG4gIGh0dHBPbmx5ID0gdHJ1ZTtcbiAgbWF4QWdlPzogbnVtYmVyO1xuICBuYW1lOiBzdHJpbmc7XG4gIG92ZXJ3cml0ZSA9IGZhbHNlO1xuICBwYXRoID0gXCIvXCI7XG4gIHNhbWVTaXRlOiBcInN0cmljdFwiIHwgXCJsYXhcIiB8IFwibm9uZVwiIHwgYm9vbGVhbiA9IGZhbHNlO1xuICBzZWN1cmUgPSBmYWxzZTtcbiAgc2lnbmVkPzogYm9vbGVhbjtcbiAgdmFsdWU6IHN0cmluZztcblxuICAvKiogQSBsb2dpY2FsIHJlcHJlc2VudGF0aW9uIG9mIGEgY29va2llLCB1c2VkIHRvIGludGVybmFsbHkgbWFuYWdlIHRoZVxuICAgKiBjb29raWUgaW5zdGFuY2VzLiAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgdmFsdWU6IHN0cmluZyB8IG51bGwsXG4gICAgYXR0cmlidXRlczogQ29va2llQXR0cmlidXRlcyxcbiAgKSB7XG4gICAgdmFsaWRhdGVDb29raWVQcm9wZXJ0eShcIm5hbWVcIiwgbmFtZSk7XG4gICAgdmFsaWRhdGVDb29raWVQcm9wZXJ0eShcInZhbHVlXCIsIHZhbHVlKTtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMudmFsdWUgPSB2YWx1ZSA/PyBcIlwiO1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywgYXR0cmlidXRlcyk7XG4gICAgaWYgKCF0aGlzLnZhbHVlKSB7XG4gICAgICB0aGlzLmV4cGlyZXMgPSBuZXcgRGF0ZSgwKTtcbiAgICAgIHRoaXMubWF4QWdlID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIHZhbGlkYXRlQ29va2llUHJvcGVydHkoXCJwYXRoXCIsIHRoaXMucGF0aCk7XG4gICAgdmFsaWRhdGVDb29raWVQcm9wZXJ0eShcImRvbWFpblwiLCB0aGlzLmRvbWFpbik7XG4gICAgaWYgKFxuICAgICAgdGhpcy5zYW1lU2l0ZSAmJiB0eXBlb2YgdGhpcy5zYW1lU2l0ZSA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgIVNBTUVfU0lURV9SRUdFWFAudGVzdCh0aGlzLnNhbWVTaXRlKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgYFRoZSBzYW1lU2l0ZSBvZiB0aGUgY29va2llIChcIiR7dGhpcy5zYW1lU2l0ZX1cIikgaXMgaW52YWxpZC5gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICB0b0hlYWRlcigpOiBzdHJpbmcge1xuICAgIGxldCBoZWFkZXIgPSB0aGlzLnRvU3RyaW5nKCk7XG4gICAgaWYgKHRoaXMubWF4QWdlKSB7XG4gICAgICB0aGlzLmV4cGlyZXMgPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgKHRoaXMubWF4QWdlICogMTAwMCkpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnBhdGgpIHtcbiAgICAgIGhlYWRlciArPSBgOyBwYXRoPSR7dGhpcy5wYXRofWA7XG4gICAgfVxuICAgIGlmICh0aGlzLmV4cGlyZXMpIHtcbiAgICAgIGhlYWRlciArPSBgOyBleHBpcmVzPSR7dGhpcy5leHBpcmVzLnRvVVRDU3RyaW5nKCl9YDtcbiAgICB9XG4gICAgaWYgKHRoaXMuZG9tYWluKSB7XG4gICAgICBoZWFkZXIgKz0gYDsgZG9tYWluPSR7dGhpcy5kb21haW59YDtcbiAgICB9XG4gICAgaWYgKHRoaXMuc2FtZVNpdGUpIHtcbiAgICAgIGhlYWRlciArPSBgOyBzYW1lc2l0ZT0ke1xuICAgICAgICB0aGlzLnNhbWVTaXRlID09PSB0cnVlID8gXCJzdHJpY3RcIiA6IHRoaXMuc2FtZVNpdGUudG9Mb3dlckNhc2UoKVxuICAgICAgfWA7XG4gICAgfVxuICAgIGlmICh0aGlzLnNlY3VyZSkge1xuICAgICAgaGVhZGVyICs9IFwiOyBzZWN1cmVcIjtcbiAgICB9XG4gICAgaWYgKHRoaXMuaHR0cE9ubHkpIHtcbiAgICAgIGhlYWRlciArPSBcIjsgaHR0cG9ubHlcIjtcbiAgICB9XG5cbiAgICByZXR1cm4gaGVhZGVyO1xuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dGhpcy5uYW1lfT0ke3RoaXMudmFsdWV9YDtcbiAgfVxufVxuXG4vKiogQW4gaW50ZXJmYWNlIHdoaWNoIGFsbG93cyBzZXR0aW5nIGFuZCBhY2Nlc3NpbmcgY29va2llcyByZWxhdGVkIHRvIGJvdGggdGhlXG4gKiBjdXJyZW50IHJlcXVlc3QgYW5kIHJlc3BvbnNlLiAqL1xuZXhwb3J0IGNsYXNzIENvb2tpZXMge1xuICAjY29va2llS2V5cz86IHN0cmluZ1tdO1xuICAja2V5cz86IEtleVN0YWNrO1xuICAjcmVxdWVzdDogUmVxdWVzdDtcbiAgI3Jlc3BvbnNlOiBSZXNwb25zZTtcbiAgI3NlY3VyZT86IGJvb2xlYW47XG5cbiAgI3JlcXVlc3RLZXlzID0gKCk6IHN0cmluZ1tdID0+IHtcbiAgICBpZiAodGhpcy4jY29va2llS2V5cykge1xuICAgICAgcmV0dXJuIHRoaXMuI2Nvb2tpZUtleXM7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuI2Nvb2tpZUtleXMgPSBbXSBhcyBzdHJpbmdbXTtcbiAgICBjb25zdCBoZWFkZXIgPSB0aGlzLiNyZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiY29va2llXCIpO1xuICAgIGlmICghaGVhZGVyKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBsZXQgbWF0Y2hlczogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcbiAgICB3aGlsZSAoKG1hdGNoZXMgPSBLRVlfUkVHRVhQLmV4ZWMoaGVhZGVyKSkpIHtcbiAgICAgIGNvbnN0IFssIGtleV0gPSBtYXRjaGVzO1xuICAgICAgcmVzdWx0LnB1c2goa2V5KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICByZXF1ZXN0OiBSZXF1ZXN0LFxuICAgIHJlc3BvbnNlOiBSZXNwb25zZSxcbiAgICBvcHRpb25zOiBDb29raWVzT3B0aW9ucyA9IHt9LFxuICApIHtcbiAgICBjb25zdCB7IGtleXMsIHNlY3VyZSB9ID0gb3B0aW9ucztcbiAgICB0aGlzLiNrZXlzID0ga2V5cztcbiAgICB0aGlzLiNyZXF1ZXN0ID0gcmVxdWVzdDtcbiAgICB0aGlzLiNyZXNwb25zZSA9IHJlc3BvbnNlO1xuICAgIHRoaXMuI3NlY3VyZSA9IHNlY3VyZTtcbiAgfVxuXG4gIC8qKiBTZXQgYSBjb29raWUgdG8gYmUgZGVsZXRlZCBpbiB0aGUgcmVzcG9uc2UuICBUaGlzIGlzIGEgXCJzaG9ydGN1dFwiIHRvXG4gICAqIGAuc2V0KG5hbWUsIG51bGwsIG9wdGlvbnM/KWAuICovXG4gIGRlbGV0ZShuYW1lOiBzdHJpbmcsIG9wdGlvbnM6IENvb2tpZXNTZXREZWxldGVPcHRpb25zID0ge30pOiBib29sZWFuIHtcbiAgICB0aGlzLnNldChuYW1lLCBudWxsLCBvcHRpb25zKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKiBJdGVyYXRlIG92ZXIgdGhlIHJlcXVlc3QncyBjb29raWVzLCB5aWVsZGluZyB1cCBhIHR1cGxlIGNvbnRhaW5pbmcgdGhlXG4gICAqIGtleSBhbmQgdGhlIHZhbHVlLlxuICAgKiBcbiAgICogSWYgdGhlcmUgYXJlIGtleXMgc2V0IG9uIHRoZSBhcHBsaWNhdGlvbiwgb25seSBrZXlzIGFuZCB2YWx1ZXMgdGhhdCBhcmVcbiAgICogcHJvcGVybHkgc2lnbmVkIHdpbGwgYmUgcmV0dXJuZWQuICovXG4gICplbnRyaWVzKCk6IEl0ZXJhYmxlSXRlcmF0b3I8W3N0cmluZywgc3RyaW5nXT4ge1xuICAgIGNvbnN0IGtleXMgPSB0aGlzLiNyZXF1ZXN0S2V5cygpO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXQoa2V5KTtcbiAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICB5aWVsZCBba2V5LCB2YWx1ZV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZm9yRWFjaChcbiAgICBjYWxsYmFjazogKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBjb29raWVzOiB0aGlzKSA9PiB2b2lkLFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgdGhpc0FyZzogYW55ID0gbnVsbCxcbiAgKTogdm9pZCB7XG4gICAgY29uc3Qga2V5cyA9IHRoaXMuI3JlcXVlc3RLZXlzKCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldChrZXkpO1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIGNhbGxiYWNrLmNhbGwodGhpc0FyZywga2V5LCB2YWx1ZSwgdGhpcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqIEdldCB0aGUgdmFsdWUgb2YgYSBjb29raWUgZnJvbSB0aGUgcmVxdWVzdC5cbiAgICogXG4gICAqIElmIHRoZSBjb29raWUgaXMgc2lnbmVkLCBhbmQgdGhlIHNpZ25hdHVyZSBpcyBpbnZhbGlkLCB0aGUgY29va2llIHdpbGxcbiAgICogYmUgc2V0IHRvIGJlIGRlbGV0ZWQgaW4gdGhlIHRoZSByZXNwb25zZS4gIElmIHRoZSBzaWduYXR1cmUgdXNlcyBhbiBcIm9sZFwiXG4gICAqIGtleSwgdGhlIGNvb2tpZSB3aWxsIGJlIHJlLXNpZ25lZCB3aXRoIHRoZSBjdXJyZW50IGtleSBhbmQgYmUgYWRkZWQgdG8gdGhlXG4gICAqIHJlc3BvbnNlIHRvIGJlIHVwZGF0ZWQuICovXG4gIGdldChuYW1lOiBzdHJpbmcsIG9wdGlvbnM6IENvb2tpZXNHZXRPcHRpb25zID0ge30pOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHNpZ25lZCA9IG9wdGlvbnMuc2lnbmVkID8/ICEhdGhpcy4ja2V5cztcbiAgICBjb25zdCBuYW1lU2lnID0gYCR7bmFtZX0uc2lnYDtcblxuICAgIGNvbnN0IGhlYWRlciA9IHRoaXMuI3JlcXVlc3QuaGVhZGVycy5nZXQoXCJjb29raWVcIik7XG4gICAgaWYgKCFoZWFkZXIpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgbWF0Y2ggPSBoZWFkZXIubWF0Y2goZ2V0UGF0dGVybihuYW1lKSk7XG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBbLCB2YWx1ZV0gPSBtYXRjaDtcbiAgICBpZiAoIXNpZ25lZCkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjb25zdCBkaWdlc3QgPSB0aGlzLmdldChuYW1lU2lnLCB7IHNpZ25lZDogZmFsc2UgfSk7XG4gICAgaWYgKCFkaWdlc3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZGF0YSA9IGAke25hbWV9PSR7dmFsdWV9YDtcbiAgICBpZiAoIXRoaXMuI2tleXMpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJrZXlzIHJlcXVpcmVkIGZvciBzaWduZWQgY29va2llc1wiKTtcbiAgICB9XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLiNrZXlzLmluZGV4T2YoZGF0YSwgZGlnZXN0KTtcblxuICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgIHRoaXMuZGVsZXRlKG5hbWVTaWcsIHsgcGF0aDogXCIvXCIsIHNpZ25lZDogZmFsc2UgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChpbmRleCkge1xuICAgICAgICAvLyB0aGUga2V5IGhhcyBcImFnZWRcIiBhbmQgbmVlZHMgdG8gYmUgcmUtc2lnbmVkXG4gICAgICAgIHRoaXMuc2V0KG5hbWVTaWcsIHRoaXMuI2tleXMuc2lnbihkYXRhKSwgeyBzaWduZWQ6IGZhbHNlIH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBJdGVyYXRlIG92ZXIgdGhlIHJlcXVlc3QncyBjb29raWVzLCB5aWVsZGluZyB1cCB0aGUga2V5cy5cbiAgICogXG4gICAqIElmIHRoZXJlIGFyZSBrZXlzIHNldCBvbiB0aGUgYXBwbGljYXRpb24sIG9ubHkgdGhlIGtleXMgdGhhdCBhcmUgcHJvcGVybHlcbiAgICogc2lnbmVkIHdpbGwgYmUgcmV0dXJuZWQuICovXG4gICprZXlzKCk6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gICAgY29uc3Qga2V5cyA9IHRoaXMuI3JlcXVlc3RLZXlzKCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldChrZXkpO1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIHlpZWxkIGtleTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKiogU2V0IGEgY29va2llIGluIHRoZSByZXNwb25zZS5cbiAgICogXG4gICAqIElmIHRoZXJlIGFyZSBrZXlzIHNldCBpbiB0aGUgYXBwbGljYXRpb24sIGNvb2tpZXMgd2lsbCBiZSBhdXRvbWF0aWNhbGx5XG4gICAqIHNpZ25lZCwgdW5sZXNzIG92ZXJyaWRkZW4gYnkgdGhlIHNldCBvcHRpb25zLiAgQ29va2llcyBjYW4gYmUgZGVsZXRlZCBieVxuICAgKiBzZXR0aW5nIHRoZSB2YWx1ZSB0byBgbnVsbGAuICovXG4gIHNldChcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgdmFsdWU6IHN0cmluZyB8IG51bGwsXG4gICAgb3B0aW9uczogQ29va2llc1NldERlbGV0ZU9wdGlvbnMgPSB7fSxcbiAgKTogdGhpcyB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHRoaXMuI3JlcXVlc3Q7XG4gICAgY29uc3QgcmVzcG9uc2UgPSB0aGlzLiNyZXNwb25zZTtcbiAgICBsZXQgaGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KFwiU2V0LUNvb2tpZVwiKSA/PyBbXSBhcyBzdHJpbmdbXTtcbiAgICBpZiAodHlwZW9mIGhlYWRlcnMgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGhlYWRlcnMgPSBbaGVhZGVyc107XG4gICAgfVxuICAgIGNvbnN0IHNlY3VyZSA9IHRoaXMuI3NlY3VyZSAhPT0gdW5kZWZpbmVkID8gdGhpcy4jc2VjdXJlIDogcmVxdWVzdC5zZWN1cmU7XG4gICAgY29uc3Qgc2lnbmVkID0gb3B0aW9ucy5zaWduZWQgPz8gISF0aGlzLiNrZXlzO1xuXG4gICAgaWYgKCFzZWN1cmUgJiYgb3B0aW9ucy5zZWN1cmUpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXG4gICAgICAgIFwiQ2Fubm90IHNlbmQgc2VjdXJlIGNvb2tpZSBvdmVyIHVuZW5jcnlwdGVkIGNvbm5lY3Rpb24uXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNvb2tpZSA9IG5ldyBDb29raWUobmFtZSwgdmFsdWUsIG9wdGlvbnMpO1xuICAgIGNvb2tpZS5zZWN1cmUgPSBvcHRpb25zLnNlY3VyZSA/PyBzZWN1cmU7XG4gICAgcHVzaENvb2tpZShoZWFkZXJzLCBjb29raWUpO1xuXG4gICAgaWYgKHNpZ25lZCkge1xuICAgICAgaWYgKCF0aGlzLiNrZXlzKSB7XG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCIua2V5cyByZXF1aXJlZCBmb3Igc2lnbmVkIGNvb2tpZXMuXCIpO1xuICAgICAgfVxuICAgICAgY29va2llLnZhbHVlID0gdGhpcy4ja2V5cy5zaWduKGNvb2tpZS50b1N0cmluZygpKTtcbiAgICAgIGNvb2tpZS5uYW1lICs9IFwiLnNpZ1wiO1xuICAgICAgcHVzaENvb2tpZShoZWFkZXJzLCBjb29raWUpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgaGVhZGVyIG9mIGhlYWRlcnMpIHtcbiAgICAgIHJlc3BvbnNlLmhlYWRlcnMuYXBwZW5kKFwiU2V0LUNvb2tpZVwiLCBoZWFkZXIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKiBJdGVyYXRlIG92ZXIgdGhlIHJlcXVlc3QncyBjb29raWVzLCB5aWVsZGluZyB1cCBlYWNoIHZhbHVlLlxuICAgKiBcbiAgICogSWYgdGhlcmUgYXJlIGtleXMgc2V0IG9uIHRoZSBhcHBsaWNhdGlvbiwgb25seSB0aGUgdmFsdWVzIHRoYXQgYXJlXG4gICAqIHByb3Blcmx5IHNpZ25lZCB3aWxsIGJlIHJldHVybmVkLiAqL1xuICAqdmFsdWVzKCk6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XG4gICAgY29uc3Qga2V5cyA9IHRoaXMuI3JlcXVlc3RLZXlzKCk7XG4gICAgZm9yIChjb25zdCBrZXkgb2Yga2V5cykge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldChrZXkpO1xuICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgIHlpZWxkIHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKiBJdGVyYXRlIG92ZXIgdGhlIHJlcXVlc3QncyBjb29raWVzLCB5aWVsZGluZyB1cCBhIHR1cGxlIGNvbnRhaW5pbmcgdGhlXG4gICAqIGtleSBhbmQgdGhlIHZhbHVlLlxuICAgKiBcbiAgICogSWYgdGhlcmUgYXJlIGtleXMgc2V0IG9uIHRoZSBhcHBsaWNhdGlvbiwgb25seSBrZXlzIGFuZCB2YWx1ZXMgdGhhdCBhcmVcbiAgICogcHJvcGVybHkgc2lnbmVkIHdpbGwgYmUgcmV0dXJuZWQuICovXG4gICpbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+IHtcbiAgICBjb25zdCBrZXlzID0gdGhpcy4jcmVxdWVzdEtleXMoKTtcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0KGtleSk7XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgeWllbGQgW2tleSwgdmFsdWVdO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19