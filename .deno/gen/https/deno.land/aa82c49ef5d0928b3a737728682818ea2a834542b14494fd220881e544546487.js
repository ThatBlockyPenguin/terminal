import { assert } from "./deps.ts";
const encoder = new TextEncoder();
class CloseEvent extends Event {
    constructor(eventInit) {
        super("close", eventInit);
    }
}
export class ServerSentEvent extends Event {
    #data;
    #id;
    #type;
    constructor(type, data, { replacer, space, ...eventInit } = {}) {
        super(type, eventInit);
        this.#type = type;
        try {
            this.#data = typeof data === "string"
                ? data
                : JSON.stringify(data, replacer, space);
        }
        catch (e) {
            assert(e instanceof Error);
            throw new TypeError(`data could not be coerced into a serialized string.\n  ${e.message}`);
        }
        const { id } = eventInit;
        this.#id = id;
    }
    get data() {
        return this.#data;
    }
    get id() {
        return this.#id;
    }
    toString() {
        const data = `data: ${this.#data.split("\n").join("\ndata: ")}\n`;
        return `${this.#type === "__message" ? "" : `event: ${this.#type}\n`}${this.#id ? `id: ${String(this.#id)}\n` : ""}${data}\n`;
    }
}
const response = `HTTP/1.1 200 OK\n`;
const responseHeaders = new Headers([
    ["Connection", "Keep-Alive"],
    ["Content-Type", "text/event-stream"],
    ["Cache-Control", "no-cache"],
    ["Keep-Alive", `timeout=${Number.MAX_SAFE_INTEGER}`],
]);
export class ServerSentEventTarget extends EventTarget {
    #app;
    #closed = false;
    #prev = Promise.resolve();
    #ready;
    #serverRequest;
    #writer;
    #send = async (payload, prev) => {
        if (this.#closed) {
            return;
        }
        if (this.#ready !== true) {
            await this.#ready;
            this.#ready = true;
        }
        try {
            await prev;
            await this.#writer.write(encoder.encode(payload));
            await this.#writer.flush();
        }
        catch (error) {
            this.dispatchEvent(new CloseEvent({ cancelable: false }));
            const errorEvent = new ErrorEvent("error", { error });
            this.dispatchEvent(errorEvent);
            this.#app.dispatchEvent(errorEvent);
        }
    };
    #setup = async (overrideHeaders) => {
        const headers = new Headers(responseHeaders);
        if (overrideHeaders) {
            for (const [key, value] of overrideHeaders) {
                headers.set(key, value);
            }
        }
        let payload = response;
        for (const [key, value] of headers) {
            payload += `${key}: ${value}\n`;
        }
        payload += `\n`;
        try {
            await this.#writer.write(encoder.encode(payload));
            await this.#writer.flush();
        }
        catch (error) {
            this.dispatchEvent(new CloseEvent({ cancelable: false }));
            const errorEvent = new ErrorEvent("error", { error });
            this.dispatchEvent(errorEvent);
            this.#app.dispatchEvent(errorEvent);
            throw error;
        }
    };
    get closed() {
        return this.#closed;
    }
    constructor(app, serverRequest, { headers } = {}) {
        super();
        this.#app = app;
        this.#serverRequest = serverRequest;
        this.#writer = this.#serverRequest.w;
        this.addEventListener("close", () => {
            this.#closed = true;
            try {
                this.#serverRequest.conn.close();
            }
            catch (error) {
                if (!(error instanceof Deno.errors.BadResource)) {
                    const errorEvent = new ErrorEvent("error", { error });
                    this.dispatchEvent(errorEvent);
                    this.#app.dispatchEvent(errorEvent);
                }
            }
        });
        this.#ready = this.#setup(headers);
    }
    async close() {
        if (this.#ready !== true) {
            await this.#ready;
        }
        await this.#prev;
        this.dispatchEvent(new CloseEvent({ cancelable: false }));
    }
    dispatchComment(comment) {
        this.#prev = this.#send(`: ${comment.split("\n").join("\n: ")}\n\n`, this.#prev);
        return true;
    }
    dispatchMessage(data) {
        const event = new ServerSentEvent("__message", data);
        return this.dispatchEvent(event);
    }
    dispatchEvent(event) {
        const dispatched = super.dispatchEvent(event);
        if (dispatched && event instanceof ServerSentEvent) {
            this.#prev = this.#send(String(event), this.#prev);
        }
        return dispatched;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyX3NlbnRfZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXJ2ZXJfc2VudF9ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsTUFBTSxFQUFhLE1BQU0sV0FBVyxDQUFDO0FBRzlDLE1BQU0sT0FBTyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7QUF5QmxDLE1BQU0sVUFBVyxTQUFRLEtBQUs7SUFDNUIsWUFBWSxTQUFvQjtRQUM5QixLQUFLLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7Q0FDRjtBQUlELE1BQU0sT0FBTyxlQUFnQixTQUFRLEtBQUs7SUFDeEMsS0FBSyxDQUFTO0lBQ2QsR0FBRyxDQUFVO0lBQ2IsS0FBSyxDQUFTO0lBRWQsWUFDRSxJQUFZLEVBRVosSUFBUyxFQUNULEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFHLFNBQVMsS0FBMEIsRUFBRTtRQUUzRCxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUk7WUFDRixJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sSUFBSSxLQUFLLFFBQVE7Z0JBQ25DLENBQUMsQ0FBQyxJQUFJO2dCQUNOLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUErQixFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2xFO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixNQUFNLENBQUMsQ0FBQyxZQUFZLEtBQUssQ0FBQyxDQUFDO1lBQzNCLE1BQU0sSUFBSSxTQUFTLENBQ2pCLDBEQUEwRCxDQUFDLENBQUMsT0FBTyxFQUFFLENBQ3RFLENBQUM7U0FDSDtRQUNELE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFDekIsSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUM7SUFDaEIsQ0FB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LElBQUksQ0FBQyxDQUFDO1FBQ3JELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBeUJELGFBQWEsQ0FBQyxLQUFnRDtRQUM1RCxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlDLElBQUksVUFBVSxJQUFJLEtBQUssWUFBWSxlQUFlLEVBQUU7WUFDbEQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEQ7UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDIwIHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbmltcG9ydCB0eXBlIHsgQXBwbGljYXRpb24gfSBmcm9tIFwiLi9hcHBsaWNhdGlvbi50c1wiO1xuaW1wb3J0IHsgYXNzZXJ0LCBCdWZXcml0ZXIgfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgdHlwZSB7IFNlcnZlclJlcXVlc3QgfSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5cbmNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcblxuZXhwb3J0IGludGVyZmFjZSBTZXJ2ZXJTZW50RXZlbnRJbml0IGV4dGVuZHMgRXZlbnRJbml0IHtcbiAgLyoqIEFuIG9wdGlvbmFsIGBpZGAgd2hpY2ggd2lsbCBiZSBzZW50IHdpdGggdGhlIGV2ZW50IGFuZCBleHBvc2VkIGluIHRoZVxuICAgKiBjbGllbnQgYEV2ZW50U291cmNlYC4gKi9cbiAgaWQ/OiBudW1iZXI7XG5cbiAgLyoqIFRoZSByZXBsYWNlciBpcyBwYXNzZWQgdG8gYEpTT04uc3RyaW5naWZ5YCB3aGVuIGNvbnZlcnRpbmcgdGhlIGBkYXRhYFxuICAgKiBwcm9wZXJ0eSB0byBhIEpTT04gc3RyaW5nLiAqL1xuICByZXBsYWNlcj86XG4gICAgfCAoc3RyaW5nIHwgbnVtYmVyKVtdXG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICB8ICgodGhpczogYW55LCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSkgPT4gYW55KTtcblxuICAvKiogU3BhY2UgaXMgcGFzc2VkIHRvIGBKU09OLnN0cmluZ2lmeWAgd2hlbiBjb252ZXJ0aW5nIHRoZSBgZGF0YWAgcHJvcGVydHlcbiAgICogdG8gYSBKU09OIHN0cmluZy4gKi9cbiAgc3BhY2U/OiBzdHJpbmcgfCBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VydmVyU2VudEV2ZW50VGFyZ2V0T3B0aW9ucyB7XG4gIC8qKiBBZGRpdGlvbmFsIGhlYWRlcnMgdG8gc2VuZCB0byB0aGUgY2xpZW50IGR1cmluZyBzdGFydHVwLiAgVGhlc2UgaGVhZGVyc1xuICAgKiB3aWxsIG92ZXJ3cml0ZSBhbnkgb2YgdGhlIGRlZmF1bHQgaGVhZGVycyBpZiB0aGUga2V5IGlzIGR1cGxpY2F0ZWQuICovXG4gIGhlYWRlcnM/OiBIZWFkZXJzO1xufVxuXG5jbGFzcyBDbG9zZUV2ZW50IGV4dGVuZHMgRXZlbnQge1xuICBjb25zdHJ1Y3RvcihldmVudEluaXQ6IEV2ZW50SW5pdCkge1xuICAgIHN1cGVyKFwiY2xvc2VcIiwgZXZlbnRJbml0KTtcbiAgfVxufVxuXG4vKiogQW4gZXZlbnQgd2hpY2ggY29udGFpbnMgaW5mb3JtYXRpb24gd2hpY2ggd2lsbCBiZSBzZW50IHRvIHRoZSByZW1vdGVcbiAqIGNvbm5lY3Rpb24gYW5kIGJlIG1hZGUgYXZhaWxhYmxlIGluIGFuIGBFdmVudFNvdXJjZWAgYXMgYW4gZXZlbnQuICovXG5leHBvcnQgY2xhc3MgU2VydmVyU2VudEV2ZW50IGV4dGVuZHMgRXZlbnQge1xuICAjZGF0YTogc3RyaW5nO1xuICAjaWQ/OiBudW1iZXI7XG4gICN0eXBlOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgdHlwZTogc3RyaW5nLFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgZGF0YTogYW55LFxuICAgIHsgcmVwbGFjZXIsIHNwYWNlLCAuLi5ldmVudEluaXQgfTogU2VydmVyU2VudEV2ZW50SW5pdCA9IHt9LFxuICApIHtcbiAgICBzdXBlcih0eXBlLCBldmVudEluaXQpO1xuICAgIHRoaXMuI3R5cGUgPSB0eXBlO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLiNkYXRhID0gdHlwZW9mIGRhdGEgPT09IFwic3RyaW5nXCJcbiAgICAgICAgPyBkYXRhXG4gICAgICAgIDogSlNPTi5zdHJpbmdpZnkoZGF0YSwgcmVwbGFjZXIgYXMgKHN0cmluZyB8IG51bWJlcilbXSwgc3BhY2UpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGFzc2VydChlIGluc3RhbmNlb2YgRXJyb3IpO1xuICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihcbiAgICAgICAgYGRhdGEgY291bGQgbm90IGJlIGNvZXJjZWQgaW50byBhIHNlcmlhbGl6ZWQgc3RyaW5nLlxcbiAgJHtlLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICAgIGNvbnN0IHsgaWQgfSA9IGV2ZW50SW5pdDtcbiAgICB0aGlzLiNpZCA9IGlkO1xuICB9XG5cbiAgLyoqIFRoZSBkYXRhIGFzc29jaWF0ZWQgd2l0aCB0aGUgZXZlbnQsIHdoaWNoIHdpbGwgYmUgc2VudCB0byB0aGUgY2xpZW50IGFuZFxuICAgKiBiZSBtYWRlIGF2YWlsYWJsZSBpbiB0aGUgYEV2ZW50U291cmNlYC4gKi9cbiAgZ2V0IGRhdGEoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy4jZGF0YTtcbiAgfVxuXG4gIC8qKiBUaGUgb3B0aW9uYWwgSUQgYXNzb2NpYXRlZCB3aXRoIHRoZSBldmVudCB0aGF0IHdpbGwgYmUgc2VudCB0byB0aGUgY2xpZW50XG4gICAqIGFuZCBiZSBtYWRlIGF2YWlsYWJsZSBpbiB0aGUgYEV2ZW50U291cmNlYC4gKi9cbiAgZ2V0IGlkKCk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMuI2lkO1xuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICBjb25zdCBkYXRhID0gYGRhdGE6ICR7dGhpcy4jZGF0YS5zcGxpdChcIlxcblwiKS5qb2luKFwiXFxuZGF0YTogXCIpfVxcbmA7XG4gICAgcmV0dXJuIGAke3RoaXMuI3R5cGUgPT09IFwiX19tZXNzYWdlXCIgPyBcIlwiIDogYGV2ZW50OiAke3RoaXMuI3R5cGV9XFxuYH0ke1xuICAgICAgdGhpcy4jaWQgPyBgaWQ6ICR7U3RyaW5nKHRoaXMuI2lkKX1cXG5gIDogXCJcIlxuICAgIH0ke2RhdGF9XFxuYDtcbiAgfVxufVxuXG5jb25zdCByZXNwb25zZSA9IGBIVFRQLzEuMSAyMDAgT0tcXG5gO1xuXG5jb25zdCByZXNwb25zZUhlYWRlcnMgPSBuZXcgSGVhZGVycyhcbiAgW1xuICAgIFtcIkNvbm5lY3Rpb25cIiwgXCJLZWVwLUFsaXZlXCJdLFxuICAgIFtcIkNvbnRlbnQtVHlwZVwiLCBcInRleHQvZXZlbnQtc3RyZWFtXCJdLFxuICAgIFtcIkNhY2hlLUNvbnRyb2xcIiwgXCJuby1jYWNoZVwiXSxcbiAgICBbXCJLZWVwLUFsaXZlXCIsIGB0aW1lb3V0PSR7TnVtYmVyLk1BWF9TQUZFX0lOVEVHRVJ9YF0sXG4gIF0sXG4pO1xuXG5leHBvcnQgY2xhc3MgU2VydmVyU2VudEV2ZW50VGFyZ2V0IGV4dGVuZHMgRXZlbnRUYXJnZXQge1xuICAjYXBwOiBBcHBsaWNhdGlvbjtcbiAgI2Nsb3NlZCA9IGZhbHNlO1xuICAjcHJldiA9IFByb21pc2UucmVzb2x2ZSgpO1xuICAjcmVhZHk6IFByb21pc2U8dm9pZD4gfCB0cnVlO1xuICAjc2VydmVyUmVxdWVzdDogU2VydmVyUmVxdWVzdDtcbiAgI3dyaXRlcjogQnVmV3JpdGVyO1xuXG4gICNzZW5kID0gYXN5bmMgKHBheWxvYWQ6IHN0cmluZywgcHJldjogUHJvbWlzZTx2b2lkPik6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGlmICh0aGlzLiNjbG9zZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuI3JlYWR5ICE9PSB0cnVlKSB7XG4gICAgICBhd2FpdCB0aGlzLiNyZWFkeTtcbiAgICAgIHRoaXMuI3JlYWR5ID0gdHJ1ZTtcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHByZXY7XG4gICAgICBhd2FpdCB0aGlzLiN3cml0ZXIud3JpdGUoZW5jb2Rlci5lbmNvZGUocGF5bG9hZCkpO1xuICAgICAgYXdhaXQgdGhpcy4jd3JpdGVyLmZsdXNoKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChuZXcgQ2xvc2VFdmVudCh7IGNhbmNlbGFibGU6IGZhbHNlIH0pKTtcbiAgICAgIGNvbnN0IGVycm9yRXZlbnQgPSBuZXcgRXJyb3JFdmVudChcImVycm9yXCIsIHsgZXJyb3IgfSk7XG4gICAgICB0aGlzLmRpc3BhdGNoRXZlbnQoZXJyb3JFdmVudCk7XG4gICAgICB0aGlzLiNhcHAuZGlzcGF0Y2hFdmVudChlcnJvckV2ZW50KTtcbiAgICB9XG4gIH07XG5cbiAgI3NldHVwID0gYXN5bmMgKG92ZXJyaWRlSGVhZGVycz86IEhlYWRlcnMpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMocmVzcG9uc2VIZWFkZXJzKTtcbiAgICBpZiAob3ZlcnJpZGVIZWFkZXJzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBvdmVycmlkZUhlYWRlcnMpIHtcbiAgICAgICAgaGVhZGVycy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCBwYXlsb2FkID0gcmVzcG9uc2U7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgaGVhZGVycykge1xuICAgICAgcGF5bG9hZCArPSBgJHtrZXl9OiAke3ZhbHVlfVxcbmA7XG4gICAgfVxuICAgIHBheWxvYWQgKz0gYFxcbmA7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuI3dyaXRlci53cml0ZShlbmNvZGVyLmVuY29kZShwYXlsb2FkKSk7XG4gICAgICBhd2FpdCB0aGlzLiN3cml0ZXIuZmx1c2goKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDbG9zZUV2ZW50KHsgY2FuY2VsYWJsZTogZmFsc2UgfSkpO1xuICAgICAgY29uc3QgZXJyb3JFdmVudCA9IG5ldyBFcnJvckV2ZW50KFwiZXJyb3JcIiwgeyBlcnJvciB9KTtcbiAgICAgIHRoaXMuZGlzcGF0Y2hFdmVudChlcnJvckV2ZW50KTtcbiAgICAgIHRoaXMuI2FwcC5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9O1xuXG4gIC8qKiBJcyBzZXQgdG8gYHRydWVgIGlmIGV2ZW50cyBjYW5ub3QgYmUgc2VudCB0byB0aGUgcmVtb3RlIGNvbm5lY3Rpb24uXG4gICAqIE90aGVyd2lzZSBpdCBpcyBzZXQgdG8gYGZhbHNlYC5cbiAgICogXG4gICAqICpOb3RlKjogVGhpcyBmbGFnIGlzIGxhemlseSBzZXQsIGFuZCBtaWdodCBub3QgcmVmbGVjdCBhIGNsb3NlZCBzdGF0ZSB1bnRpbFxuICAgKiBhbm90aGVyIGV2ZW50LCBjb21tZW50IG9yIG1lc3NhZ2UgaXMgYXR0ZW1wdGVkIHRvIGJlIHByb2Nlc3NlZC4gKi9cbiAgZ2V0IGNsb3NlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy4jY2xvc2VkO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgYXBwOiBBcHBsaWNhdGlvbixcbiAgICBzZXJ2ZXJSZXF1ZXN0OiBTZXJ2ZXJSZXF1ZXN0LFxuICAgIHsgaGVhZGVycyB9OiBTZXJ2ZXJTZW50RXZlbnRUYXJnZXRPcHRpb25zID0ge30sXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy4jYXBwID0gYXBwO1xuICAgIHRoaXMuI3NlcnZlclJlcXVlc3QgPSBzZXJ2ZXJSZXF1ZXN0O1xuICAgIHRoaXMuI3dyaXRlciA9IHRoaXMuI3NlcnZlclJlcXVlc3QudztcbiAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXIoXCJjbG9zZVwiLCAoKSA9PiB7XG4gICAgICB0aGlzLiNjbG9zZWQgPSB0cnVlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGhpcy4jc2VydmVyUmVxdWVzdC5jb25uLmNsb3NlKCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBpZiAoIShlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLkJhZFJlc291cmNlKSkge1xuICAgICAgICAgIGNvbnN0IGVycm9yRXZlbnQgPSBuZXcgRXJyb3JFdmVudChcImVycm9yXCIsIHsgZXJyb3IgfSk7XG4gICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgICAgIHRoaXMuI2FwcC5kaXNwYXRjaEV2ZW50KGVycm9yRXZlbnQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy4jcmVhZHkgPSB0aGlzLiNzZXR1cChoZWFkZXJzKTtcbiAgfVxuXG4gIC8qKiBTdG9wIHNlbmRpbmcgZXZlbnRzIHRvIHRoZSByZW1vdGUgY29ubmVjdGlvbiBhbmQgY2xvc2UgdGhlIGNvbm5lY3Rpb24uICovXG4gIGFzeW5jIGNsb3NlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLiNyZWFkeSAhPT0gdHJ1ZSkge1xuICAgICAgYXdhaXQgdGhpcy4jcmVhZHk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuI3ByZXY7XG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDbG9zZUV2ZW50KHsgY2FuY2VsYWJsZTogZmFsc2UgfSkpO1xuICB9XG5cbiAgLyoqIFNlbmQgYSBjb21tZW50IHRvIHRoZSByZW1vdGUgY29ubmVjdGlvbi4gIENvbW1lbnRzIGFyZSBub3QgZXhwb3NlZCB0byB0aGVcbiAgICogY2xpZW50IGBFdmVudFNvdXJjZWAgYnV0IGFyZSB1c2VkIGZvciBkaWFnbm9zdGljcyBhbmQgaGVscGluZyBlbnN1cmUgYVxuICAgKiBjb25uZWN0aW9uIGlzIGtlcHQgYWxpdmUuXG4gICAqIFxuICAgKiBgYGB0c1xuICAgKiBpbXBvcnQgeyBBcHBsaWNhdGlvbiB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAgICogXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKiBcbiAgICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gICAqICAgIGNvbnN0IHNzZSA9IGN0eC5nZXRTU0VUYXJnZXQoKTtcbiAgICogICAgc3NlLmRpc3BhdGNoQ29tbWVudChcInRoaXMgaXMgYSBjb21tZW50XCIpO1xuICAgKiB9KTtcbiAgICogXG4gICAqIGF3YWl0IGFwcC5saXN0ZW4oKTtcbiAgICogYGBgXG4gICAqL1xuICBkaXNwYXRjaENvbW1lbnQoY29tbWVudDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgdGhpcy4jcHJldiA9IHRoaXMuI3NlbmQoXG4gICAgICBgOiAke2NvbW1lbnQuc3BsaXQoXCJcXG5cIikuam9pbihcIlxcbjogXCIpfVxcblxcbmAsXG4gICAgICB0aGlzLiNwcmV2LFxuICAgICk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKiogRGlzcGF0Y2ggYSBtZXNzYWdlIHRvIHRoZSBjbGllbnQuICBUaGlzIG1lc3NhZ2Ugd2lsbCBjb250YWluIGBkYXRhOiBgIG9ubHlcbiAgICogYW5kIGJlIGF2YWlsYWJsZSBvbiB0aGUgY2xpZW50IGBFdmVudFNvdXJjZWAgb24gdGhlIGBvbm1lc3NhZ2VgIG9yIGFuIGV2ZW50XG4gICAqIGxpc3RlbmVyIG9mIHR5cGUgYFwibWVzc2FnZVwiYC4gKi9cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgZGlzcGF0Y2hNZXNzYWdlKGRhdGE6IGFueSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGV2ZW50ID0gbmV3IFNlcnZlclNlbnRFdmVudChcIl9fbWVzc2FnZVwiLCBkYXRhKTtcbiAgICByZXR1cm4gdGhpcy5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcbiAgfVxuXG4gIC8qKiBEaXNwYXRjaCBhIHNlcnZlciBzZW50IGV2ZW50IHRvIHRoZSBjbGllbnQuICBUaGUgZXZlbnQgYHR5cGVgIHdpbGwgYmVcbiAgICogc2VudCBhcyBgZXZlbnQ6IGAgdG8gdGhlIGNsaWVudCB3aGljaCB3aWxsIGJlIHJhaXNlZCBhcyBhIGBNZXNzYWdlRXZlbnRgXG4gICAqIG9uIHRoZSBgRXZlbnRTb3VyY2VgIGluIHRoZSBjbGllbnQuXG4gICAqIFxuICAgKiBBbnkgbG9jYWwgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSBkaXNwYXRjaGVkIHRvIGZpcnN0LCBhbmQgaWYgdGhlIGV2ZW50XG4gICAqIGlzIGNhbmNlbGxlZCwgaXQgd2lsbCBub3QgYmUgc2VudCB0byB0aGUgY2xpZW50LlxuICAgKiBcbiAgICogYGBgdHNcbiAgICogaW1wb3J0IHsgQXBwbGljYXRpb24sIFNlcnZlclNlbnRFdmVudCB9IGZyb20gXCJodHRwczovL2Rlbm8ubGFuZC94L29hay9tb2QudHNcIjtcbiAgICogXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbigpO1xuICAgKiBcbiAgICogYXBwLnVzZSgoY3R4KSA9PiB7XG4gICAqICAgIGNvbnN0IHNzZSA9IGN0eC5nZXRTU0VUYXJnZXQoKTtcbiAgICogICAgY29uc3QgZXZ0ID0gbmV3IFNlcnZlclNlbnRFdmVudChcInBpbmdcIiwgXCJoZWxsb1wiKTtcbiAgICogICAgc3NlLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICogfSk7XG4gICAqIFxuICAgKiBhd2FpdCBhcHAubGlzdGVuKCk7XG4gICAqIGBgYFxuICAgKi9cbiAgZGlzcGF0Y2hFdmVudChldmVudDogU2VydmVyU2VudEV2ZW50KTogYm9vbGVhbjtcbiAgZGlzcGF0Y2hFdmVudChldmVudDogQ2xvc2VFdmVudCB8IEVycm9yRXZlbnQpOiBib29sZWFuO1xuICBkaXNwYXRjaEV2ZW50KGV2ZW50OiBTZXJ2ZXJTZW50RXZlbnQgfCBDbG9zZUV2ZW50IHwgRXJyb3JFdmVudCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGRpc3BhdGNoZWQgPSBzdXBlci5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcbiAgICBpZiAoZGlzcGF0Y2hlZCAmJiBldmVudCBpbnN0YW5jZW9mIFNlcnZlclNlbnRFdmVudCkge1xuICAgICAgdGhpcy4jcHJldiA9IHRoaXMuI3NlbmQoU3RyaW5nKGV2ZW50KSwgdGhpcy4jcHJldik7XG4gICAgfVxuICAgIHJldHVybiBkaXNwYXRjaGVkO1xuICB9XG59XG4iXX0=