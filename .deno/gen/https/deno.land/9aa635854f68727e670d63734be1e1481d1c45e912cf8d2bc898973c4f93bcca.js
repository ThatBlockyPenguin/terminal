/*!
 * Adapted from koa-send at https://github.com/koajs/send and which is licensed
 * with the MIT license.
 */
import { createHttpError } from "./httpError.ts";
import { basename, extname, parse } from "./deps.ts";
import { decodeComponent, resolvePath } from "./util.ts";
function isHidden(path) {
    const pathArr = path.split("/");
    for (const segment of pathArr) {
        if (segment[0] === "." && segment !== "." && segment !== "..") {
            return true;
        }
        return false;
    }
}
async function exists(path) {
    try {
        return (await Deno.stat(path)).isFile;
    }
    catch {
        return false;
    }
}
export async function send({ request, response }, path, options = { root: "" }) {
    const { brotli = true, extensions, format = true, gzip = true, hidden = false, immutable = false, index, maxage = 0, root, } = options;
    const trailingSlash = path[path.length - 1] === "/";
    path = decodeComponent(path.substr(parse(path).root.length));
    if (index && trailingSlash) {
        path += index;
    }
    if (!hidden && isHidden(path)) {
        throw createHttpError(403);
    }
    path = resolvePath(root, path);
    let encodingExt = "";
    if (brotli &&
        request.acceptsEncodings("br", "identity") === "br" &&
        (await exists(`${path}.br`))) {
        path = `${path}.br`;
        response.headers.set("Content-Encoding", "br");
        response.headers.delete("Content-Length");
        encodingExt = ".br";
    }
    else if (gzip &&
        request.acceptsEncodings("gzip", "identity") === "gzip" &&
        (await exists(`${path}.gz`))) {
        path = `${path}.gz`;
        response.headers.set("Content-Encoding", "gzip");
        response.headers.delete("Content-Length");
        encodingExt = ".gz";
    }
    if (extensions && !/\.[^/]*$/.exec(path)) {
        for (let ext of extensions) {
            if (!/^\./.exec(ext)) {
                ext = `.${ext}`;
            }
            if (await exists(`${path}${ext}`)) {
                path += ext;
                break;
            }
        }
    }
    let stats;
    try {
        stats = await Deno.stat(path);
        if (stats.isDirectory) {
            if (format && index) {
                path += `/${index}`;
                stats = await Deno.stat(path);
            }
            else {
                return;
            }
        }
    }
    catch (err) {
        if (err instanceof Deno.errors.NotFound) {
            throw createHttpError(404, err.message);
        }
        throw createHttpError(500, err.message);
    }
    response.headers.set("Content-Length", String(stats.size));
    if (!response.headers.has("Last-Modified") && stats.mtime) {
        response.headers.set("Last-Modified", stats.mtime.toUTCString());
    }
    if (!response.headers.has("Cache-Control")) {
        const directives = [`max-age=${(maxage / 1000) | 0}`];
        if (immutable) {
            directives.push("immutable");
        }
        response.headers.set("Cache-Control", directives.join(","));
    }
    if (!response.type) {
        response.type = encodingExt !== ""
            ? extname(basename(path, encodingExt))
            : extname(path);
    }
    const file = await Deno.open(path, { read: true });
    response.addResource(file.rid);
    response.body = file;
    return path;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VuZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNlbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHO0FBR0gsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBTyxNQUFNLFdBQVcsQ0FBQztBQUMxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQXlDekQsU0FBUyxRQUFRLENBQUMsSUFBWTtJQUM1QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLEtBQUssTUFBTSxPQUFPLElBQUksT0FBTyxFQUFFO1FBQzdCLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxPQUFPLEtBQUssR0FBRyxJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7WUFDN0QsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sS0FBSyxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBRUQsS0FBSyxVQUFVLE1BQU0sQ0FBQyxJQUFZO0lBQ2hDLElBQUk7UUFDRixPQUFPLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0tBQ3ZDO0lBQUMsTUFBTTtRQUNOLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBTUQsTUFBTSxDQUFDLEtBQUssVUFBVSxJQUFJLENBRXhCLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBZ0IsRUFDbkMsSUFBWSxFQUNaLFVBQXVCLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtJQUVuQyxNQUFNLEVBQ0osTUFBTSxHQUFHLElBQUksRUFDYixVQUFVLEVBQ1YsTUFBTSxHQUFHLElBQUksRUFDYixJQUFJLEdBQUcsSUFBSSxFQUNYLE1BQU0sR0FBRyxLQUFLLEVBQ2Qs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RSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELFFBQVEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQy9CLFFBQVEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRXJCLE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQWRhcHRlZCBmcm9tIGtvYS1zZW5kIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9rb2Fqcy9zZW5kIGFuZCB3aGljaCBpcyBsaWNlbnNlZFxuICogd2l0aCB0aGUgTUlUIGxpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHR5cGUgeyBDb250ZXh0IH0gZnJvbSBcIi4vY29udGV4dC50c1wiO1xuaW1wb3J0IHsgY3JlYXRlSHR0cEVycm9yIH0gZnJvbSBcIi4vaHR0cEVycm9yLnRzXCI7XG5pbXBvcnQgeyBiYXNlbmFtZSwgZXh0bmFtZSwgcGFyc2UsIHNlcCB9IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IGRlY29kZUNvbXBvbmVudCwgcmVzb2x2ZVBhdGggfSBmcm9tIFwiLi91dGlsLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VuZE9wdGlvbnMge1xuICAvKiogVHJ5IHRvIHNlcnZlIHRoZSBicm90bGkgdmVyc2lvbiBvZiBhIGZpbGUgYXV0b21hdGljYWxseSB3aGVuIGJyb3RsaSBpc1xuICAgKiBzdXBwb3J0ZWQgYnkgYSBjbGllbnQgYW5kIGlmIHRoZSByZXF1ZXN0ZWQgZmlsZSB3aXRoIGAuYnJgIGV4dGVuc2lvblxuICAgKiBleGlzdHMuIChkZWZhdWx0cyB0byBgdHJ1ZWApICovXG4gIGJyb3RsaT86IGJvb2xlYW47XG5cbiAgLyoqIFRyeSB0byBtYXRjaCBleHRlbnNpb25zIGZyb20gcGFzc2VkIGFycmF5IHRvIHNlYXJjaCBmb3IgZmlsZSB3aGVuIG5vXG4gICAqIGV4dGVuc2lvbiBpcyBzdWZmaWNlZCBpbiBVUkwuIEZpcnN0IGZvdW5kIGlzIHNlcnZlZC4gKGRlZmF1bHRzIHRvXG4gICAqIGB1bmRlZmluZWRgKSAqL1xuICBleHRlbnNpb25zPzogc3RyaW5nW107XG5cbiAgLyoqIElmIGB0cnVlYCwgZm9ybWF0IHRoZSBwYXRoIHRvIHNlcnZlIHN0YXRpYyBmaWxlIHNlcnZlcnMgYW5kIG5vdCByZXF1aXJlIGFcbiAgICogdHJhaWxpbmcgc2xhc2ggZm9yIGRpcmVjdG9yaWVzLCBzbyB0aGF0IHlvdSBjYW4gZG8gYm90aCBgL2RpcmVjdG9yeWAgYW5kXG4gICAqIGAvZGlyZWN0b3J5L2AuIChkZWZhdWx0cyB0byBgdHJ1ZWApICovXG4gIGZvcm1hdD86IGJvb2xlYW47XG5cbiAgLyoqIFRyeSB0byBzZXJ2ZSB0aGUgZ3ppcHBlZCB2ZXJzaW9uIG9mIGEgZmlsZSBhdXRvbWF0aWNhbGx5IHdoZW4gZ3ppcCBpc1xuICAgKiBzdXBwb3J0ZWQgYnkgYSBjbGllbnQgYW5kIGlmIHRoZSByZXF1ZXN0ZWQgZmlsZSB3aXRoIGAuZ3pgIGV4dGVuc2lvblxuICAgKiBleGlzdHMuIChkZWZhdWx0cyB0byBgdHJ1ZWApLiAqL1xuICBnemlwPzogYm9vbGVhbjtcblxuICAvKiogQWxsb3cgdHJhbnNmZXIgb2YgaGlkZGVuIGZpbGVzLiAoZGVmYXVsdHMgdG8gYGZhbHNlYCkgKi9cbiAgaGlkZGVuPzogYm9vbGVhbjtcblxuICAvKiogVGVsbCB0aGUgYnJvd3NlciB0aGUgcmVzb3VyY2UgaXMgaW1tdXRhYmxlIGFuZCBjYW4gYmUgY2FjaGVkXG4gICAqIGluZGVmaW5pdGVseS4gKGRlZmF1bHRzIHRvIGBmYWxzZWApICovXG4gIGltbXV0YWJsZT86IGJvb2xlYW47XG5cbiAgLyoqIE5hbWUgb2YgdGhlIGluZGV4IGZpbGUgdG8gc2VydmUgYXV0b21hdGljYWxseSB3aGVuIHZpc2l0aW5nIHRoZSByb290XG4gICAqIGxvY2F0aW9uLiAoZGVmYXVsdHMgdG8gbm9uZSkgKi9cbiAgaW5kZXg/OiBzdHJpbmc7XG5cbiAgLyoqIEJyb3dzZXIgY2FjaGUgbWF4LWFnZSBpbiBtaWxsaXNlY29uZHMuIChkZWZhdWx0cyB0byBgMGApICovXG4gIG1heGFnZT86IG51bWJlcjtcblxuICAvKiogUm9vdCBkaXJlY3RvcnkgdG8gcmVzdHJpY3QgZmlsZSBhY2Nlc3MuICovXG4gIHJvb3Q6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gaXNIaWRkZW4ocGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHBhdGhBcnIgPSBwYXRoLnNwbGl0KFwiL1wiKTtcbiAgZm9yIChjb25zdCBzZWdtZW50IG9mIHBhdGhBcnIpIHtcbiAgICBpZiAoc2VnbWVudFswXSA9PT0gXCIuXCIgJiYgc2VnbWVudCAhPT0gXCIuXCIgJiYgc2VnbWVudCAhPT0gXCIuLlwiKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4aXN0cyhwYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IERlbm8uc3RhdChwYXRoKSkuaXNGaWxlO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqIEFzeW5jaHJvbm91c2x5IGZ1bGZpbGwgYSByZXNwb25zZSB3aXRoIGEgZmlsZSBmcm9tIHRoZSBsb2NhbCBmaWxlXG4gKiBzeXN0ZW0uXG4gKlxuICogUmVxdWlyZXMgRGVubyByZWFkIHBlcm1pc3Npb24gZm9yIHRoZSBgcm9vdGAgZGlyZWN0b3J5LiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmQoXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gIHsgcmVxdWVzdCwgcmVzcG9uc2UgfTogQ29udGV4dDxhbnk+LFxuICBwYXRoOiBzdHJpbmcsXG4gIG9wdGlvbnM6IFNlbmRPcHRpb25zID0geyByb290OiBcIlwiIH0sXG4pOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xuICBjb25zdCB7XG4gICAgYnJvdGxpID0gdHJ1ZSxcbiAgICBleHRlbnNpb25zLFxuICAgIGZvcm1hdCA9IHRydWUsXG4gICAgZ3ppcCA9IHRydWUsXG4gICAgaGlkZGVuID0gZmFsc2UsXG4gICAgaW1tdXRhYmxlID0gZmFsc2UsXG4gICAgaW5kZXgsXG4gICAgbWF4YWdlID0gMCxcbiAgICByb290LFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdHJhaWxpbmdTbGFzaCA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXSA9PT0gXCIvXCI7XG4gIHBhdGggPSBkZWNvZGVDb21wb25lbnQocGF0aC5zdWJzdHIocGFyc2UocGF0aCkucm9vdC5sZW5ndGgpKTtcbiAgaWYgKGluZGV4ICYmIHRyYWlsaW5nU2xhc2gpIHtcbiAgICBwYXRoICs9IGluZGV4O1xuICB9XG5cbiAgaWYgKCFoaWRkZW4gJiYgaXNIaWRkZW4ocGF0aCkpIHtcbiAgICB0aHJvdyBjcmVhdGVIdHRwRXJyb3IoNDAzKTtcbiAgfVxuXG4gIHBhdGggPSByZXNvbHZlUGF0aChyb290LCBwYXRoKTtcblxuICBsZXQgZW5jb2RpbmdFeHQgPSBcIlwiO1xuICBpZiAoXG4gICAgYnJvdGxpICYmXG4gICAgcmVxdWVzdC5hY2NlcHRzRW5jb2RpbmdzKFwiYnJcIiwgXCJpZGVudGl0eVwiKSA9PT0gXCJiclwiICYmXG4gICAgKGF3YWl0IGV4aXN0cyhgJHtwYXRofS5icmApKVxuICApIHtcbiAgICBwYXRoID0gYCR7cGF0aH0uYnJgO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ29udGVudC1FbmNvZGluZ1wiLCBcImJyXCIpO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuZGVsZXRlKFwiQ29udGVudC1MZW5ndGhcIik7XG4gICAgZW5jb2RpbmdFeHQgPSBcIi5iclwiO1xuICB9IGVsc2UgaWYgKFxuICAgIGd6aXAgJiZcbiAgICByZXF1ZXN0LmFjY2VwdHNFbmNvZGluZ3MoXCJnemlwXCIsIFwiaWRlbnRpdHlcIikgPT09IFwiZ3ppcFwiICYmXG4gICAgKGF3YWl0IGV4aXN0cyhgJHtwYXRofS5nemApKVxuICApIHtcbiAgICBwYXRoID0gYCR7cGF0aH0uZ3pgO1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiQ29udGVudC1FbmNvZGluZ1wiLCBcImd6aXBcIik7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5kZWxldGUoXCJDb250ZW50LUxlbmd0aFwiKTtcbiAgICBlbmNvZGluZ0V4dCA9IFwiLmd6XCI7XG4gIH1cblxuICBpZiAoZXh0ZW5zaW9ucyAmJiAhL1xcLlteL10qJC8uZXhlYyhwYXRoKSkge1xuICAgIGZvciAobGV0IGV4dCBvZiBleHRlbnNpb25zKSB7XG4gICAgICBpZiAoIS9eXFwuLy5leGVjKGV4dCkpIHtcbiAgICAgICAgZXh0ID0gYC4ke2V4dH1gO1xuICAgICAgfVxuICAgICAgaWYgKGF3YWl0IGV4aXN0cyhgJHtwYXRofSR7ZXh0fWApKSB7XG4gICAgICAgIHBhdGggKz0gZXh0O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsZXQgc3RhdHM6IERlbm8uRmlsZUluZm87XG4gIHRyeSB7XG4gICAgc3RhdHMgPSBhd2FpdCBEZW5vLnN0YXQocGF0aCk7XG5cbiAgICBpZiAoc3RhdHMuaXNEaXJlY3RvcnkpIHtcbiAgICAgIGlmIChmb3JtYXQgJiYgaW5kZXgpIHtcbiAgICAgICAgcGF0aCArPSBgLyR7aW5kZXh9YDtcbiAgICAgICAgc3RhdHMgPSBhd2FpdCBEZW5vLnN0YXQocGF0aCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuTm90Rm91bmQpIHtcbiAgICAgIHRocm93IGNyZWF0ZUh0dHBFcnJvcig0MDQsIGVyci5tZXNzYWdlKTtcbiAgICB9XG4gICAgdGhyb3cgY3JlYXRlSHR0cEVycm9yKDUwMCwgZXJyLm1lc3NhZ2UpO1xuICB9XG5cbiAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJDb250ZW50LUxlbmd0aFwiLCBTdHJpbmcoc3RhdHMuc2l6ZSkpO1xuICBpZiAoIXJlc3BvbnNlLmhlYWRlcnMuaGFzKFwiTGFzdC1Nb2RpZmllZFwiKSAmJiBzdGF0cy5tdGltZSkge1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiTGFzdC1Nb2RpZmllZFwiLCBzdGF0cy5tdGltZS50b1VUQ1N0cmluZygpKTtcbiAgfVxuICBpZiAoIXJlc3BvbnNlLmhlYWRlcnMuaGFzKFwiQ2FjaGUtQ29udHJvbFwiKSkge1xuICAgIGNvbnN0IGRpcmVjdGl2ZXMgPSBbYG1heC1hZ2U9JHsobWF4YWdlIC8gMTAwMCkgfCAwfWBdO1xuICAgIGlmIChpbW11dGFibGUpIHtcbiAgICAgIGRpcmVjdGl2ZXMucHVzaChcImltbXV0YWJsZVwiKTtcbiAgICB9XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoXCJDYWNoZS1Db250cm9sXCIsIGRpcmVjdGl2ZXMuam9pbihcIixcIikpO1xuICB9XG4gIGlmICghcmVzcG9uc2UudHlwZSkge1xuICAgIHJlc3BvbnNlLnR5cGUgPSBlbmNvZGluZ0V4dCAhPT0gXCJcIlxuICAgICAgPyBleHRuYW1lKGJhc2VuYW1lKHBhdGgsIGVuY29kaW5nRXh0KSlcbiAgICAgIDogZXh0bmFtZShwYXRoKTtcbiAgfVxuICBjb25zdCBmaWxlID0gYXdhaXQgRGVuby5vcGVuKHBhdGgsIHsgcmVhZDogdHJ1ZSB9KTtcbiAgcmVzcG9uc2UuYWRkUmVzb3VyY2UoZmlsZS5yaWQpO1xuICByZXNwb25zZS5ib2R5ID0gZmlsZTtcblxuICByZXR1cm4gcGF0aDtcbn1cbiJdfQ==