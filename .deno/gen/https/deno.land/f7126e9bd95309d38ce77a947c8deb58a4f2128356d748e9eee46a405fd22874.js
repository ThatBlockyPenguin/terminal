import { BufReader } from "./buf_reader.ts";
import { getFilename } from "./content_disposition.ts";
import { equals, extension } from "./deps.ts";
import { readHeaders, toParamRegExp, unquote } from "./headers.ts";
import { httpErrors } from "./httpError.ts";
import { getRandomFilename, skipLWSPChar, stripEol } from "./util.ts";
const decoder = new TextDecoder();
const encoder = new TextEncoder();
const BOUNDARY_PARAM_REGEX = toParamRegExp("boundary", "i");
const DEFAULT_BUFFER_SIZE = 1048576;
const DEFAULT_MAX_FILE_SIZE = 10485760;
const DEFAULT_MAX_SIZE = 0;
const NAME_PARAM_REGEX = toParamRegExp("name", "i");
function append(a, b) {
    const ab = new Uint8Array(a.length + b.length);
    ab.set(a, 0);
    ab.set(b, a.length);
    return ab;
}
function isEqual(a, b) {
    return equals(skipLWSPChar(a), b);
}
async function readToStartOrEnd(body, start, end) {
    let lineResult;
    while ((lineResult = await body.readLine())) {
        if (isEqual(lineResult.bytes, start)) {
            return true;
        }
        if (isEqual(lineResult.bytes, end)) {
            return false;
        }
    }
    throw new httpErrors.BadRequest("Unable to find multi-part boundary.");
}
async function* parts({ body, final, part, maxFileSize, maxSize, outPath, prefix }) {
    async function getFile(contentType) {
        const ext = extension(contentType);
        if (!ext) {
            throw new httpErrors.BadRequest(`Invalid media type for part: ${ext}`);
        }
        if (!outPath) {
            outPath = await Deno.makeTempDir();
        }
        const filename = `${outPath}/${getRandomFilename(prefix, ext)}`;
        const file = await Deno.open(filename, { write: true, createNew: true });
        return [filename, file];
    }
    while (true) {
        const headers = await readHeaders(body);
        const contentType = headers["content-type"];
        const contentDisposition = headers["content-disposition"];
        if (!contentDisposition) {
            throw new httpErrors.BadRequest("Form data part missing content-disposition header");
        }
        if (!contentDisposition.match(/^form-data;/i)) {
            throw new httpErrors.BadRequest(`Unexpected content-disposition header: "${contentDisposition}"`);
        }
        const matches = NAME_PARAM_REGEX.exec(contentDisposition);
        if (!matches) {
            throw new httpErrors.BadRequest(`Unable to determine name of form body part`);
        }
        let [, name] = matches;
        name = unquote(name);
        if (contentType) {
            const originalName = getFilename(contentDisposition);
            let byteLength = 0;
            let file;
            let filename;
            let buf;
            if (maxSize) {
                buf = new Uint8Array();
            }
            else {
                const result = await getFile(contentType);
                filename = result[0];
                file = result[1];
            }
            while (true) {
                const readResult = await body.readLine(false);
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes } = readResult;
                const strippedBytes = stripEol(bytes);
                if (isEqual(strippedBytes, part) || isEqual(strippedBytes, final)) {
                    if (file) {
                        file.close();
                    }
                    yield [
                        name,
                        {
                            content: buf,
                            contentType,
                            name,
                            filename,
                            originalName,
                        },
                    ];
                    if (isEqual(strippedBytes, final)) {
                        return;
                    }
                    break;
                }
                byteLength += bytes.byteLength;
                if (byteLength > maxFileSize) {
                    if (file) {
                        file.close();
                    }
                    throw new httpErrors.RequestEntityTooLarge(`File size exceeds limit of ${maxFileSize} bytes.`);
                }
                if (buf) {
                    if (byteLength > maxSize) {
                        const result = await getFile(contentType);
                        filename = result[0];
                        file = result[1];
                        await Deno.writeAll(file, buf);
                        buf = undefined;
                    }
                    else {
                        buf = append(buf, bytes);
                    }
                }
                if (file) {
                    await Deno.writeAll(file, bytes);
                }
            }
        }
        else {
            const lines = [];
            while (true) {
                const readResult = await body.readLine();
                if (!readResult) {
                    throw new httpErrors.BadRequest("Unexpected EOF reached");
                }
                const { bytes } = readResult;
                if (isEqual(bytes, part) || isEqual(bytes, final)) {
                    yield [name, lines.join("\n")];
                    if (isEqual(bytes, final)) {
                        return;
                    }
                    break;
                }
                lines.push(decoder.decode(bytes));
            }
        }
    }
}
export class FormDataReader {
    #body;
    #boundaryFinal;
    #boundaryPart;
    #reading = false;
    constructor(contentType, body) {
        const matches = contentType.match(BOUNDARY_PARAM_REGEX);
        if (!matches) {
            throw new httpErrors.BadRequest(`Content type "${contentType}" does not contain a valid boundary.`);
        }
        let [, boundary] = matches;
        boundary = unquote(boundary);
        this.#boundaryPart = encoder.encode(`--${boundary}`);
        this.#boundaryFinal = encoder.encode(`--${boundary}--`);
        this.#body = body;
    }
    async read(options = {}) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath, maxFileSize = DEFAULT_MAX_FILE_SIZE, maxSize = DEFAULT_MAX_SIZE, bufferSize = DEFAULT_BUFFER_SIZE, } = options;
        const body = new BufReader(this.#body, bufferSize);
        const result = { fields: {} };
        if (!(await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal))) {
            return result;
        }
        try {
            for await (const part of parts({
                body,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath,
            })) {
                const [key, value] = part;
                if (typeof value === "string") {
                    result.fields[key] = value;
                }
                else {
                    if (!result.files) {
                        result.files = [];
                    }
                    result.files.push(value);
                }
            }
        }
        catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            }
            else {
                throw err;
            }
        }
        return result;
    }
    async *stream(options = {}) {
        if (this.#reading) {
            throw new Error("Body is already being read.");
        }
        this.#reading = true;
        const { outPath, maxFileSize = DEFAULT_MAX_FILE_SIZE, maxSize = DEFAULT_MAX_SIZE, bufferSize = 32000, } = options;
        const body = new BufReader(this.#body, bufferSize);
        if (!(await readToStartOrEnd(body, this.#boundaryPart, this.#boundaryFinal))) {
            return;
        }
        try {
            for await (const part of parts({
                body,
                part: this.#boundaryPart,
                final: this.#boundaryFinal,
                maxFileSize,
                maxSize,
                outPath,
            })) {
                yield part;
            }
        }
        catch (err) {
            if (err instanceof Deno.errors.PermissionDenied) {
                console.error(err.stack ? err.stack : `${err.name}: ${err.message}`);
            }
            else {
                throw err;
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXVsdGlwYXJ0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibXVsdGlwYXJ0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxTQUFTLEVBQWtCLE1BQU0saUJBQWlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNuRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFdEUsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBRWxDLE1BQU0sb0JBQW9CLEdBQUcsYUFBYSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUM1RCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQztBQUNwQyxNQUFNLHFCQUFxQixHQUFHLFFBQVEsQ0FBQztBQUN2QyxNQUFNLGdCQUFnQixHQUFHLENBQUMsQ0FBQztBQUMzQixNQUFNLGdCQUFnQixHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7QUE0RXBELFNBQVMsTUFBTSxDQUFDLENBQWEsRUFBRSxDQUFhO0lBQzFDLE1BQU0sRUFBRSxHQUFHLElBQUksVUFBVSxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQy9DLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2IsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFD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LElBQUksQ0FBQyxjQUFjO2dCQUMxQixXQUFXO2dCQUNYLE9BQU87Z0JBQ1AsT0FBTzthQUNSLENBQUMsRUFDRjtnQkFDQSxNQUFNLElBQUksQ0FBQzthQUNaO1NBQ0Y7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLElBQUksR0FBRyxZQUFZLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQy9DLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2FBQ3RFO2lCQUFNO2dCQUNMLE1BQU0sR0FBRyxDQUFDO2FBQ1g7U0FDRjtJQUNILENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjAgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHsgQnVmUmVhZGVyLCBSZWFkTGluZVJlc3VsdCB9IGZyb20gXCIuL2J1Zl9yZWFkZXIudHNcIjtcbmltcG9ydCB7IGdldEZpbGVuYW1lIH0gZnJvbSBcIi4vY29udGVudF9kaXNwb3NpdGlvbi50c1wiO1xuaW1wb3J0IHsgZXF1YWxzLCBleHRlbnNpb24gfSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyByZWFkSGVhZGVycywgdG9QYXJhbVJlZ0V4cCwgdW5xdW90ZSB9IGZyb20gXCIuL2hlYWRlcnMudHNcIjtcbmltcG9ydCB7IGh0dHBFcnJvcnMgfSBmcm9tIFwiLi9odHRwRXJyb3IudHNcIjtcbmltcG9ydCB7IGdldFJhbmRvbUZpbGVuYW1lLCBza2lwTFdTUENoYXIsIHN0cmlwRW9sIH0gZnJvbSBcIi4vdXRpbC50c1wiO1xuXG5jb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7XG5jb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG5cbmNvbnN0IEJPVU5EQVJZX1BBUkFNX1JFR0VYID0gdG9QYXJhbVJlZ0V4cChcImJvdW5kYXJ5XCIsIFwiaVwiKTtcbmNvbnN0IERFRkFVTFRfQlVGRkVSX1NJWkUgPSAxMDQ4NTc2OyAvLyAxbWJcbmNvbnN0IERFRkFVTFRfTUFYX0ZJTEVfU0laRSA9IDEwNDg1NzYwOyAvLyAxMG1iXG5jb25zdCBERUZBVUxUX01BWF9TSVpFID0gMDsgLy8gYWxsIGZpbGVzIHdyaXR0ZW4gdG8gZGlzY1xuY29uc3QgTkFNRV9QQVJBTV9SRUdFWCA9IHRvUGFyYW1SZWdFeHAoXCJuYW1lXCIsIFwiaVwiKTtcblxuZXhwb3J0IGludGVyZmFjZSBGb3JtRGF0YUJvZHkge1xuICAvKiogQSByZWNvcmQgb2YgZm9ybSBwYXJ0cyB3aGVyZSB0aGUga2V5IHdhcyB0aGUgYG5hbWVgIG9mIHRoZSBwYXJ0IGFuZCB0aGVcbiAgICogdmFsdWUgd2FzIHRoZSB2YWx1ZSBvZiB0aGUgcGFydC4gVGhpcyByZWNvcmQgZG9lcyBub3QgaW5jbHVkZSBhbnkgZmlsZXNcbiAgICogdGhhdCB3ZXJlIHBhcnQgb2YgdGhlIGZvcm0gZGF0YS5cbiAgICogXG4gICAqICpOb3RlKjogRHVwbGljYXRlIG5hbWVzIGFyZSBub3QgaW5jbHVkZWQgaW4gdGhpcyByZWNvcmQsIGlmIHRoZXJlIGFyZVxuICAgKiBkdXBsaWNhdGVzLCB0aGUgbGFzdCB2YWx1ZSB3aWxsIGJlIHRoZSB2YWx1ZSB0aGF0IGlzIHNldCBoZXJlLiAgSWYgdGhlcmVcbiAgICogaXMgYSBwb3NzaWJpbGl0eSBvZiBkdXBsaWNhdGUgdmFsdWVzLCB1c2UgdGhlIGAuc3RyZWFtKClgIG1ldGhvZCB0b1xuICAgKiBpdGVyYXRlIG92ZXIgdGhlIHZhbHVlcy4gKi9cbiAgZmllbGRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuXG4gIC8qKiBBbiBhcnJheSBvZiBhbnkgZmlsZXMgdGhhdCB3ZXJlIHBhcnQgb2YgdGhlIGZvcm0gZGF0YS4gKi9cbiAgZmlsZXM/OiBGb3JtRGF0YUZpbGVbXTtcbn1cblxuLyoqIEEgcmVwcmVzZW50YXRpb24gb2YgYSBmaWxlIHRoYXQgaGFzIGJlZW4gcmVhZCBmcm9tIGEgZm9ybSBkYXRhIGJvZHkuICovXG5leHBvcnQgdHlwZSBGb3JtRGF0YUZpbGUgPSB7XG4gIC8qKiBXaGVuIHRoZSBmaWxlIGhhcyBub3QgYmVlbiB3cml0dGVuIG91dCB0byBkaXNjLCB0aGUgY29udGVudHMgb2YgdGhlIGZpbGVcbiAgICogYXMgYSBgVWludDhBcnJheWAuICovXG4gIGNvbnRlbnQ/OiBVaW50OEFycmF5O1xuXG4gIC8qKiBUaGUgY29udGVudCB0eXBlIG9nIHRoZSBmb3JtIGRhdGEgZmlsZS4gKi9cbiAgY29udGVudFR5cGU6IHN0cmluZztcblxuICAvKiogV2hlbiB0aGUgZmlsZSBoYXMgYmVlbiB3cml0dGVuIG91dCB0byBkaXNjLCB0aGUgZnVsbCBwYXRoIHRvIHRoZSBmaWxlLiAqL1xuICBmaWxlbmFtZT86IHN0cmluZztcblxuICAvKiogVGhlIGBuYW1lYCB0aGF0IHdhcyBhc3NpZ25lZCB0byB0aGUgZm9ybSBkYXRhIGZpbGUuICovXG4gIG5hbWU6IHN0cmluZztcblxuICAvKiogVGhlIGBmaWxlbmFtZWAgdGhhdCB3YXMgcHJvdmlkZWQgaW4gdGhlIGZvcm0gZGF0YSBmaWxlLiAqL1xuICBvcmlnaW5hbE5hbWU6IHN0cmluZztcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgRm9ybURhdGFSZWFkT3B0aW9ucyB7XG4gIC8qKiBUaGUgc2l6ZSBvZiB0aGUgYnVmZmVyIHRvIHJlYWQgZnJvbSB0aGUgcmVxdWVzdCBib2R5IGF0IGEgc2luZ2xlIHRpbWUuXG4gICAqIFRoaXMgZGVmYXVsdHMgdG8gMW1iLiAqL1xuICBidWZmZXJTaXplPzogbnVtYmVyO1xuXG4gIC8qKiBUaGUgbWF4aW11bSBmaWxlIHNpemUgdGhhdCBjYW4gYmUgaGFuZGxlZC4gIFRoaXMgZGVmYXVsdHMgdG8gMTBNQiB3aGVuXG4gICAqIG5vdCBzcGVjaWZpZWQuICBUaGlzIGlzIHRvIHRyeSB0byBhdm9pZCBET1MgYXR0YWNrcyB3aGVyZSBzb21lb25lIHdvdWxkIFxuICAgKiBjb250aW51ZSB0byB0cnkgdG8gc2VuZCBhIFwiZmlsZVwiIGNvbnRpbnVvdXNseSB1bnRpbCBhIGhvc3QgbGltaXQgd2FzXG4gICAqIHJlYWNoZWQgY3Jhc2hpbmcgdGhlIHNlcnZlciBvciB0aGUgaG9zdC4gKi9cbiAgbWF4RmlsZVNpemU/OiBudW1iZXI7XG5cbiAgLyoqIFRoZSBtYXhpbXVtIHNpemUgb2YgYSBmaWxlIHRvIGhvbGQgaW4gbWVtb3J5LCBhbmQgbm90IHdyaXRlIHRvIGRpc2suIFRoaXNcbiAgICogZGVmYXVsdHMgdG8gYDBgLCBzbyB0aGF0IGFsbCBtdWx0aXBhcnQgZm9ybSBmaWxlcyBhcmUgd3JpdHRlbiB0byBkaXNrLlxuICAgKiBXaGVuIHNldCB0byBhIHBvc2l0aXZlIGludGVnZXIsIGlmIHRoZSBmb3JtIGRhdGEgZmlsZSBpcyBzbWFsbGVyLCBpdCB3aWxsXG4gICAqIGJlIHJldGFpbmVkIGluIG1lbW9yeSBhbmQgYXZhaWxhYmxlIGluIHRoZSBgLmNvbnRlbnRgIHByb3BlcnR5IG9mIHRoZVxuICAgKiBgRm9ybURhdGFGaWxlYCBvYmplY3QuICBJZiB0aGUgZmlsZSBleGNlZWRzIHRoZSBgbWF4U2l6ZWAgaXQgd2lsbCBiZVxuICAgKiB3cml0dGVuIHRvIGRpc2sgYW5kIHRoZSBgZmlsZW5hbWVgIGZpbGUgd2lsbCBjb250YWluIHRoZSBmdWxsIHBhdGggdG8gdGhlXG4gICAqIG91dHB1dCBmaWxlLiAqL1xuICBtYXhTaXplPzogbnVtYmVyO1xuXG4gIC8qKiBXaGVuIHdyaXRpbmcgZm9ybSBkYXRhIGZpbGVzIHRvIGRpc2ssIHRoZSBvdXRwdXQgcGF0aC4gIFRoaXMgd2lsbCBkZWZhdWx0XG4gICAqIHRvIGEgdGVtcG9yYXJ5IHBhdGggZ2VuZXJhdGVkIGJ5IGBEZW5vLm1ha2VUZW1wRGlyKClgLiAqL1xuICBvdXRQYXRoPzogc3RyaW5nO1xuXG4gIC8qKiBXaGVuIGEgZm9ybSBkYXRhIGZpbGUgaXMgd3JpdHRlbiB0byBkaXNrLCBpdCB3aWxsIGJlIGdlbmVyYXRlZCB3aXRoIGFcbiAgICogcmFuZG9tIGZpbGVuYW1lIGFuZCBoYXZlIGFuIGV4dGVuc2lvbiBiYXNlZCBvZmYgdGhlIGNvbnRlbnQgdHlwZSBmb3IgdGhlXG4gICAqIGZpbGUuICBgcHJlZml4YCBjYW4gYmUgc3BlY2lmaWVkIHRob3VnaCB0byBwcmVwZW5kIHRvIHRoZSBmaWxlIG5hbWUuICovXG4gIHByZWZpeD86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFBhcnRzT3B0aW9ucyB7XG4gIGJvZHk6IEJ1ZlJlYWRlcjtcbiAgZmluYWw6IFVpbnQ4QXJyYXk7XG4gIG1heEZpbGVTaXplOiBudW1iZXI7XG4gIG1heFNpemU6IG51bWJlcjtcbiAgb3V0UGF0aD86IHN0cmluZztcbiAgcGFydDogVWludDhBcnJheTtcbiAgcHJlZml4Pzogc3RyaW5nO1xufVxuXG5mdW5jdGlvbiBhcHBlbmQoYTogVWludDhBcnJheSwgYjogVWludDhBcnJheSk6IFVpbnQ4QXJyYXkge1xuICBjb25zdCBhYiA9IG5ldyBVaW50OEFycmF5KGEubGVuZ3RoICsgYi5sZW5ndGgpO1xuICBhYi5zZXQoYSwgMCk7XG4gIGFiLnNldChiLCBhLmxlbmd0aCk7XG4gIHJldHVybiBhYjtcbn1cblxuZnVuY3Rpb24gaXNFcXVhbChhOiBVaW50OEFycmF5LCBiOiBVaW50OEFycmF5KTogYm9vbGVhbiB7XG4gIHJldHVybiBlcXVhbHMoc2tpcExXU1BDaGFyKGEpLCBiKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZFRvU3RhcnRPckVuZChcbiAgYm9keTogQnVmUmVhZGVyLFxuICBzdGFydDogVWludDhBcnJheSxcbiAgZW5kOiBVaW50OEFycmF5LFxuKTogUHJvbWlzZTxib29sZWFuPiB7XG4gIGxldCBsaW5lUmVzdWx0OiBSZWFkTGluZVJlc3VsdCB8IG51bGw7XG4gIHdoaWxlICgobGluZVJlc3VsdCA9IGF3YWl0IGJvZHkucmVhZExpbmUoKSkpIHtcbiAgICBpZiAoaXNFcXVhbChsaW5lUmVzdWx0LmJ5dGVzLCBzdGFydCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAoaXNFcXVhbChsaW5lUmVzdWx0LmJ5dGVzLCBlbmQpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgXCJVbmFibGUgdG8gZmluZCBtdWx0aS1wYXJ0IGJvdW5kYXJ5LlwiLFxuICApO1xufVxuXG4vKiogWWllbGQgdXAgaW5kaXZpZHVhbCBwYXJ0cyBieSByZWFkaW5nIHRoZSBib2R5IGFuZCBwYXJzaW5nIG91dCB0aGUgZm9yZFxuICogZGF0YSB2YWx1ZXMuICovXG5hc3luYyBmdW5jdGlvbiogcGFydHMoXG4gIHsgYm9keSwgZmluYWwsIHBhcnQsIG1heEZpbGVTaXplLCBtYXhTaXplLCBvdXRQYXRoLCBwcmVmaXggfTogUGFydHNPcHRpb25zLFxuKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZyB8IEZvcm1EYXRhRmlsZV0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZShjb250ZW50VHlwZTogc3RyaW5nKTogUHJvbWlzZTxbc3RyaW5nLCBEZW5vLkZpbGVdPiB7XG4gICAgY29uc3QgZXh0ID0gZXh0ZW5zaW9uKGNvbnRlbnRUeXBlKTtcbiAgICBpZiAoIWV4dCkge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChgSW52YWxpZCBtZWRpYSB0eXBlIGZvciBwYXJ0OiAke2V4dH1gKTtcbiAgICB9XG4gICAgaWYgKCFvdXRQYXRoKSB7XG4gICAgICBvdXRQYXRoID0gYXdhaXQgRGVuby5tYWtlVGVtcERpcigpO1xuICAgIH1cbiAgICBjb25zdCBmaWxlbmFtZSA9IGAke291dFBhdGh9LyR7Z2V0UmFuZG9tRmlsZW5hbWUocHJlZml4LCBleHQpfWA7XG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IERlbm8ub3BlbihmaWxlbmFtZSwgeyB3cml0ZTogdHJ1ZSwgY3JlYXRlTmV3OiB0cnVlIH0pO1xuICAgIHJldHVybiBbZmlsZW5hbWUsIGZpbGVdO1xuICB9XG5cbiAgd2hpbGUgKHRydWUpIHtcbiAgICBjb25zdCBoZWFkZXJzID0gYXdhaXQgcmVhZEhlYWRlcnMoYm9keSk7XG4gICAgY29uc3QgY29udGVudFR5cGUgPSBoZWFkZXJzW1wiY29udGVudC10eXBlXCJdO1xuICAgIGNvbnN0IGNvbnRlbnREaXNwb3NpdGlvbiA9IGhlYWRlcnNbXCJjb250ZW50LWRpc3Bvc2l0aW9uXCJdO1xuICAgIGlmICghY29udGVudERpc3Bvc2l0aW9uKSB7XG4gICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFxuICAgICAgICBcIkZvcm0gZGF0YSBwYXJ0IG1pc3NpbmcgY29udGVudC1kaXNwb3NpdGlvbiBoZWFkZXJcIixcbiAgICAgICk7XG4gICAgfVxuICAgIGlmICghY29udGVudERpc3Bvc2l0aW9uLm1hdGNoKC9eZm9ybS1kYXRhOy9pKSkge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICAgICAgYFVuZXhwZWN0ZWQgY29udGVudC1kaXNwb3NpdGlvbiBoZWFkZXI6IFwiJHtjb250ZW50RGlzcG9zaXRpb259XCJgLFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgbWF0Y2hlcyA9IE5BTUVfUEFSQU1fUkVHRVguZXhlYyhjb250ZW50RGlzcG9zaXRpb24pO1xuICAgIGlmICghbWF0Y2hlcykge1xuICAgICAgdGhyb3cgbmV3IGh0dHBFcnJvcnMuQmFkUmVxdWVzdChcbiAgICAgICAgYFVuYWJsZSB0byBkZXRlcm1pbmUgbmFtZSBvZiBmb3JtIGJvZHkgcGFydGAsXG4gICAgICApO1xuICAgIH1cbiAgICBsZXQgWywgbmFtZV0gPSBtYXRjaGVzO1xuICAgIG5hbWUgPSB1bnF1b3RlKG5hbWUpO1xuICAgIGlmIChjb250ZW50VHlwZSkge1xuICAgICAgY29uc3Qgb3JpZ2luYWxOYW1lID0gZ2V0RmlsZW5hbWUoY29udGVudERpc3Bvc2l0aW9uKTtcbiAgICAgIGxldCBieXRlTGVuZ3RoID0gMDtcbiAgICAgIGxldCBmaWxlOiBEZW5vLkZpbGUgfCB1bmRlZmluZWQ7XG4gICAgICBsZXQgZmlsZW5hbWU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICAgIGxldCBidWY6IFVpbnQ4QXJyYXkgfCB1bmRlZmluZWQ7XG4gICAgICBpZiAobWF4U2l6ZSkge1xuICAgICAgICBidWYgPSBuZXcgVWludDhBcnJheSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0RmlsZShjb250ZW50VHlwZSk7XG4gICAgICAgIGZpbGVuYW1lID0gcmVzdWx0WzBdO1xuICAgICAgICBmaWxlID0gcmVzdWx0WzFdO1xuICAgICAgfVxuICAgICAgd2hpbGUgKHRydWUpIHtcbiAgICAgICAgY29uc3QgcmVhZFJlc3VsdCA9IGF3YWl0IGJvZHkucmVhZExpbmUoZmFsc2UpO1xuICAgICAgICBpZiAoIXJlYWRSZXN1bHQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFwiVW5leHBlY3RlZCBFT0YgcmVhY2hlZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGJ5dGVzIH0gPSByZWFkUmVzdWx0O1xuICAgICAgICBjb25zdCBzdHJpcHBlZEJ5dGVzID0gc3RyaXBFb2woYnl0ZXMpO1xuICAgICAgICBpZiAoaXNFcXVhbChzdHJpcHBlZEJ5dGVzLCBwYXJ0KSB8fCBpc0VxdWFsKHN0cmlwcGVkQnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgICBmaWxlLmNsb3NlKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHlpZWxkIFtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIGNvbnRlbnQ6IGJ1ZixcbiAgICAgICAgICAgICAgY29udGVudFR5cGUsXG4gICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgIGZpbGVuYW1lLFxuICAgICAgICAgICAgICBvcmlnaW5hbE5hbWUsXG4gICAgICAgICAgICB9IGFzIEZvcm1EYXRhRmlsZSxcbiAgICAgICAgICBdO1xuICAgICAgICAgIGlmIChpc0VxdWFsKHN0cmlwcGVkQnl0ZXMsIGZpbmFsKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBieXRlTGVuZ3RoICs9IGJ5dGVzLmJ5dGVMZW5ndGg7XG4gICAgICAgIGlmIChieXRlTGVuZ3RoID4gbWF4RmlsZVNpemUpIHtcbiAgICAgICAgICBpZiAoZmlsZSkge1xuICAgICAgICAgICAgZmlsZS5jbG9zZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5SZXF1ZXN0RW50aXR5VG9vTGFyZ2UoXG4gICAgICAgICAgICBgRmlsZSBzaXplIGV4Y2VlZHMgbGltaXQgb2YgJHttYXhGaWxlU2l6ZX0gYnl0ZXMuYCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChidWYpIHtcbiAgICAgICAgICBpZiAoYnl0ZUxlbmd0aCA+IG1heFNpemUpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEZpbGUoY29udGVudFR5cGUpO1xuICAgICAgICAgICAgZmlsZW5hbWUgPSByZXN1bHRbMF07XG4gICAgICAgICAgICBmaWxlID0gcmVzdWx0WzFdO1xuICAgICAgICAgICAgYXdhaXQgRGVuby53cml0ZUFsbChmaWxlLCBidWYpO1xuICAgICAgICAgICAgYnVmID0gdW5kZWZpbmVkO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBidWYgPSBhcHBlbmQoYnVmLCBieXRlcyk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgICAgYXdhaXQgRGVuby53cml0ZUFsbChmaWxlLCBieXRlcyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgbGluZXM6IHN0cmluZ1tdID0gW107XG4gICAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBjb25zdCByZWFkUmVzdWx0ID0gYXdhaXQgYm9keS5yZWFkTGluZSgpO1xuICAgICAgICBpZiAoIXJlYWRSZXN1bHQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgaHR0cEVycm9ycy5CYWRSZXF1ZXN0KFwiVW5leHBlY3RlZCBFT0YgcmVhY2hlZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGJ5dGVzIH0gPSByZWFkUmVzdWx0O1xuICAgICAgICBpZiAoaXNFcXVhbChieXRlcywgcGFydCkgfHwgaXNFcXVhbChieXRlcywgZmluYWwpKSB7XG4gICAgICAgICAgeWllbGQgW25hbWUsIGxpbmVzLmpvaW4oXCJcXG5cIildO1xuICAgICAgICAgIGlmIChpc0VxdWFsKGJ5dGVzLCBmaW5hbCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgbGluZXMucHVzaChkZWNvZGVyLmRlY29kZShieXRlcykpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vKiogQSBjbGFzcyB3aGljaCBwcm92aWRlcyBhbiBpbnRlcmZhY2UgdG8gYWNjZXNzIHRoZSBmaWVsZHMgb2YgYVxuICogYG11bHRpcGFydC9mb3JtLWRhdGFgIGJvZHkuICovXG5leHBvcnQgY2xhc3MgRm9ybURhdGFSZWFkZXIge1xuICAjYm9keTogRGVuby5SZWFkZXI7XG4gICNib3VuZGFyeUZpbmFsOiBVaW50OEFycmF5O1xuICAjYm91bmRhcnlQYXJ0OiBVaW50OEFycmF5O1xuICAjcmVhZGluZyA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKGNvbnRlbnRUeXBlOiBzdHJpbmcsIGJvZHk6IERlbm8uUmVhZGVyKSB7XG4gICAgY29uc3QgbWF0Y2hlcyA9IGNvbnRlbnRUeXBlLm1hdGNoKEJPVU5EQVJZX1BBUkFNX1JFR0VYKTtcbiAgICBpZiAoIW1hdGNoZXMpIHtcbiAgICAgIHRocm93IG5ldyBodHRwRXJyb3JzLkJhZFJlcXVlc3QoXG4gICAgICAgIGBDb250ZW50IHR5cGUgXCIke2NvbnRlbnRUeXBlfVwiIGRvZXMgbm90IGNvbnRhaW4gYSB2YWxpZCBib3VuZGFyeS5gLFxuICAgICAgKTtcbiAgICB9XG4gICAgbGV0IFssIGJvdW5kYXJ5XSA9IG1hdGNoZXM7XG4gICAgYm91bmRhcnkgPSB1bnF1b3RlKGJvdW5kYXJ5KTtcbiAgICB0aGlzLiNib3VuZGFyeVBhcnQgPSBlbmNvZGVyLmVuY29kZShgLS0ke2JvdW5kYXJ5fWApO1xuICAgIHRoaXMuI2JvdW5kYXJ5RmluYWwgPSBlbmNvZGVyLmVuY29kZShgLS0ke2JvdW5kYXJ5fS0tYCk7XG4gICAgdGhpcy4jYm9keSA9IGJvZHk7XG4gIH1cblxuICAvKiogUmVhZHMgdGhlIG11bHRpcGFydCBib2R5IG9mIHRoZSByZXNwb25zZSBhbmQgcmVzb2x2ZXMgd2l0aCBhbiBvYmplY3Qgd2hpY2hcbiAgICogY29udGFpbnMgZmllbGRzIGFuZCBmaWxlcyB0aGF0IHdlcmUgcGFydCBvZiB0aGUgcmVzcG9uc2UuXG4gICAqIFxuICAgKiAqTm90ZSo6IHRoaXMgbWV0aG9kIGhhbmRsZXMgbXVsdGlwbGUgZmlsZXMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgYXR0cmlidXRlXG4gICAqIGluIHRoZSByZXF1ZXN0LCBidXQgYnkgZGVzaWduIGl0IGRvZXMgbm90IGhhbmRsZSBtdWx0aXBsZSBmaWVsZHMgdGhhdCBzaGFyZVxuICAgKiB0aGUgc2FtZSBgbmFtZWAuICBJZiB5b3UgZXhwZWN0IHRoZSByZXF1ZXN0IGJvZHkgdG8gY29udGFpbiBtdWx0aXBsZSBmb3JtXG4gICAqIGRhdGEgZmllbGRzIHdpdGggdGhlIHNhbWUgbmFtZSwgaXQgaXMgYmV0dGVyIHRvIHVzZSB0aGUgYC5zdHJlYW0oKWAgbWV0aG9kXG4gICAqIHdoaWNoIHdpbGwgaXRlcmF0ZSBvdmVyIGVhY2ggZm9ybSBkYXRhIGZpZWxkIGluZGl2aWR1YWxseS4gKi9cbiAgYXN5bmMgcmVhZChvcHRpb25zOiBGb3JtRGF0YVJlYWRPcHRpb25zID0ge30pOiBQcm9taXNlPEZvcm1EYXRhQm9keT4ge1xuICAgIGlmICh0aGlzLiNyZWFkaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCb2R5IGlzIGFscmVhZHkgYmVpbmcgcmVhZC5cIik7XG4gICAgfVxuICAgIHRoaXMuI3JlYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHtcbiAgICAgIG91dFBhdGgsXG4gICAgICBtYXhGaWxlU2l6ZSA9IERFRkFVTFRfTUFYX0ZJTEVfU0laRSxcbiAgICAgIG1heFNpemUgPSBERUZBVUxUX01BWF9TSVpFLFxuICAgICAgYnVmZmVyU2l6ZSA9IERFRkFVTFRfQlVGRkVSX1NJWkUsXG4gICAgfSA9IG9wdGlvbnM7XG4gICAgY29uc3QgYm9keSA9IG5ldyBCdWZSZWFkZXIodGhpcy4jYm9keSwgYnVmZmVyU2l6ZSk7XG4gICAgY29uc3QgcmVzdWx0OiBGb3JtRGF0YUJvZHkgPSB7IGZpZWxkczoge30gfTtcbiAgICBpZiAoXG4gICAgICAhKGF3YWl0IHJlYWRUb1N0YXJ0T3JFbmQoYm9keSwgdGhpcy4jYm91bmRhcnlQYXJ0LCB0aGlzLiNib3VuZGFyeUZpbmFsKSlcbiAgICApIHtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBmb3IgYXdhaXQgKFxuICAgICAgICBjb25zdCBwYXJ0IG9mIHBhcnRzKHtcbiAgICAgICAgICBib2R5LFxuICAgICAgICAgIHBhcnQ6IHRoaXMuI2JvdW5kYXJ5UGFydCxcbiAgICAgICAgICBmaW5hbDogdGhpcy4jYm91bmRhcnlGaW5hbCxcbiAgICAgICAgICBtYXhGaWxlU2l6ZSxcbiAgICAgICAgICBtYXhTaXplLFxuICAgICAgICAgIG91dFBhdGgsXG4gICAgICAgIH0pXG4gICAgICApIHtcbiAgICAgICAgY29uc3QgW2tleSwgdmFsdWVdID0gcGFydDtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgIHJlc3VsdC5maWVsZHNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghcmVzdWx0LmZpbGVzKSB7XG4gICAgICAgICAgICByZXN1bHQuZmlsZXMgPSBbXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzdWx0LmZpbGVzLnB1c2godmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuUGVybWlzc2lvbkRlbmllZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayA/IGVyci5zdGFjayA6IGAke2Vyci5uYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGl0ZXJhdG9yIHdoaWNoIHdpbGwgYXN5bmNocm9ub3VzbHkgeWllbGQgZWFjaCBwYXJ0IG9mIHRoZSBmb3JtXG4gICAqIGRhdGEuICBUaGUgeWllbGRlZCB2YWx1ZSBpcyBhIHR1cGxlLCB3aGVyZSB0aGUgZmlyc3QgZWxlbWVudCBpcyB0aGUgbmFtZVxuICAgKiBvZiB0aGUgcGFydCBhbmQgdGhlIHNlY29uZCBlbGVtZW50IGlzIGEgYHN0cmluZ2Agb3IgYSBgRm9ybURhdGFGaWxlYFxuICAgKiBvYmplY3QuICovXG4gIGFzeW5jICpzdHJlYW0oXG4gICAgb3B0aW9uczogRm9ybURhdGFSZWFkT3B0aW9ucyA9IHt9LFxuICApOiBBc3luY0l0ZXJhYmxlSXRlcmF0b3I8W3N0cmluZywgc3RyaW5nIHwgRm9ybURhdGFGaWxlXT4ge1xuICAgIGlmICh0aGlzLiNyZWFkaW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCb2R5IGlzIGFscmVhZHkgYmVpbmcgcmVhZC5cIik7XG4gICAgfVxuICAgIHRoaXMuI3JlYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IHtcbiAgICAgIG91dFBhdGgsXG4gICAgICBtYXhGaWxlU2l6ZSA9IERFRkFVTFRfTUFYX0ZJTEVfU0laRSxcbiAgICAgIG1heFNpemUgPSBERUZBVUxUX01BWF9TSVpFLFxuICAgICAgYnVmZmVyU2l6ZSA9IDMyMDAwLFxuICAgIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IGJvZHkgPSBuZXcgQnVmUmVhZGVyKHRoaXMuI2JvZHksIGJ1ZmZlclNpemUpO1xuICAgIGlmIChcbiAgICAgICEoYXdhaXQgcmVhZFRvU3RhcnRPckVuZChib2R5LCB0aGlzLiNib3VuZGFyeVBhcnQsIHRoaXMuI2JvdW5kYXJ5RmluYWwpKVxuICAgICkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgZm9yIGF3YWl0IChcbiAgICAgICAgY29uc3QgcGFydCBvZiBwYXJ0cyh7XG4gICAgICAgICAgYm9keSxcbiAgICAgICAgICBwYXJ0OiB0aGlzLiNib3VuZGFyeVBhcnQsXG4gICAgICAgICAgZmluYWw6IHRoaXMuI2JvdW5kYXJ5RmluYWwsXG4gICAgICAgICAgbWF4RmlsZVNpemUsXG4gICAgICAgICAgbWF4U2l6ZSxcbiAgICAgICAgICBvdXRQYXRoLFxuICAgICAgICB9KVxuICAgICAgKSB7XG4gICAgICAgIHlpZWxkIHBhcnQ7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgRGVuby5lcnJvcnMuUGVybWlzc2lvbkRlbmllZCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5zdGFjayA/IGVyci5zdGFjayA6IGAke2Vyci5uYW1lfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==