import { Cookies } from "./cookies.ts";
import { acceptable, acceptWebSocket } from "./deps.ts";
import { createHttpError } from "./httpError.ts";
import { Request } from "./request.ts";
import { Response } from "./response.ts";
import { send } from "./send.ts";
import { ServerSentEventTarget, } from "./server_sent_event.ts";
export class Context {
    #socket;
    #sse;
    app;
    cookies;
    get isUpgradable() {
        return acceptable(this.request);
    }
    respond;
    request;
    response;
    get socket() {
        return this.#socket;
    }
    state;
    constructor(app, serverRequest, secure = false) {
        this.app = app;
        this.state = app.state;
        this.request = new Request(serverRequest, app.proxy, secure);
        this.respond = true;
        this.response = new Response(this.request);
        this.cookies = new Cookies(this.request, this.response, {
            keys: this.app.keys,
            secure: this.request.secure,
        });
    }
    assert(condition, errorStatus = 500, message, props) {
        if (condition) {
            return;
        }
        const err = createHttpError(errorStatus, message);
        if (props) {
            Object.assign(err, props);
        }
        throw err;
    }
    send(options) {
        const { path = this.request.url.pathname, ...sendOptions } = options;
        return send(this, path, sendOptions);
    }
    sendEvents(options) {
        if (this.#sse) {
            return this.#sse;
        }
        this.respond = false;
        return this.#sse = new ServerSentEventTarget(this.app, this.request.serverRequest, options);
    }
    throw(errorStatus, message, props) {
        const err = createHttpError(errorStatus, message);
        if (props) {
            Object.assign(err, props);
        }
        throw err;
    }
    async upgrade() {
        if (this.#socket) {
            return this.#socket;
        }
        const { conn, r: bufReader, w: bufWriter, headers } = this.request.serverRequest;
        this.#socket = await acceptWebSocket({ conn, bufReader, bufWriter, headers });
        this.respond = false;
        return this.#socket;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBR0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBYSxNQUFNLFdBQVcsQ0FBQztBQUNuRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN2QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxJQUFJLEVBQWUsTUFBTSxXQUFXLENBQUM7QUFDOUMsT0FBTyxFQUNMLHFCQUFxQixHQUV0QixNQUFNLHdCQUF3QixDQUFDO0FBYWhDLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLE9BQU8sQ0FBYTtJQUNwQixJQUFJLENBQXlCO0lBRzdCLEdBQUcsQ0FBcUI7SUFJeEIsT0FBTyxDQUFVO0lBS2pCLElBQUksWUFBWTtRQUNkLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBVUQsT0FBTyxDQUFVO0lBR2pCLE9BQU8sQ0FBVTtJQUlqQixRQUFRLENBQVc7SUFJbkIsSUFBSSxNQUFNO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFnQkQsS0FBSyxDQUFJO0lBRVQsWUFDRSxHQUFtQixFQUNuQixhQUE0QixFQUM1QixNQUFNLEdBQUcsS0FBSztRQUVkLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDdEQsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBNEI7WUFDM0MsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTtTQUM1QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBTUQsTUFBTSxDQUVKLFNBQWMsRUFDZCxjQUEyQixHQUFHLEVBQzlCLE9BQWdCLEVBQ2hCLEtBQStCO1FBRS9CLElBQUksU0FBUyxFQUFFO1lBQ2IsT0FBTztTQUNSO1FBQ0QsTUFBTSxHQUFHLEdBQUcsZUFBZSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNsRCxJQUFJLEtBQUssRUFBRTtZQUNULE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNCO1FBQ0QsTUFBTSxHQUFHLENBQUM7SUFDWixDQUFDO0lBU0QsSUFBSSxDQUFDLE9BQTJCO1FBQzlCLE1BQU0sRUFBRSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEdBQUcsV0FBVyxFQUFFLEdBQUcsT0FBTyxDQUFDO1FBQ3JFLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQVFELFVBQVUsQ0FBQyxPQUFzQztRQUMvQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDYixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDbEI7UUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixPQUFPLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxxQkFBcUIsQ0FDMUMsSUFBSSxDQUFDLEdBQUcsRUFDUixJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFDMUIsT0FBTyxDQUNSLENBQUM7SUFDSixDQUFDO0lBT0QsS0FBSyxDQUNILFdBQXdCLEVBQ3hCLE9BQWdCLEVBQ2hCLEtBQStCO1FBRS9CLE1BQU0sR0FBRyxHQUFHLGVBQWUsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDbEQsSUFBSSxLQUFLLEVBQUU7WUFDVCxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzQjtRQUNELE1BQU0sR0FBRyxDQUFDO0lBQ1osQ0FBQztJQUlELEtBQUssQ0FBQyxPQUFPO1FBQ1gsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQztTQUNyQjtRQUNELE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxHQUNqRCxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUM3QixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sZUFBZSxDQUNsQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUN4QyxDQUFDO1FBQ0YsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjAgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHR5cGUgeyBBcHBsaWNhdGlvbiwgU3RhdGUgfSBmcm9tIFwiLi9hcHBsaWNhdGlvbi50c1wiO1xuaW1wb3J0IHsgQ29va2llcyB9IGZyb20gXCIuL2Nvb2tpZXMudHNcIjtcbmltcG9ydCB7IGFjY2VwdGFibGUsIGFjY2VwdFdlYlNvY2tldCwgV2ViU29ja2V0IH0gZnJvbSBcIi4vZGVwcy50c1wiO1xuaW1wb3J0IHsgY3JlYXRlSHR0cEVycm9yIH0gZnJvbSBcIi4vaHR0cEVycm9yLnRzXCI7XG5pbXBvcnQgdHlwZSB7IEtleVN0YWNrIH0gZnJvbSBcIi4va2V5U3RhY2sudHNcIjtcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tIFwiLi9yZXF1ZXN0LnRzXCI7XG5pbXBvcnQgeyBSZXNwb25zZSB9IGZyb20gXCIuL3Jlc3BvbnNlLnRzXCI7XG5pbXBvcnQgeyBzZW5kLCBTZW5kT3B0aW9ucyB9IGZyb20gXCIuL3NlbmQudHNcIjtcbmltcG9ydCB7XG4gIFNlcnZlclNlbnRFdmVudFRhcmdldCxcbiAgU2VydmVyU2VudEV2ZW50VGFyZ2V0T3B0aW9ucyxcbn0gZnJvbSBcIi4vc2VydmVyX3NlbnRfZXZlbnQudHNcIjtcbmltcG9ydCB0eXBlIHsgRXJyb3JTdGF0dXMsIFNlcnZlclJlcXVlc3QgfSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29udGV4dFNlbmRPcHRpb25zIGV4dGVuZHMgU2VuZE9wdGlvbnMge1xuICAvKiogVGhlIGZpbGVuYW1lIHRvIHNlbmQsIHdoaWNoIHdpbGwgYmUgcmVzb2x2ZWQgYmFzZWQgb24gdGhlIG90aGVyIG9wdGlvbnMuXG4gICAqIElmIHRoaXMgcHJvcGVydHkgaXMgb21pdHRlZCwgdGhlIGN1cnJlbnQgY29udGV4dCdzIGAucmVxdWVzdC51cmwucGF0aG5hbWVgXG4gICAqIHdpbGwgYmUgdXNlZC4gKi9cbiAgcGF0aD86IHN0cmluZztcbn1cblxuLyoqIFByb3ZpZGVzIGNvbnRleHQgYWJvdXQgdGhlIGN1cnJlbnQgcmVxdWVzdCBhbmQgcmVzcG9uc2UgdG8gbWlkZGxld2FyZVxuICogZnVuY3Rpb25zLiAqL1xuLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbmV4cG9ydCBjbGFzcyBDb250ZXh0PFMgZXh0ZW5kcyBTdGF0ZSA9IFJlY29yZDxzdHJpbmcsIGFueT4+IHtcbiAgI3NvY2tldD86IFdlYlNvY2tldDtcbiAgI3NzZT86IFNlcnZlclNlbnRFdmVudFRhcmdldDtcblxuICAvKiogQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgYXBwbGljYXRpb24uICovXG4gIGFwcDogQXBwbGljYXRpb248U3RhdGU+O1xuXG4gIC8qKiBBbiBvYmplY3Qgd2hpY2ggYWxsb3dzIGFjY2VzcyB0byBjb29raWVzLCBtZWRpYXRpbmcgYm90aCB0aGUgcmVxdWVzdCBhbmRcbiAgICogcmVzcG9uc2UuICovXG4gIGNvb2tpZXM6IENvb2tpZXM7XG5cbiAgLyoqIElzIGB0cnVlYCBpZiB0aGUgY3VycmVudCBjb25uZWN0aW9uIGlzIHVwZ3JhZGVhYmxlIHRvIGEgd2ViIHNvY2tldC5cbiAgICogT3RoZXJ3aXNlIHRoZSB2YWx1ZSBpcyBgZmFsc2VgLiAgVXNlIGAudXBncmFkZSgpYCB0byB1cGdyYWRlIHRoZSBjb25uZWN0aW9uXG4gICAqIGFuZCByZXR1cm4gdGhlIHdlYiBzb2NrZXQuICovXG4gIGdldCBpc1VwZ3JhZGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGFjY2VwdGFibGUodGhpcy5yZXF1ZXN0KTtcbiAgfVxuXG4gIC8qKiBEZXRlcm1pbmVzIGlmIHRoZSByZXF1ZXN0IHNob3VsZCBiZSByZXNwb25kZWQgdG8uICBJZiBgZmFsc2VgIHdoZW4gdGhlXG4gICAqIG1pZGRsZXdhcmUgY29tcGxldGVzIHByb2Nlc3NpbmcsIHRoZSByZXNwb25zZSB3aWxsIG5vdCBiZSBzZW50IGJhY2sgdG8gdGhlXG4gICAqIHJlcXVlc3Rvci4gIFR5cGljYWxseSB0aGlzIGlzIHVzZWQgaWYgdGhlIG1pZGRsZXdhcmUgd2lsbCB0YWtlIG92ZXIgbG93XG4gICAqIGxldmVsIHByb2Nlc3Npbmcgb2YgcmVxdWVzdHMgYW5kIHJlc3BvbnNlcywgZm9yIGV4YW1wbGUgaWYgdXNpbmcgd2ViXG4gICAqIHNvY2tldHMuICBUaGlzIGF1dG9tYXRpY2FsbHkgZ2V0cyBzZXQgdG8gYGZhbHNlYCB3aGVuIHRoZSBjb250ZXh0IGlzXG4gICAqIHVwZ3JhZGVkIHRvIGEgd2ViIHNvY2tldCB2aWEgdGhlIGAudXBncmFkZSgpYCBtZXRob2QuXG4gICAqIFxuICAgKiBUaGUgZGVmYXVsdCBpcyBgdHJ1ZWAuICovXG4gIHJlc3BvbmQ6IGJvb2xlYW47XG5cbiAgLyoqIEFuIG9iamVjdCB3aGljaCBjb250YWlucyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCByZXF1ZXN0LiAqL1xuICByZXF1ZXN0OiBSZXF1ZXN0O1xuXG4gIC8qKiBBbiBvYmplY3Qgd2hpY2ggY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlc3BvbnNlIHRoYXQgd2lsbCBiZSBzZW50XG4gICAqIHdoZW4gdGhlIG1pZGRsZXdhcmUgZmluaXNoZXMgcHJvY2Vzc2luZy4gKi9cbiAgcmVzcG9uc2U6IFJlc3BvbnNlO1xuXG4gIC8qKiBJZiB0aGUgdGhlIGN1cnJlbnQgY29udGV4dCBoYXMgYmVlbiB1cGdyYWRlZCwgdGhlbiB0aGlzIHdpbGwgYmUgc2V0IHRvXG4gICAqIHdpdGggdGhlIHdlYiBzb2NrZXQsIG90aGVyd2lzZSBpdCBpcyBgdW5kZWZpbmVkYC4gKi9cbiAgZ2V0IHNvY2tldCgpOiBXZWJTb2NrZXQgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNzb2NrZXQ7XG4gIH1cblxuICAvKiogVGhlIG9iamVjdCB0byBwYXNzIHN0YXRlIHRvIGZyb250LWVuZCB2aWV3cy4gIFRoaXMgY2FuIGJlIHR5cGVkIGJ5XG4gICAqIHN1cHBseWluZyB0aGUgZ2VuZXJpYyBzdGF0ZSBhcmd1bWVudCB3aGVuIGNyZWF0aW5nIGEgbmV3IGFwcC4gIEZvclxuICAgKiBleGFtcGxlOlxuICAgKlxuICAgKiBgYGB0c1xuICAgKiBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb248eyBmb286IHN0cmluZyB9PigpO1xuICAgKiBgYGBcbiAgICogXG4gICAqIE9yIGNhbiBiZSBjb250ZXh0dWFsbHkgaW5mZXJyZWQgYmFzZWQgb24gc2V0dGluZyBhbiBpbml0aWFsIHN0YXRlIG9iamVjdDpcbiAgICogXG4gICAqIGBgYHRzXG4gICAqIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbih7IHN0YXRlOiB7IGZvbzogXCJiYXJcIiB9IH0pO1xuICAgKiBgYGBcbiAgICovXG4gIHN0YXRlOiBTO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwcDogQXBwbGljYXRpb248Uz4sXG4gICAgc2VydmVyUmVxdWVzdDogU2VydmVyUmVxdWVzdCxcbiAgICBzZWN1cmUgPSBmYWxzZSxcbiAgKSB7XG4gICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgdGhpcy5zdGF0ZSA9IGFwcC5zdGF0ZTtcbiAgICB0aGlzLnJlcXVlc3QgPSBuZXcgUmVxdWVzdChzZXJ2ZXJSZXF1ZXN0LCBhcHAucHJveHksIHNlY3VyZSk7XG4gICAgdGhpcy5yZXNwb25kID0gdHJ1ZTtcbiAgICB0aGlzLnJlc3BvbnNlID0gbmV3IFJlc3BvbnNlKHRoaXMucmVxdWVzdCk7XG4gICAgdGhpcy5jb29raWVzID0gbmV3IENvb2tpZXModGhpcy5yZXF1ZXN0LCB0aGlzLnJlc3BvbnNlLCB7XG4gICAgICBrZXlzOiB0aGlzLmFwcC5rZXlzIGFzIEtleVN0YWNrIHwgdW5kZWZpbmVkLFxuICAgICAgc2VjdXJlOiB0aGlzLnJlcXVlc3Quc2VjdXJlLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqIEFzc2VydHMgdGhlIGNvbmRpdGlvbiBhbmQgaWYgdGhlIGNvbmRpdGlvbiBmYWlscywgY3JlYXRlcyBhbiBIVFRQIGVycm9yXG4gICAqIHdpdGggdGhlIHByb3ZpZGVkIHN0YXR1cyAod2hpY2ggZGVmYXVsdHMgdG8gYDUwMGApLiAgVGhlIGVycm9yIHN0YXR1cyBieSBcbiAgICogZGVmYXVsdCB3aWxsIGJlIHNldCBvbiB0aGUgYC5yZXNwb25zZS5zdGF0dXNgLlxuICAgKi9cbiAgYXNzZXJ0KFxuICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICAgY29uZGl0aW9uOiBhbnksXG4gICAgZXJyb3JTdGF0dXM6IEVycm9yU3RhdHVzID0gNTAwLFxuICAgIG1lc3NhZ2U/OiBzdHJpbmcsXG4gICAgcHJvcHM/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgKTogYXNzZXJ0cyBjb25kaXRpb24ge1xuICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZXJyID0gY3JlYXRlSHR0cEVycm9yKGVycm9yU3RhdHVzLCBtZXNzYWdlKTtcbiAgICBpZiAocHJvcHMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oZXJyLCBwcm9wcyk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxuXG4gIC8qKiBBc3luY2hyb25vdXNseSBmdWxmaWxsIGEgcmVzcG9uc2Ugd2l0aCBhIGZpbGUgZnJvbSB0aGUgbG9jYWwgZmlsZVxuICAgKiBzeXN0ZW0uXG4gICAqIFxuICAgKiBJZiB0aGUgYG9wdGlvbnMucGF0aGAgaXMgbm90IHN1cHBsaWVkLCB0aGUgZmlsZSB0byBiZSBzZW50IHdpbGwgZGVmYXVsdFxuICAgKiB0byB0aGlzIGAucmVxdWVzdC51cmwucGF0aG5hbWVgLlxuICAgKiBcbiAgICogUmVxdWlyZXMgRGVubyByZWFkIHBlcm1pc3Npb24uICovXG4gIHNlbmQob3B0aW9uczogQ29udGV4dFNlbmRPcHRpb25zKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCB7IHBhdGggPSB0aGlzLnJlcXVlc3QudXJsLnBhdGhuYW1lLCAuLi5zZW5kT3B0aW9ucyB9ID0gb3B0aW9ucztcbiAgICByZXR1cm4gc2VuZCh0aGlzLCBwYXRoLCBzZW5kT3B0aW9ucyk7XG4gIH1cblxuICAvKiogQ29udmVydCB0aGUgY29ubmVjdGlvbiB0byBzdHJlYW0gZXZlbnRzLCByZXR1cm5pbmcgYW4gZXZlbnQgdGFyZ2V0IGZvclxuICAgKiBzZW5kaW5nIHNlcnZlciBzZW50IGV2ZW50cy4gIEV2ZW50cyBkaXNwYXRjaGVkIG9uIHRoZSByZXR1cm5lZCB0YXJnZXQgd2lsbFxuICAgKiBiZSBzZW50IHRvIHRoZSBjbGllbnQgYW5kIGJlIGF2YWlsYWJsZSBpbiB0aGUgY2xpZW50J3MgYEV2ZW50U291cmNlYCB0aGF0XG4gICAqIGluaXRpYXRlZCB0aGUgY29ubmVjdGlvbi5cbiAgICogXG4gICAqIFRoaXMgd2lsbCBzZXQgYC5yZXNwb25kYCB0byBgZmFsc2VgLiAqL1xuICBzZW5kRXZlbnRzKG9wdGlvbnM/OiBTZXJ2ZXJTZW50RXZlbnRUYXJnZXRPcHRpb25zKTogU2VydmVyU2VudEV2ZW50VGFyZ2V0IHtcbiAgICBpZiAodGhpcy4jc3NlKSB7XG4gICAgICByZXR1cm4gdGhpcy4jc3NlO1xuICAgIH1cbiAgICB0aGlzLnJlc3BvbmQgPSBmYWxzZTtcbiAgICByZXR1cm4gdGhpcy4jc3NlID0gbmV3IFNlcnZlclNlbnRFdmVudFRhcmdldChcbiAgICAgIHRoaXMuYXBwLFxuICAgICAgdGhpcy5yZXF1ZXN0LnNlcnZlclJlcXVlc3QsXG4gICAgICBvcHRpb25zLFxuICAgICk7XG4gIH1cblxuICAvKiogQ3JlYXRlIGFuZCB0aHJvdyBhbiBIVFRQIEVycm9yLCB3aGljaCBjYW4gYmUgdXNlZCB0byBwYXNzIHN0YXR1c1xuICAgKiBpbmZvcm1hdGlvbiB3aGljaCBjYW4gYmUgY2F1Z2h0IGJ5IG90aGVyIG1pZGRsZXdhcmUgdG8gc2VuZCBtb3JlXG4gICAqIG1lYW5pbmdmdWwgZXJyb3IgbWVzc2FnZXMgYmFjayB0byB0aGUgY2xpZW50LiAgVGhlIHBhc3NlZCBlcnJvciBzdGF0dXMgd2lsbFxuICAgKiBiZSBzZXQgb24gdGhlIGAucmVzcG9uc2Uuc3RhdHVzYCBieSBkZWZhdWx0IGFzIHdlbGwuXG4gICAqL1xuICB0aHJvdyhcbiAgICBlcnJvclN0YXR1czogRXJyb3JTdGF0dXMsXG4gICAgbWVzc2FnZT86IHN0cmluZyxcbiAgICBwcm9wcz86IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICApOiBuZXZlciB7XG4gICAgY29uc3QgZXJyID0gY3JlYXRlSHR0cEVycm9yKGVycm9yU3RhdHVzLCBtZXNzYWdlKTtcbiAgICBpZiAocHJvcHMpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24oZXJyLCBwcm9wcyk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxuXG4gIC8qKiBUYWtlIHRoZSBjdXJyZW50IHJlcXVlc3QgYW5kIHVwZ3JhZGUgaXQgdG8gYSB3ZWIgc29ja2V0LCByZXNvbHZpbmcgd2l0aFxuICAgKiB0aGUgd2ViIHNvY2tldCBvYmplY3QuIFRoaXMgd2lsbCBzZXQgYC5yZXNwb25kYCB0byBgZmFsc2VgLiAqL1xuICBhc3luYyB1cGdyYWRlKCk6IFByb21pc2U8V2ViU29ja2V0PiB7XG4gICAgaWYgKHRoaXMuI3NvY2tldCkge1xuICAgICAgcmV0dXJuIHRoaXMuI3NvY2tldDtcbiAgICB9XG4gICAgY29uc3QgeyBjb25uLCByOiBidWZSZWFkZXIsIHc6IGJ1ZldyaXRlciwgaGVhZGVycyB9ID1cbiAgICAgIHRoaXMucmVxdWVzdC5zZXJ2ZXJSZXF1ZXN0O1xuICAgIHRoaXMuI3NvY2tldCA9IGF3YWl0IGFjY2VwdFdlYlNvY2tldChcbiAgICAgIHsgY29ubiwgYnVmUmVhZGVyLCBidWZXcml0ZXIsIGhlYWRlcnMgfSxcbiAgICApO1xuICAgIHRoaXMucmVzcG9uZCA9IGZhbHNlO1xuICAgIHJldHVybiB0aGlzLiNzb2NrZXQ7XG4gIH1cbn1cbiJdfQ==