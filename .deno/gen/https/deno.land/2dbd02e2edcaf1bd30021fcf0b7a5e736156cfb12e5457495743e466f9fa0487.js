import { Context } from "./context.ts";
import { serve as defaultServe, serveTLS as defaultServeTls, STATUS_TEXT, } from "./deps.ts";
import { KeyStack } from "./keyStack.ts";
import { compose } from "./middleware.ts";
function isOptionsTls(options) {
    return options.secure === true;
}
const ADDR_REGEXP = /^\[?([^\]]*)\]?:([0-9]{1,5})$/;
export class ApplicationErrorEvent extends ErrorEvent {
    context;
    constructor(eventInitDict) {
        super("error", eventInitDict);
        this.context = eventInitDict.context;
    }
}
export class ApplicationListenEvent extends Event {
    hostname;
    port;
    secure;
    constructor(eventInitDict) {
        super("listen", eventInitDict);
        this.hostname = eventInitDict.hostname;
        this.port = eventInitDict.port;
        this.secure = eventInitDict.secure;
    }
}
export class Application extends EventTarget {
    #composedMiddleware;
    #keys;
    #middleware = [];
    #serve;
    #serveTls;
    get keys() {
        return this.#keys;
    }
    set keys(keys) {
        if (!keys) {
            this.#keys = undefined;
            return;
        }
        else if (Array.isArray(keys)) {
            this.#keys = new KeyStack(keys);
        }
        else {
            this.#keys = keys;
        }
    }
    proxy;
    state;
    constructor(options = {}) {
        super();
        const { state, keys, proxy, serve = defaultServe, serveTls = defaultServeTls, } = options;
        this.proxy = proxy ?? false;
        this.keys = keys;
        this.state = state ?? {};
        this.#serve = serve;
        this.#serveTls = serveTls;
    }
    #getComposed = () => {
        if (!this.#composedMiddleware) {
            this.#composedMiddleware = compose(this.#middleware);
        }
        return this.#composedMiddleware;
    };
    #handleError = (context, error) => {
        if (!(error instanceof Error)) {
            error = new Error(`non-error thrown: ${JSON.stringify(error)}`);
        }
        const { message } = error;
        this.dispatchEvent(new ApplicationErrorEvent({ context, message, error }));
        if (!context.response.writable) {
            return;
        }
        for (const key of context.response.headers.keys()) {
            context.response.headers.delete(key);
        }
        if (error.headers && error.headers instanceof Headers) {
            for (const [key, value] of error.headers) {
                context.response.headers.set(key, value);
            }
        }
        context.response.type = "text";
        const status = context.response.status =
            error instanceof Deno.errors.NotFound
                ? 404
                : error.status && typeof error.status === "number"
                    ? error.status
                    : 500;
        context.response.body = error.expose
            ? error.message
            : STATUS_TEXT.get(status);
    };
    #handleRequest = async (request, secure, state) => {
        const context = new Context(this, request, secure);
        let resolve;
        const handlingPromise = new Promise((res) => resolve = res);
        state.handling.add(handlingPromise);
        if (!state.closing && !state.closed) {
            try {
                await this.#getComposed()(context);
            }
            catch (err) {
                this.#handleError(context, err);
            }
        }
        if (context.respond === false) {
            context.response.destroy();
            resolve();
            state.handling.delete(handlingPromise);
            return;
        }
        try {
            await request.respond(await context.response.toServerResponse());
            if (state.closing) {
                state.server.close();
                state.closed = true;
            }
        }
        catch (err) {
            this.#handleError(context, err);
        }
        finally {
            context.response.destroy();
            resolve();
            state.handling.delete(handlingPromise);
        }
    };
    addEventListener(type, listener, options) {
        super.addEventListener(type, listener, options);
    }
    handle = async (request, secure = false) => {
        if (!this.#middleware.length) {
            throw new TypeError("There is no middleware to process requests.");
        }
        const context = new Context(this, request, secure);
        try {
            await this.#getComposed()(context);
        }
        catch (err) {
            this.#handleError(context, err);
        }
        if (context.respond === false) {
            context.response.destroy();
            return;
        }
        try {
            const response = await context.response.toServerResponse();
            context.response.destroy();
            return response;
        }
        catch (err) {
            this.#handleError(context, err);
            throw err;
        }
    };
    async listen(options) {
        if (!this.#middleware.length) {
            throw new TypeError("There is no middleware to process requests.");
        }
        if (typeof options === "string") {
            const match = ADDR_REGEXP.exec(options);
            if (!match) {
                throw TypeError(`Invalid address passed: "${options}"`);
            }
            const [, hostname, portStr] = match;
            options = { hostname, port: parseInt(portStr, 10) };
        }
        const server = isOptionsTls(options)
            ? this.#serveTls(options)
            : this.#serve(options);
        const { signal } = options;
        const state = {
            closed: false,
            closing: false,
            handling: new Set(),
            server,
        };
        if (signal) {
            signal.addEventListener("abort", () => {
                if (!state.handling.size) {
                    server.close();
                    state.closed = true;
                }
                state.closing = true;
            });
        }
        const { hostname, port, secure = false } = options;
        this.dispatchEvent(new ApplicationListenEvent({ hostname, port, secure }));
        try {
            for await (const request of server) {
                this.#handleRequest(request, secure, state);
            }
            await Promise.all(state.handling);
        }
        catch (error) {
            const message = error instanceof Error
                ? error.message
                : "Application Error";
            this.dispatchEvent(new ApplicationErrorEvent({ message, error }));
        }
    }
    use(...middleware) {
        this.#middleware.push(...middleware);
        this.#composedMiddleware = undefined;
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBsaWNhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3ZDLE9BQU8sRUFDTCxLQUFLLElBQUksWUFBWSxFQUNyQixRQUFRLElBQUksZUFBZSxFQUUzQixXQUFXLEdBQ1osTUFBTSxXQUFXLENBQUM7QUFDbkIsT0FBTyxFQUFPLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5QyxPQUFPLEVBQUUsT0FBTyxFQUFjLE1BQU0saUJBQWlCLENBQUM7QUEyQnRELFNBQVMsWUFBWSxDQUFDLE9BQXNCO0lBQzFDLE9BQU8sT0FBTyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUM7QUFDakMsQ0FBQztBQXVFRCxNQUFNLFdBQVcsR0FBRywrQkFBK0IsQ0FBQztBQUVwRCxNQUFNLE9BQU8scUJBQXVDLFNBQVEsVUFBVTtJQUNwRSxPQUFPLENBQWM7SUFFckIsWUFBWSxhQUEyQztRQUNyRCxLQUFLLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxDQUFDLE9BQU8sQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUFFRCxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsS0FBSztJQUMvQyxRQUFRLENBQVU7SUFDbEIsSUFBSSxDQUFTO0lBQ2IsTUFBTSxDQUFVO0lBRWhCLFlBQVksYUFBeUM7UUFDbkQsS0FBSyxDQUFDLFFBQVEsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUM7UUFDdkMsSUFBSSxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO1FBQy9CLElBQUksQ0FBQyxNQUFNLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQztJQUNyQyxDQUFDO0NBQ0Y7QUFTRCxNQUFNLE9BQU8s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QUM7U0FDbkM7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE1BQU0sT0FBTyxHQUFHLEtBQUssWUFBWSxLQUFLO2dCQUNwQyxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU87Z0JBQ2YsQ0FBQyxDQUFDLG1CQUFtQixDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLENBQ2hCLElBQUkscUJBQXFCLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FDOUMsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQXdCRCxHQUFHLENBQ0QsR0FBRyxVQUF1QztRQUUxQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxTQUFTLENBQUM7UUFFckMsT0FBTyxJQUF3QixDQUFDO0lBQ2xDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjAgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL2NvbnRleHQudHNcIjtcbmltcG9ydCB7XG4gIHNlcnZlIGFzIGRlZmF1bHRTZXJ2ZSxcbiAgc2VydmVUTFMgYXMgZGVmYXVsdFNlcnZlVGxzLFxuICBTdGF0dXMsXG4gIFNUQVRVU19URVhULFxufSBmcm9tIFwiLi9kZXBzLnRzXCI7XG5pbXBvcnQgeyBLZXksIEtleVN0YWNrIH0gZnJvbSBcIi4va2V5U3RhY2sudHNcIjtcbmltcG9ydCB7IGNvbXBvc2UsIE1pZGRsZXdhcmUgfSBmcm9tIFwiLi9taWRkbGV3YXJlLnRzXCI7XG5pbXBvcnQgdHlwZSB7XG4gIFNlcnZlLFxuICBTZXJ2ZXIsXG4gIFNlcnZlclJlcXVlc3QsXG4gIFNlcnZlclJlc3BvbnNlLFxuICBTZXJ2ZVRscyxcbn0gZnJvbSBcIi4vdHlwZXMuZC50c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIExpc3Rlbk9wdGlvbnNCYXNlIHtcbiAgaG9zdG5hbWU/OiBzdHJpbmc7XG4gIHBvcnQ6IG51bWJlcjtcbiAgc2VjdXJlPzogZmFsc2U7XG4gIHNpZ25hbD86IEFib3J0U2lnbmFsO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIExpc3Rlbk9wdGlvbnNUbHMge1xuICBjZXJ0RmlsZTogc3RyaW5nO1xuICBob3N0bmFtZT86IHN0cmluZztcbiAga2V5RmlsZTogc3RyaW5nO1xuICBwb3J0OiBudW1iZXI7XG4gIHNlY3VyZTogdHJ1ZTtcbiAgc2lnbmFsPzogQWJvcnRTaWduYWw7XG59XG5cbmV4cG9ydCB0eXBlIExpc3Rlbk9wdGlvbnMgPSBMaXN0ZW5PcHRpb25zVGxzIHwgTGlzdGVuT3B0aW9uc0Jhc2U7XG5cbmZ1bmN0aW9uIGlzT3B0aW9uc1RscyhvcHRpb25zOiBMaXN0ZW5PcHRpb25zKTogb3B0aW9ucyBpcyBMaXN0ZW5PcHRpb25zVGxzIHtcbiAgcmV0dXJuIG9wdGlvbnMuc2VjdXJlID09PSB0cnVlO1xufVxuXG5pbnRlcmZhY2UgQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXI8Uz4ge1xuICAoZXZ0OiBBcHBsaWNhdGlvbkVycm9yRXZlbnQ8Uz4pOiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyT2JqZWN0PFM+IHtcbiAgaGFuZGxlRXZlbnQoZXZ0OiBBcHBsaWNhdGlvbkVycm9yRXZlbnQ8Uz4pOiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uRXJyb3JFdmVudEluaXQ8UyBleHRlbmRzIFN0YXRlPiBleHRlbmRzIEVycm9yRXZlbnRJbml0IHtcbiAgY29udGV4dD86IENvbnRleHQ8Uz47XG59XG5cbnR5cGUgQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXJPckV2ZW50TGlzdGVuZXJPYmplY3Q8Uz4gPVxuICB8IEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyPFM+XG4gIHwgQXBwbGljYXRpb25FcnJvckV2ZW50TGlzdGVuZXJPYmplY3Q8Uz47XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXIge1xuICAoZXZ0OiBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50KTogdm9pZCB8IFByb21pc2U8dm9pZD47XG59XG5cbmludGVyZmFjZSBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50TGlzdGVuZXJPYmplY3Qge1xuICBoYW5kbGVFdmVudChldnQ6IEFwcGxpY2F0aW9uTGlzdGVuRXZlbnQpOiB2b2lkIHwgUHJvbWlzZTx2b2lkPjtcbn1cblxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uTGlzdGVuRXZlbnRJbml0IGV4dGVuZHMgRXZlbnRJbml0IHtcbiAgaG9zdG5hbWU/OiBzdHJpbmc7XG4gIHBvcnQ6IG51bWJlcjtcbiAgc2VjdXJlOiBib29sZWFuO1xufVxuXG50eXBlIEFwcGxpY2F0aW9uTGlzdGVuRXZlbnRMaXN0ZW5lck9yRXZlbnRMaXN0ZW5lck9iamVjdCA9XG4gIHwgQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyXG4gIHwgQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyT2JqZWN0O1xuXG5leHBvcnQgaW50ZXJmYWNlIEFwcGxpY2F0aW9uT3B0aW9uczxTPiB7XG4gIC8qKiBBbiBpbml0aWFsIHNldCBvZiBrZXlzIChvciBpbnN0YW5jZSBvZiBgS2V5R3JpcGApIHRvIGJlIHVzZWQgZm9yIHNpZ25pbmdcbiAgICogY29va2llcyBwcm9kdWNlZCBieSB0aGUgYXBwbGljYXRpb24uICovXG4gIGtleXM/OiBLZXlTdGFjayB8IEtleVtdO1xuXG4gIC8qKiBJZiBzZXQgdG8gYHRydWVgLCBwcm94eSBoZWFkZXJzIHdpbGwgYmUgdHJ1c3RlZCB3aGVuIHByb2Nlc3NpbmcgcmVxdWVzdHMuXG4gICAqIFRoaXMgZGVmYXVsdHMgdG8gYGZhbHNlYC4gKi9cbiAgcHJveHk/OiBib29sZWFuO1xuXG4gIC8qKiBUaGUgYHNlcnZlcigpYCBmdW5jdGlvbiB0byBiZSB1c2VkIHRvIHJlYWQgcmVxdWVzdHMuXG4gICAqIFxuICAgKiBfTm90IHVzZWQgZ2VuZXJhbGx5LCBhcyB0aGlzIGlzIGp1c3QgZm9yIG1vY2tpbmcgZm9yIHRlc3QgcHVycG9zZXNfICovXG4gIHNlcnZlPzogU2VydmU7XG5cbiAgLyoqIFRoZSBgc2VydmVyKClgIGZ1bmN0aW9uIHRvIGJlIHVzZWQgdG8gcmVhZCByZXF1ZXN0cy5cbiAgICogXG4gICAqIF9Ob3QgdXNlZCBnZW5lcmFsbHksIGFzIHRoaXMgaXMganVzdCBmb3IgbW9ja2luZyBmb3IgdGVzdCBwdXJwb3Nlc18gKi9cbiAgc2VydmVUbHM/OiBTZXJ2ZVRscztcblxuICAvKiogVGhlIGluaXRpYWwgc3RhdGUgb2JqZWN0IGZvciB0aGUgYXBwbGljYXRpb24sIG9mIHdoaWNoIHRoZSB0eXBlIGNhbiBiZVxuICAgKiB1c2VkIHRvIGluZmVyIHRoZSB0eXBlIG9mIHRoZSBzdGF0ZSBmb3IgYm90aCB0aGUgYXBwbGljYXRpb24gYW5kIGFueSBvZiB0aGVcbiAgICogYXBwbGljYXRpb24ncyBjb250ZXh0LiAqL1xuICBzdGF0ZT86IFM7XG59XG5cbmludGVyZmFjZSBSZXF1ZXN0U3RhdGUge1xuICBoYW5kbGluZzogU2V0PFByb21pc2U8dm9pZD4+O1xuICBjbG9zaW5nOiBib29sZWFuO1xuICBjbG9zZWQ6IGJvb2xlYW47XG4gIHNlcnZlcjogU2VydmVyO1xufVxuXG4vLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuZXhwb3J0IHR5cGUgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nIHwgbnVtYmVyIHwgc3ltYm9sLCBhbnk+O1xuXG5jb25zdCBBRERSX1JFR0VYUCA9IC9eXFxbPyhbXlxcXV0qKVxcXT86KFswLTldezEsNX0pJC87XG5cbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvbkVycm9yRXZlbnQ8UyBleHRlbmRzIFN0YXRlPiBleHRlbmRzIEVycm9yRXZlbnQge1xuICBjb250ZXh0PzogQ29udGV4dDxTPjtcblxuICBjb25zdHJ1Y3RvcihldmVudEluaXREaWN0OiBBcHBsaWNhdGlvbkVycm9yRXZlbnRJbml0PFM+KSB7XG4gICAgc3VwZXIoXCJlcnJvclwiLCBldmVudEluaXREaWN0KTtcbiAgICB0aGlzLmNvbnRleHQgPSBldmVudEluaXREaWN0LmNvbnRleHQ7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uTGlzdGVuRXZlbnQgZXh0ZW5kcyBFdmVudCB7XG4gIGhvc3RuYW1lPzogc3RyaW5nO1xuICBwb3J0OiBudW1iZXI7XG4gIHNlY3VyZTogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihldmVudEluaXREaWN0OiBBcHBsaWNhdGlvbkxpc3RlbkV2ZW50SW5pdCkge1xuICAgIHN1cGVyKFwibGlzdGVuXCIsIGV2ZW50SW5pdERpY3QpO1xuICAgIHRoaXMuaG9zdG5hbWUgPSBldmVudEluaXREaWN0Lmhvc3RuYW1lO1xuICAgIHRoaXMucG9ydCA9IGV2ZW50SW5pdERpY3QucG9ydDtcbiAgICB0aGlzLnNlY3VyZSA9IGV2ZW50SW5pdERpY3Quc2VjdXJlO1xuICB9XG59XG5cbi8qKiBBIGNsYXNzIHdoaWNoIHJlZ2lzdGVycyBtaWRkbGV3YXJlICh2aWEgYC51c2UoKWApIGFuZCB0aGVuIHByb2Nlc3Nlc1xuICogaW5ib3VuZCByZXF1ZXN0cyBhZ2FpbnN0IHRoYXQgbWlkZGxld2FyZSAodmlhIGAubGlzdGVuKClgKS5cbiAqXG4gKiBUaGUgYGNvbnRleHQuc3RhdGVgIGNhbiBiZSB0eXBlZCB2aWEgcGFzc2luZyBhIGdlbmVyaWMgYXJndW1lbnQgd2hlblxuICogY29uc3RydWN0aW5nIGFuIGluc3RhbmNlIG9mIGBBcHBsaWNhdGlvbmAuXG4gKi9cbi8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb248QVMgZXh0ZW5kcyBTdGF0ZSA9IFJlY29yZDxzdHJpbmcsIGFueT4+XG4gIGV4dGVuZHMgRXZlbnRUYXJnZXQge1xuICAjY29tcG9zZWRNaWRkbGV3YXJlPzogKGNvbnRleHQ6IENvbnRleHQ8QVM+KSA9PiBQcm9taXNlPHZvaWQ+O1xuICAja2V5cz86IEtleVN0YWNrO1xuICAjbWlkZGxld2FyZTogTWlkZGxld2FyZTxTdGF0ZSwgQ29udGV4dDxTdGF0ZT4+W10gPSBbXTtcbiAgI3NlcnZlOiBTZXJ2ZTtcbiAgI3NlcnZlVGxzOiBTZXJ2ZVRscztcblxuICAvKiogQSBzZXQgb2Yga2V5cywgb3IgYW4gaW5zdGFuY2Ugb2YgYEtleVN0YWNrYCB3aGljaCB3aWxsIGJlIHVzZWQgdG8gc2lnblxuICAgKiBjb29raWVzIHJlYWQgYW5kIHNldCBieSB0aGUgYXBwbGljYXRpb24gdG8gYXZvaWQgdGFtcGVyaW5nIHdpdGggdGhlXG4gICAqIGNvb2tpZXMuICovXG4gIGdldCBrZXlzKCk6IEtleVN0YWNrIHwgS2V5W10gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNrZXlzO1xuICB9XG5cbiAgc2V0IGtleXMoa2V5czogS2V5U3RhY2sgfCBLZXlbXSB8IHVuZGVmaW5lZCkge1xuICAgIGlmICgha2V5cykge1xuICAgICAgdGhpcy4ja2V5cyA9IHVuZGVmaW5lZDtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoa2V5cykpIHtcbiAgICAgIHRoaXMuI2tleXMgPSBuZXcgS2V5U3RhY2soa2V5cyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuI2tleXMgPSBrZXlzO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBJZiBgdHJ1ZWAsIHByb3h5IGhlYWRlcnMgd2lsbCBiZSB0cnVzdGVkIHdoZW4gcHJvY2Vzc2luZyByZXF1ZXN0cy4gIFRoaXNcbiAgICogZGVmYXVsdHMgdG8gYGZhbHNlYC4gKi9cbiAgcHJveHk6IGJvb2xlYW47XG5cbiAgLyoqIEdlbmVyaWMgc3RhdGUgb2YgdGhlIGFwcGxpY2F0aW9uLCB3aGljaCBjYW4gYmUgc3BlY2lmaWVkIGJ5IHBhc3NpbmcgdGhlXG4gICAqIGdlbmVyaWMgYXJndW1lbnQgd2hlbiBjb25zdHJ1Y3Rpbmc6XG4gICAqXG4gICAqICAgICAgIGNvbnN0IGFwcCA9IG5ldyBBcHBsaWNhdGlvbjx7IGZvbzogc3RyaW5nIH0+KCk7XG4gICAqIFxuICAgKiBPciBjYW4gYmUgY29udGV4dHVhbGx5IGluZmVycmVkIGJhc2VkIG9uIHNldHRpbmcgYW4gaW5pdGlhbCBzdGF0ZSBvYmplY3Q6XG4gICAqIFxuICAgKiAgICAgICBjb25zdCBhcHAgPSBuZXcgQXBwbGljYXRpb24oeyBzdGF0ZTogeyBmb286IFwiYmFyXCIgfSB9KTtcbiAgICogXG4gICAqL1xuICBzdGF0ZTogQVM7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogQXBwbGljYXRpb25PcHRpb25zPEFTPiA9IHt9KSB7XG4gICAgc3VwZXIoKTtcbiAgICBjb25zdCB7XG4gICAgICBzdGF0ZSxcbiAgICAgIGtleXMsXG4gICAgICBwcm94eSxcbiAgICAgIHNlcnZlID0gZGVmYXVsdFNlcnZlLFxuICAgICAgc2VydmVUbHMgPSBkZWZhdWx0U2VydmVUbHMsXG4gICAgfSA9IG9wdGlvbnM7XG5cbiAgICB0aGlzLnByb3h5ID0gcHJveHkgPz8gZmFsc2U7XG4gICAgdGhpcy5rZXlzID0ga2V5cztcbiAgICB0aGlzLnN0YXRlID0gc3RhdGUgPz8ge30gYXMgQVM7XG4gICAgdGhpcy4jc2VydmUgPSBzZXJ2ZTtcbiAgICB0aGlzLiNzZXJ2ZVRscyA9IHNlcnZlVGxzO1xuICB9XG5cbiAgI2dldENvbXBvc2VkID0gKCk6ICgoY29udGV4dDogQ29udGV4dDxBUz4pID0+IFByb21pc2U8dm9pZD4pID0+IHtcbiAgICBpZiAoIXRoaXMuI2NvbXBvc2VkTWlkZGxld2FyZSkge1xuICAgICAgdGhpcy4jY29tcG9zZWRNaWRkbGV3YXJlID0gY29tcG9zZSh0aGlzLiNtaWRkbGV3YXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuI2NvbXBvc2VkTWlkZGxld2FyZTtcbiAgfTtcblxuICAvKiogRGVhbCB3aXRoIHVuY2F1Z2h0IGVycm9ycyBpbiBlaXRoZXIgdGhlIG1pZGRsZXdhcmUgb3Igc2VuZGluZyB0aGVcbiAgICogcmVzcG9uc2UuICovXG4gIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG4gICNoYW5kbGVFcnJvciA9IChjb250ZXh0OiBDb250ZXh0PEFTPiwgZXJyb3I6IGFueSk6IHZvaWQgPT4ge1xuICAgIGlmICghKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpKSB7XG4gICAgICBlcnJvciA9IG5ldyBFcnJvcihgbm9uLWVycm9yIHRocm93bjogJHtKU09OLnN0cmluZ2lmeShlcnJvcil9YCk7XG4gICAgfVxuICAgIGNvbnN0IHsgbWVzc2FnZSB9ID0gZXJyb3I7XG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBBcHBsaWNhdGlvbkVycm9yRXZlbnQoeyBjb250ZXh0LCBtZXNzYWdlLCBlcnJvciB9KSk7XG4gICAgaWYgKCFjb250ZXh0LnJlc3BvbnNlLndyaXRhYmxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGZvciAoY29uc3Qga2V5IG9mIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5rZXlzKCkpIHtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuaGVhZGVycy5kZWxldGUoa2V5KTtcbiAgICB9XG4gICAgaWYgKGVycm9yLmhlYWRlcnMgJiYgZXJyb3IuaGVhZGVycyBpbnN0YW5jZW9mIEhlYWRlcnMpIHtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGVycm9yLmhlYWRlcnMpIHtcbiAgICAgICAgY29udGV4dC5yZXNwb25zZS5oZWFkZXJzLnNldChrZXksIHZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29udGV4dC5yZXNwb25zZS50eXBlID0gXCJ0ZXh0XCI7XG4gICAgY29uc3Qgc3RhdHVzOiBTdGF0dXMgPSBjb250ZXh0LnJlc3BvbnNlLnN0YXR1cyA9XG4gICAgICBlcnJvciBpbnN0YW5jZW9mIERlbm8uZXJyb3JzLk5vdEZvdW5kXG4gICAgICAgID8gNDA0XG4gICAgICAgIDogZXJyb3Iuc3RhdHVzICYmIHR5cGVvZiBlcnJvci5zdGF0dXMgPT09IFwibnVtYmVyXCJcbiAgICAgICAgPyBlcnJvci5zdGF0dXNcbiAgICAgICAgOiA1MDA7XG4gICAgY29udGV4dC5yZXNwb25zZS5ib2R5ID0gZXJyb3IuZXhwb3NlXG4gICAgICA/IGVycm9yLm1lc3NhZ2VcbiAgICAgIDogU1RBVFVTX1RFWFQuZ2V0KHN0YXR1cyk7XG4gIH07XG5cbiAgLyoqIFByb2Nlc3NpbmcgcmVnaXN0ZXJlZCBtaWRkbGV3YXJlIG9uIGVhY2ggcmVxdWVzdC4gKi9cbiAgI2hhbmRsZVJlcXVlc3QgPSBhc3luYyAoXG4gICAgcmVxdWVzdDogU2VydmVyUmVxdWVzdCxcbiAgICBzZWN1cmU6IGJvb2xlYW4sXG4gICAgc3RhdGU6IFJlcXVlc3RTdGF0ZSxcbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgY29udGV4dCA9IG5ldyBDb250ZXh0KHRoaXMsIHJlcXVlc3QsIHNlY3VyZSk7XG4gICAgbGV0IHJlc29sdmU6ICgpID0+IHZvaWQ7XG4gICAgY29uc3QgaGFuZGxpbmdQcm9taXNlID0gbmV3IFByb21pc2U8dm9pZD4oKHJlcykgPT4gcmVzb2x2ZSA9IHJlcyk7XG4gICAgc3RhdGUuaGFuZGxpbmcuYWRkKGhhbmRsaW5nUHJvbWlzZSk7XG4gICAgaWYgKCFzdGF0ZS5jbG9zaW5nICYmICFzdGF0ZS5jbG9zZWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuI2dldENvbXBvc2VkKCkoY29udGV4dCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy4jaGFuZGxlRXJyb3IoY29udGV4dCwgZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGNvbnRleHQucmVzcG9uZCA9PT0gZmFsc2UpIHtcbiAgICAgIGNvbnRleHQucmVzcG9uc2UuZGVzdHJveSgpO1xuICAgICAgcmVzb2x2ZSEoKTtcbiAgICAgIHN0YXRlLmhhbmRsaW5nLmRlbGV0ZShoYW5kbGluZ1Byb21pc2UpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmVxdWVzdC5yZXNwb25kKGF3YWl0IGNvbnRleHQucmVzcG9uc2UudG9TZXJ2ZXJSZXNwb25zZSgpKTtcbiAgICAgIGlmIChzdGF0ZS5jbG9zaW5nKSB7XG4gICAgICAgIHN0YXRlLnNlcnZlci5jbG9zZSgpO1xuICAgICAgICBzdGF0ZS5jbG9zZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy4jaGFuZGxlRXJyb3IoY29udGV4dCwgZXJyKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgY29udGV4dC5yZXNwb25zZS5kZXN0cm95KCk7XG4gICAgICByZXNvbHZlISgpO1xuICAgICAgc3RhdGUuaGFuZGxpbmcuZGVsZXRlKGhhbmRsaW5nUHJvbWlzZSk7XG4gICAgfVxuICB9O1xuXG4gIC8qKiBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgZm9yIGFuIGBcImVycm9yXCJgIGV2ZW50IHdoaWNoIG9jY3VycyB3aGVuIGFuXG4gICAqIHVuLWNhdWdodCBlcnJvciBvY2N1cnMgd2hlbiBwcm9jZXNzaW5nIHRoZSBtaWRkbGV3YXJlIG9yIGR1cmluZyBwcm9jZXNzaW5nXG4gICAqIG9mIHRoZSByZXNwb25zZS4gKi9cbiAgYWRkRXZlbnRMaXN0ZW5lcihcbiAgICB0eXBlOiBcImVycm9yXCIsXG4gICAgbGlzdGVuZXI6IEFwcGxpY2F0aW9uRXJyb3JFdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0PEFTPiB8IG51bGwsXG4gICAgb3B0aW9ucz86IGJvb2xlYW4gfCBBZGRFdmVudExpc3RlbmVyT3B0aW9ucyxcbiAgKTogdm9pZDtcbiAgLyoqIEFkZCBhbiBldmVudCBsaXN0ZW5lciBmb3IgYSBgXCJsaXN0ZW5cImAgZXZlbnQgd2hpY2ggb2NjdXJzIHdoZW4gdGhlIHNlcnZlclxuICAgKiBoYXMgc3VjY2Vzc2Z1bGx5IG9wZW5lZCBidXQgYmVmb3JlIGFueSByZXF1ZXN0cyBzdGFydCBiZWluZyBwcm9jZXNzZWQuICovXG4gIGFkZEV2ZW50TGlzdGVuZXIoXG4gICAgdHlwZTogXCJsaXN0ZW5cIixcbiAgICBsaXN0ZW5lcjogQXBwbGljYXRpb25MaXN0ZW5FdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0IHwgbnVsbCxcbiAgICBvcHRpb25zPzogYm9vbGVhbiB8IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zLFxuICApOiB2b2lkO1xuICAvKiogQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGZvciBhbiBldmVudC4gIEN1cnJlbnRseSB2YWxpZCBldmVudCB0eXBlcyBhcmVcbiAgICogYFwiZXJyb3JcImAgYW5kIGBcImxpc3RlblwiYC4gKi9cbiAgYWRkRXZlbnRMaXN0ZW5lcihcbiAgICB0eXBlOiBcImVycm9yXCIgfCBcImxpc3RlblwiLFxuICAgIGxpc3RlbmVyOiBFdmVudExpc3RlbmVyT3JFdmVudExpc3RlbmVyT2JqZWN0IHwgbnVsbCxcbiAgICBvcHRpb25zPzogYm9vbGVhbiB8IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zLFxuICApOiB2b2lkIHtcbiAgICBzdXBlci5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKiBIYW5kbGUgYW4gaW5kaXZpZHVhbCBzZXJ2ZXIgcmVxdWVzdCwgcmV0dXJuaW5nIHRoZSBzZXJ2ZXIgcmVzcG9uc2UuICBUaGlzXG4gICAqIGlzIHNpbWlsYXIgdG8gYC5saXN0ZW4oKWAsIGJ1dCBvcGVuaW5nIHRoZSBjb25uZWN0aW9uIGFuZCByZXRyaWV2aW5nXG4gICAqIHJlcXVlc3RzIGFyZSBub3QgdGhlIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBhcHBsaWNhdGlvbi4gIElmIHRoZSBnZW5lcmF0ZWRcbiAgICogY29udGV4dCBnZXRzIHNldCB0byBub3QgdG8gcmVzcG9uZCwgdGhlbiB0aGUgbWV0aG9kIHJlc29sdmVzIHdpdGhcbiAgICogYHVuZGVmaW5lZGAsIG90aGVyd2lzZSBpdCByZXNvbHZlcyB3aXRoIGEgcmVxdWVzdCB0aGF0IGlzIGNvbXBhdGlibGUgd2l0aFxuICAgKiBgc3RkL2h0dHAvc2VydmVyYC4gKi9cbiAgaGFuZGxlID0gYXN5bmMgKFxuICAgIHJlcXVlc3Q6IFNlcnZlclJlcXVlc3QsXG4gICAgc2VjdXJlID0gZmFsc2UsXG4gICk6IFByb21pc2U8U2VydmVyUmVzcG9uc2UgfCB1bmRlZmluZWQ+ID0+IHtcbiAgICBpZiAoIXRoaXMuI21pZGRsZXdhcmUubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiVGhlcmUgaXMgbm8gbWlkZGxld2FyZSB0byBwcm9jZXNzIHJlcXVlc3RzLlwiKTtcbiAgICB9XG4gICAgY29uc3QgY29udGV4dCA9IG5ldyBDb250ZXh0KHRoaXMsIHJlcXVlc3QsIHNlY3VyZSk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuI2dldENvbXBvc2VkKCkoY29udGV4dCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLiNoYW5kbGVFcnJvcihjb250ZXh0LCBlcnIpO1xuICAgIH1cbiAgICBpZiAoY29udGV4dC5yZXNwb25kID09PSBmYWxzZSkge1xuICAgICAgY29udGV4dC5yZXNwb25zZS5kZXN0cm95KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGNvbnRleHQucmVzcG9uc2UudG9TZXJ2ZXJSZXNwb25zZSgpO1xuICAgICAgY29udGV4dC5yZXNwb25zZS5kZXN0cm95KCk7XG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLiNoYW5kbGVFcnJvcihjb250ZXh0LCBlcnIpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcblxuICAvKiogU3RhcnQgbGlzdGVuaW5nIGZvciByZXF1ZXN0cywgcHJvY2Vzc2luZyByZWdpc3RlcmVkIG1pZGRsZXdhcmUgb24gZWFjaFxuICAgKiByZXF1ZXN0LiAgSWYgdGhlIG9wdGlvbnMgYC5zZWN1cmVgIGlzIHVuZGVmaW5lZCBvciBgZmFsc2VgLCB0aGUgbGlzdGVuaW5nXG4gICAqIHdpbGwgYmUgb3ZlciBIVFRQLiAgSWYgdGhlIG9wdGlvbnMgYC5zZWN1cmVgIHByb3BlcnR5IGlzIGB0cnVlYCwgYVxuICAgKiBgLmNlcnRGaWxlYCBhbmQgYSBgLmtleUZpbGVgIHByb3BlcnR5IG5lZWQgdG8gYmUgc3VwcGxpZWQgYW5kIHJlcXVlc3RzXG4gICAqIHdpbGwgYmUgcHJvY2Vzc2VkIG92ZXIgSFRUUFMuICovXG4gIGFzeW5jIGxpc3RlbihhZGRyOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+O1xuICAvKiogU3RhcnQgbGlzdGVuaW5nIGZvciByZXF1ZXN0cywgcHJvY2Vzc2luZyByZWdpc3RlcmVkIG1pZGRsZXdhcmUgb24gZWFjaFxuICAgKiByZXF1ZXN0LiAgSWYgdGhlIG9wdGlvbnMgYC5zZWN1cmVgIGlzIHVuZGVmaW5lZCBvciBgZmFsc2VgLCB0aGUgbGlzdGVuaW5nXG4gICAqIHdpbGwgYmUgb3ZlciBIVFRQLiAgSWYgdGhlIG9wdGlvbnMgYC5zZWN1cmVgIHByb3BlcnR5IGlzIGB0cnVlYCwgYVxuICAgKiBgLmNlcnRGaWxlYCBhbmQgYSBgLmtleUZpbGVgIHByb3BlcnR5IG5lZWQgdG8gYmUgc3VwcGxpZWQgYW5kIHJlcXVlc3RzXG4gICAqIHdpbGwgYmUgcHJvY2Vzc2VkIG92ZXIgSFRUUFMuICovXG4gIGFzeW5jIGxpc3RlbihvcHRpb25zOiBMaXN0ZW5PcHRpb25zKTogUHJvbWlzZTx2b2lkPjtcbiAgYXN5bmMgbGlzdGVuKG9wdGlvbnM6IHN0cmluZyB8IExpc3Rlbk9wdGlvbnMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuI21pZGRsZXdhcmUubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKFwiVGhlcmUgaXMgbm8gbWlkZGxld2FyZSB0byBwcm9jZXNzIHJlcXVlc3RzLlwiKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zdCBtYXRjaCA9IEFERFJfUkVHRVhQLmV4ZWMob3B0aW9ucyk7XG4gICAgICBpZiAoIW1hdGNoKSB7XG4gICAgICAgIHRocm93IFR5cGVFcnJvcihgSW52YWxpZCBhZGRyZXNzIHBhc3NlZDogXCIke29wdGlvbnN9XCJgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IFssIGhvc3RuYW1lLCBwb3J0U3RyXSA9IG1hdGNoO1xuICAgICAgb3B0aW9ucyA9IHsgaG9zdG5hbWUsIHBvcnQ6IHBhcnNlSW50KHBvcnRTdHIsIDEwKSB9O1xuICAgIH1cbiAgICBjb25zdCBzZXJ2ZXIgPSBpc09wdGlvbnNUbHMob3B0aW9ucylcbiAgICAgID8gdGhpcy4jc2VydmVUbHMob3B0aW9ucylcbiAgICAgIDogdGhpcy4jc2VydmUob3B0aW9ucyk7XG4gICAgY29uc3QgeyBzaWduYWwgfSA9IG9wdGlvbnM7XG4gICAgY29uc3Qgc3RhdGUgPSB7XG4gICAgICBjbG9zZWQ6IGZhbHNlLFxuICAgICAgY2xvc2luZzogZmFsc2UsXG4gICAgICBoYW5kbGluZzogbmV3IFNldDxQcm9taXNlPHZvaWQ+PigpLFxuICAgICAgc2VydmVyLFxuICAgIH07XG4gICAgaWYgKHNpZ25hbCkge1xuICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoXCJhYm9ydFwiLCAoKSA9PiB7XG4gICAgICAgIGlmICghc3RhdGUuaGFuZGxpbmcuc2l6ZSkge1xuICAgICAgICAgIHNlcnZlci5jbG9zZSgpO1xuICAgICAgICAgIHN0YXRlLmNsb3NlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgc3RhdGUuY2xvc2luZyA9IHRydWU7XG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3QgeyBob3N0bmFtZSwgcG9ydCwgc2VjdXJlID0gZmFsc2UgfSA9IG9wdGlvbnM7XG4gICAgdGhpcy5kaXNwYXRjaEV2ZW50KFxuICAgICAgbmV3IEFwcGxpY2F0aW9uTGlzdGVuRXZlbnQoeyBob3N0bmFtZSwgcG9ydCwgc2VjdXJlIH0pLFxuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIGZvciBhd2FpdCAoY29uc3QgcmVxdWVzdCBvZiBzZXJ2ZXIpIHtcbiAgICAgICAgdGhpcy4jaGFuZGxlUmVxdWVzdChyZXF1ZXN0LCBzZWN1cmUsIHN0YXRlKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHN0YXRlLmhhbmRsaW5nKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGVycm9yIGluc3RhbmNlb2YgRXJyb3JcbiAgICAgICAgPyBlcnJvci5tZXNzYWdlXG4gICAgICAgIDogXCJBcHBsaWNhdGlvbiBFcnJvclwiO1xuICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KFxuICAgICAgICBuZXcgQXBwbGljYXRpb25FcnJvckV2ZW50KHsgbWVzc2FnZSwgZXJyb3IgfSksXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKiBSZWdpc3RlciBtaWRkbGV3YXJlIHRvIGJlIHVzZWQgd2l0aCB0aGUgYXBwbGljYXRpb24uICBNaWRkbGV3YXJlIHdpbGxcbiAgICogYmUgcHJvY2Vzc2VkIGluIHRoZSBvcmRlciBpdCBpcyBhZGRlZCwgYnV0IG1pZGRsZXdhcmUgY2FuIGNvbnRyb2wgdGhlIGZsb3dcbiAgICogb2YgZXhlY3V0aW9uIHZpYSB0aGUgdXNlIG9mIHRoZSBgbmV4dCgpYCBmdW5jdGlvbiB0aGF0IHRoZSBtaWRkbGV3YXJlXG4gICAqIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGguICBUaGUgYGNvbnRleHRgIG9iamVjdCBwcm92aWRlcyBpbmZvcm1hdGlvblxuICAgKiBhYm91dCB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgYXBwbGljYXRpb24uXG4gICAqIFxuICAgKiBCYXNpYyB1c2FnZTpcbiAgICogXG4gICAqIGBgYHRzXG4gICAqIGNvbnN0IGltcG9ydCB7IEFwcGxpY2F0aW9uIH0gZnJvbSBcImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrL21vZC50c1wiO1xuICAgKiBcbiAgICogY29uc3QgYXBwID0gbmV3IEFwcGxpY2F0aW9uKCk7XG4gICAqIFxuICAgKiBhcHAudXNlKChjdHgsIG5leHQpID0+IHtcbiAgICogICBjdHgucmVxdWVzdDsgLy8gY29udGFpbnMgcmVxdWVzdCBpbmZvcm1hdGlvblxuICAgKiAgIGN0eC5yZXNwb25zZTsgLy8gc2V0dXBzIHVwIGluZm9ybWF0aW9uIHRvIHVzZSBpbiB0aGUgcmVzcG9uc2U7XG4gICAqICAgYXdhaXQgbmV4dCgpOyAvLyBtYW5hZ2VzIHRoZSBmbG93IGNvbnRyb2wgb2YgdGhlIG1pZGRsZXdhcmUgZXhlY3V0aW9uXG4gICAqIH0pO1xuICAgKiBcbiAgICogYXdhaXQgYXBwLmxpc3Rlbih7IHBvcnQ6IDgwIH0pO1xuICAgKiBgYGBcbiAgICovXG4gIHVzZTxTIGV4dGVuZHMgU3RhdGUgPSBBUz4oXG4gICAgLi4ubWlkZGxld2FyZTogTWlkZGxld2FyZTxTLCBDb250ZXh0PFM+PltdXG4gICk6IEFwcGxpY2F0aW9uPFMgZXh0ZW5kcyBBUyA/IFMgOiAoUyAmIEFTKT4ge1xuICAgIHRoaXMuI21pZGRsZXdhcmUucHVzaCguLi5taWRkbGV3YXJlKTtcbiAgICB0aGlzLiNjb21wb3NlZE1pZGRsZXdhcmUgPSB1bmRlZmluZWQ7XG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICByZXR1cm4gdGhpcyBhcyBBcHBsaWNhdGlvbjxhbnk+O1xuICB9XG59XG4iXX0=