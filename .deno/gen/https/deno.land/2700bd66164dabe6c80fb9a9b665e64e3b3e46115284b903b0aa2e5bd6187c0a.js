import { toParamRegExp, unquote } from "./headers.ts";
let needsEncodingFixup = false;
function fixupEncoding(value) {
    if (needsEncodingFixup && /[\x80-\xff]/.test(value)) {
        value = textDecode("utf-8", value);
        if (needsEncodingFixup) {
            value = textDecode("iso-8859-1", value);
        }
    }
    return value;
}
const FILENAME_STAR_REGEX = toParamRegExp("filename\\*", "i");
const FILENAME_START_ITER_REGEX = toParamRegExp("filename\\*((?!0\\d)\\d+)(\\*?)", "ig");
const FILENAME_REGEX = toParamRegExp("filename", "i");
function rfc2047decode(value) {
    if (!value.startsWith("=?") || /[\x00-\x19\x80-\xff]/.test(value)) {
        return value;
    }
    return value.replace(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g, (_, charset, encoding, text) => {
        if (encoding === "q" || encoding === "Q") {
            text = text.replace(/_/g, " ");
            text = text.replace(/=([0-9a-fA-F]{2})/g, (_, hex) => String.fromCharCode(parseInt(hex, 16)));
            return textDecode(charset, text);
        }
        try {
            text = atob(text);
        }
        catch { }
        return textDecode(charset, text);
    });
}
function rfc2231getParam(header) {
    const matches = [];
    let match;
    while ((match = FILENAME_START_ITER_REGEX.exec(header))) {
        const [, ns, quote, part] = match;
        const n = parseInt(ns, 10);
        if (n in matches) {
            if (n === 0) {
                break;
            }
            continue;
        }
        matches[n] = [quote, part];
    }
    const parts = [];
    for (let n = 0; n < matches.length; ++n) {
        if (!(n in matches)) {
            break;
        }
        let [quote, part] = matches[n];
        part = unquote(part);
        if (quote) {
            part = unescape(part);
            if (n === 0) {
                part = rfc5987decode(part);
            }
        }
        parts.push(part);
    }
    return parts.join("");
}
function rfc5987decode(value) {
    const encodingEnd = value.indexOf(`'`);
    if (encodingEnd === -1) {
        return value;
    }
    const encoding = value.slice(0, encodingEnd);
    const langValue = value.slice(encodingEnd + 1);
    return textDecode(encoding, langValue.replace(/^[^']*'/, ""));
}
function textDecode(encoding, value) {
    if (encoding) {
        try {
            const decoder = new TextDecoder(encoding, { fatal: true });
            const bytes = Array.from(value, (c) => c.charCodeAt(0));
            if (bytes.every((code) => code <= 0xFF)) {
                value = decoder.decode(new Uint8Array(bytes));
                needsEncodingFixup = false;
            }
        }
        catch { }
    }
    return value;
}
export function getFilename(header) {
    needsEncodingFixup = true;
    let matches = FILENAME_STAR_REGEX.exec(header);
    if (matches) {
        const [, filename] = matches;
        return fixupEncoding(rfc2047decode(rfc5987decode(unescape(unquote(filename)))));
    }
    const filename = rfc2231getParam(header);
    if (filename) {
        return fixupEncoding(rfc2047decode(filename));
    }
    matches = FILENAME_REGEX.exec(header);
    if (matches) {
        const [, filename] = matches;
        return fixupEncoding(rfc2047decode(unquote(filename)));
    }
    return "";
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudF9kaXNwb3NpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbnRlbnRfZGlzcG9zaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBV0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFdEQsSUFBSSxrQkFBa0IsR0FBRyxLQUFLLENBQUM7QUFFL0IsU0FBUyxhQUFhLENBQUMsS0FBYTtJQUNsQyxJQUFJLGtCQUFrQixJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDbkQsS0FBSyxHQUFHLFVBQVUsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkMsSUFBSSxrQkFBa0IsRUFBRTtZQUN0QixLQUFLLEdBQUcsVUFBVSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUN6QztLQUNGO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBRUQsTUFBTSxtQkFBbUIsR0FBRyxhQUFhLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzlELE1BQU0seUJBQXlCLEdBQUcsYUFBYSxDQUM3QyxpQ0FBaUMsRUFDakMsSUFBSSxDQUNMLENBQUM7QUFDRixNQUFNLGNBQWMsR0FBRyxhQUFhLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRXRELFNBQVMsYUFBYSxDQUFDLEtBQWE7SUFFbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksc0JBQXNCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ2pFLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFDRCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQ2xCLGdEQUFnRCxFQUNoRCxDQUFDLENBQVMsRUFBRSxPQUFlLEVBQUUsUUFBZ0IsRUFBRSxJQUFZLEVBQUUsRUFBRTtRQUM3RCxJQUFJLFFBQVEsS0FBSyxHQUFHLElBQUksUUFBUSxLQUFLLEdBQUcsRUFBRTtZQUN4QyxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDL0IsSUFBSSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQ2pCLG9CQUFvQixFQUNwQixDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUNuRCxDQUFDO1lBQ0YsT0FBTyxVQUFVLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ2xDO1FBQ0QsSUFBSTtZQUNGLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FFbkI7UUFBQyxNQUFNLEdBQUU7UUFDVixPQUFPLFVBQVUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQyxDQUNGLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsTUFBYztJQUNyQyxNQUFNLE9BQU8sR0FBdUIsRUFBRSxDQUFDO0lBQ3ZDLElBQUksS0FBNkIsQ0FBQztJQUNsQyxPQUFPLENBQUMsS0FBSyxHQUFHLHlCQUF5QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFO1FBQ3ZELE1BQU0sQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ2xDLE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksT0FBTyxFQUFFO1lBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDWCxNQUFNO2FBQ1A7WUFDRCxTQUFTO1NBQ1Y7UUFDRCxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDNUI7SUFDRCxNQUFNLEtBQUssR0FBYSxFQUFFLENBQUM7SUFDM0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUU7UUFDdkMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxFQUFFO1lBQ25CLE1BQU07U0FDUDtRQUNELElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckIsSUFBSSxLQUFLLEVBQUU7WUFDVCxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDWCxJQUFJLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzVCO1NBQ0Y7UUFDRCxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ2xCO0lBQ0QsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3hCLENBQUM7QUFFRCxTQUFTLGFBQWEsQ0FBQyxLQUFhO0lBQ2xDLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDdkMsSUFBSSxXQUFXLEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDdEIsT0FBTyxLQUFLLENBQUM7S0FDZDtJQUNELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQzdDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQy9DLE9BQU8sVUFBVSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLENBQUM7QUFFRCxTQUFTLFVBQVUsQ0FBQyxRQUFnQixFQUFFLEtBQWE7SUFDakQsSUFBSSxRQUFRLEVBQUU7UUFDWixJQUFJO1lBQ0YsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUMsUUFBUSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDM0QsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4RCxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsRUFBRTtnQkFDdkMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDO2FBQzVCO1NBRUY7UUFBQyxNQUFNLEdBQUU7S0FDWDtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQUMsTUFBYztJQUN4QyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7SUFHMUIsSUFBSSxPQUFPLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQy9DLElBQUksT0FBTyxFQUFFO1FBQ1gsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzdCLE9BQU8sYUFBYSxDQUNsQixhQUFhLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQzFELENBQUM7S0FDSDtJQUtELE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN6QyxJQUFJLFFBQVEsRUFBRTtRQUNaLE9BQU8sYUFBYSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0tBQy9DO0lBR0QsT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEMsSUFBSSxPQUFPLEVBQUU7UUFDWCxNQUFNLENBQUMsRUFBRSxRQUFRLENBQUMsR0FBRyxPQUFPLENBQUM7UUFDN0IsT0FBTyxhQUFhLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDeEQ7SUFFRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFkYXB0ZWQgZGlyZWN0bHkgZnJvbSBjb250ZW50LWRpc3Bvc2l0aW9uLmpzIGF0IFxuICogaHR0cHM6Ly9naXRodWIuY29tL1JvYi0tVy9vcGVuLWluLWJyb3dzZXIvYmxvYi9tYXN0ZXIvZXh0ZW5zaW9uL2NvbnRlbnQtZGlzcG9zaXRpb24uanNcbiAqIHdoaWNoIGlzIGxpY2Vuc2VkIGFzOlxuICogXG4gKiAoYykgMjAxNyBSb2IgV3UgPHJvYkByb2J3dS5ubD4gKGh0dHBzOi8vcm9id3UubmwpXG4gKiBUaGlzIFNvdXJjZSBDb2RlIEZvcm0gaXMgc3ViamVjdCB0byB0aGUgdGVybXMgb2YgdGhlIE1vemlsbGEgUHVibGljXG4gKiBMaWNlbnNlLCB2LiAyLjAuIElmIGEgY29weSBvZiB0aGUgTVBMIHdhcyBub3QgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzXG4gKiBmaWxlLCBZb3UgY2FuIG9idGFpbiBvbmUgYXQgaHR0cDovL21vemlsbGEub3JnL01QTC8yLjAvLlxuICovXG5cbmltcG9ydCB7IHRvUGFyYW1SZWdFeHAsIHVucXVvdGUgfSBmcm9tIFwiLi9oZWFkZXJzLnRzXCI7XG5cbmxldCBuZWVkc0VuY29kaW5nRml4dXAgPSBmYWxzZTtcblxuZnVuY3Rpb24gZml4dXBFbmNvZGluZyh2YWx1ZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgaWYgKG5lZWRzRW5jb2RpbmdGaXh1cCAmJiAvW1xceDgwLVxceGZmXS8udGVzdCh2YWx1ZSkpIHtcbiAgICB2YWx1ZSA9IHRleHREZWNvZGUoXCJ1dGYtOFwiLCB2YWx1ZSk7XG4gICAgaWYgKG5lZWRzRW5jb2RpbmdGaXh1cCkge1xuICAgICAgdmFsdWUgPSB0ZXh0RGVjb2RlKFwiaXNvLTg4NTktMVwiLCB2YWx1ZSk7XG4gICAgfVxuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuY29uc3QgRklMRU5BTUVfU1RBUl9SRUdFWCA9IHRvUGFyYW1SZWdFeHAoXCJmaWxlbmFtZVxcXFwqXCIsIFwiaVwiKTtcbmNvbnN0IEZJTEVOQU1FX1NUQVJUX0lURVJfUkVHRVggPSB0b1BhcmFtUmVnRXhwKFxuICBcImZpbGVuYW1lXFxcXCooKD8hMFxcXFxkKVxcXFxkKykoXFxcXCo/KVwiLFxuICBcImlnXCIsXG4pO1xuY29uc3QgRklMRU5BTUVfUkVHRVggPSB0b1BhcmFtUmVnRXhwKFwiZmlsZW5hbWVcIiwgXCJpXCIpO1xuXG5mdW5jdGlvbiByZmMyMDQ3ZGVjb2RlKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWNvbnRyb2wtcmVnZXhcbiAgaWYgKCF2YWx1ZS5zdGFydHNXaXRoKFwiPT9cIikgfHwgL1tcXHgwMC1cXHgxOVxceDgwLVxceGZmXS8udGVzdCh2YWx1ZSkpIHtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cbiAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoXG4gICAgLz1cXD8oW1xcdy1dKilcXD8oW1FxQmJdKVxcPygoPzpbXj9dfFxcPyg/IT0pKSopXFw/PS9nLFxuICAgIChfOiBzdHJpbmcsIGNoYXJzZXQ6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZywgdGV4dDogc3RyaW5nKSA9PiB7XG4gICAgICBpZiAoZW5jb2RpbmcgPT09IFwicVwiIHx8IGVuY29kaW5nID09PSBcIlFcIikge1xuICAgICAgICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9fL2csIFwiIFwiKTtcbiAgICAgICAgdGV4dCA9IHRleHQucmVwbGFjZShcbiAgICAgICAgICAvPShbMC05YS1mQS1GXXsyfSkvZyxcbiAgICAgICAgICAoXywgaGV4KSA9PiBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KGhleCwgMTYpKSxcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHRleHREZWNvZGUoY2hhcnNldCwgdGV4dCk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICB0ZXh0ID0gYXRvYih0ZXh0KTtcbiAgICAgICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1lbXB0eVxuICAgICAgfSBjYXRjaCB7fVxuICAgICAgcmV0dXJuIHRleHREZWNvZGUoY2hhcnNldCwgdGV4dCk7XG4gICAgfSxcbiAgKTtcbn1cblxuZnVuY3Rpb24gcmZjMjIzMWdldFBhcmFtKGhlYWRlcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbWF0Y2hlczogW3N0cmluZywgc3RyaW5nXVtdID0gW107XG4gIGxldCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcbiAgd2hpbGUgKChtYXRjaCA9IEZJTEVOQU1FX1NUQVJUX0lURVJfUkVHRVguZXhlYyhoZWFkZXIpKSkge1xuICAgIGNvbnN0IFssIG5zLCBxdW90ZSwgcGFydF0gPSBtYXRjaDtcbiAgICBjb25zdCBuID0gcGFyc2VJbnQobnMsIDEwKTtcbiAgICBpZiAobiBpbiBtYXRjaGVzKSB7XG4gICAgICBpZiAobiA9PT0gMCkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBtYXRjaGVzW25dID0gW3F1b3RlLCBwYXJ0XTtcbiAgfVxuICBjb25zdCBwYXJ0czogc3RyaW5nW10gPSBbXTtcbiAgZm9yIChsZXQgbiA9IDA7IG4gPCBtYXRjaGVzLmxlbmd0aDsgKytuKSB7XG4gICAgaWYgKCEobiBpbiBtYXRjaGVzKSkge1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGxldCBbcXVvdGUsIHBhcnRdID0gbWF0Y2hlc1tuXTtcbiAgICBwYXJ0ID0gdW5xdW90ZShwYXJ0KTtcbiAgICBpZiAocXVvdGUpIHtcbiAgICAgIHBhcnQgPSB1bmVzY2FwZShwYXJ0KTtcbiAgICAgIGlmIChuID09PSAwKSB7XG4gICAgICAgIHBhcnQgPSByZmM1OTg3ZGVjb2RlKHBhcnQpO1xuICAgICAgfVxuICAgIH1cbiAgICBwYXJ0cy5wdXNoKHBhcnQpO1xuICB9XG4gIHJldHVybiBwYXJ0cy5qb2luKFwiXCIpO1xufVxuXG5mdW5jdGlvbiByZmM1OTg3ZGVjb2RlKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBlbmNvZGluZ0VuZCA9IHZhbHVlLmluZGV4T2YoYCdgKTtcbiAgaWYgKGVuY29kaW5nRW5kID09PSAtMSkge1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuICBjb25zdCBlbmNvZGluZyA9IHZhbHVlLnNsaWNlKDAsIGVuY29kaW5nRW5kKTtcbiAgY29uc3QgbGFuZ1ZhbHVlID0gdmFsdWUuc2xpY2UoZW5jb2RpbmdFbmQgKyAxKTtcbiAgcmV0dXJuIHRleHREZWNvZGUoZW5jb2RpbmcsIGxhbmdWYWx1ZS5yZXBsYWNlKC9eW14nXSonLywgXCJcIikpO1xufVxuXG5mdW5jdGlvbiB0ZXh0RGVjb2RlKGVuY29kaW5nOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICBpZiAoZW5jb2RpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcihlbmNvZGluZywgeyBmYXRhbDogdHJ1ZSB9KTtcbiAgICAgIGNvbnN0IGJ5dGVzID0gQXJyYXkuZnJvbSh2YWx1ZSwgKGMpID0+IGMuY2hhckNvZGVBdCgwKSk7XG4gICAgICBpZiAoYnl0ZXMuZXZlcnkoKGNvZGUpID0+IGNvZGUgPD0gMHhGRikpIHtcbiAgICAgICAgdmFsdWUgPSBkZWNvZGVyLmRlY29kZShuZXcgVWludDhBcnJheShieXRlcykpO1xuICAgICAgICBuZWVkc0VuY29kaW5nRml4dXAgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIC8vIGRlbm8tbGludC1pZ25vcmUgbm8tZW1wdHlcbiAgICB9IGNhdGNoIHt9XG4gIH1cbiAgcmV0dXJuIHZhbHVlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZW5hbWUoaGVhZGVyOiBzdHJpbmcpOiBzdHJpbmcge1xuICBuZWVkc0VuY29kaW5nRml4dXAgPSB0cnVlO1xuXG4gIC8vIGZpbGVuYW1lKj1leHQtdmFsdWUgKFwiZXh0LXZhbHVlXCIgZnJvbSBSRkMgNTk4NywgcmVmZXJlbmNlZCBieSBSRkMgNjI2NikuXG4gIGxldCBtYXRjaGVzID0gRklMRU5BTUVfU1RBUl9SRUdFWC5leGVjKGhlYWRlcik7XG4gIGlmIChtYXRjaGVzKSB7XG4gICAgY29uc3QgWywgZmlsZW5hbWVdID0gbWF0Y2hlcztcbiAgICByZXR1cm4gZml4dXBFbmNvZGluZyhcbiAgICAgIHJmYzIwNDdkZWNvZGUocmZjNTk4N2RlY29kZSh1bmVzY2FwZSh1bnF1b3RlKGZpbGVuYW1lKSkpKSxcbiAgICApO1xuICB9XG5cbiAgLy8gQ29udGludWF0aW9ucyAoUkZDIDIyMzEgc2VjdGlvbiAzLCByZWZlcmVuY2VkIGJ5IFJGQyA1OTg3IHNlY3Rpb24gMy4xKS5cbiAgLy8gZmlsZW5hbWUqbio9cGFydFxuICAvLyBmaWxlbmFtZSpuPXBhcnRcbiAgY29uc3QgZmlsZW5hbWUgPSByZmMyMjMxZ2V0UGFyYW0oaGVhZGVyKTtcbiAgaWYgKGZpbGVuYW1lKSB7XG4gICAgcmV0dXJuIGZpeHVwRW5jb2RpbmcocmZjMjA0N2RlY29kZShmaWxlbmFtZSkpO1xuICB9XG5cbiAgLy8gZmlsZW5hbWU9dmFsdWUgKFJGQyA1OTg3LCBzZWN0aW9uIDQuMSkuXG4gIG1hdGNoZXMgPSBGSUxFTkFNRV9SRUdFWC5leGVjKGhlYWRlcik7XG4gIGlmIChtYXRjaGVzKSB7XG4gICAgY29uc3QgWywgZmlsZW5hbWVdID0gbWF0Y2hlcztcbiAgICByZXR1cm4gZml4dXBFbmNvZGluZyhyZmMyMDQ3ZGVjb2RlKHVucXVvdGUoZmlsZW5hbWUpKSk7XG4gIH1cblxuICByZXR1cm4gXCJcIjtcbn1cbiJdfQ==