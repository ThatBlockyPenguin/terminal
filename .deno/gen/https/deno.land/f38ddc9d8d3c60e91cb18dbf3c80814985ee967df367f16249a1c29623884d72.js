const { open } = Deno;
import { BufReader } from "./vendor/https/deno.land/std/io/bufio.ts";
import { Buffer } from "./vendor/https/deno.land/std/io/buffer.ts";
import { readAll } from "./vendor/https/deno.land/std/io/util.ts";
import escape from "./vendor/https/deno.land/x/lodash/escape.js";
var ReadMode;
(function (ReadMode) {
    ReadMode[ReadMode["Normal"] = 0] = "Normal";
    ReadMode[ReadMode["Escaped"] = 1] = "Escaped";
    ReadMode[ReadMode["Raw"] = 2] = "Raw";
    ReadMode[ReadMode["Comment"] = 3] = "Comment";
    ReadMode[ReadMode["Evaluate"] = 4] = "Evaluate";
})(ReadMode || (ReadMode = {}));
var Codes;
(function (Codes) {
    Codes[Codes["Begin"] = 60] = "Begin";
    Codes[Codes["End"] = 62] = "End";
    Codes[Codes["Percent"] = 37] = "Percent";
    Codes[Codes["Escaped"] = 61] = "Escaped";
    Codes[Codes["Raw"] = 45] = "Raw";
    Codes[Codes["Comment"] = 35] = "Comment";
})(Codes || (Codes = {}));
const encoder = new TextEncoder();
const decoder = new TextDecoder("utf-8");
class StringReader extends Buffer {
    constructor(s) {
        super(encoder.encode(s).buffer);
    }
}
async function include(path, params) {
    const result = await renderFile(path, params);
    const buf = new Buffer();
    await buf.readFrom(result);
    return await bufToStr(buf);
}
function sanitize(str) {
    return str
        .replace(/\`/g, "\\\`")
        .replace(/\$/g, "\\\$")
        .replace(/\\+$/, "");
}
async function bufToStr(buf) {
    return decoder.decode(await readAll(buf));
}
function removeLastSemi(s) {
    return s.trimRight().replace(/;$/, "");
}
async function bufToStrWithSanitize(buf) {
    return sanitize(await bufToStr(buf));
}
function NewTemplate(script) {
    return async (params) => {
        const output = [];
        await new Promise((resolve, reject) => {
            const args = {
                ...params,
                include,
                $$OUTPUT: output,
                $$FINISHED: resolve,
                $$ERROR: reject,
                $$ESCAPE: escape,
            };
            const src = `(async() => {
        try { ${script} } catch (error) { $$ERROR(error) }
        $$FINISHED();
      })();`;
            const f = new Function(...Object.keys(args), src);
            f(...Object.values(args));
        });
        return output.join("");
    };
}
export async function compile(reader) {
    const src = new BufReader(reader);
    const buf = [];
    const statements = [];
    const statementBuf = new Buffer();
    let readMode = ReadMode.Normal;
    const statementBufWrite = async (byte) => await statementBuf.write(new Uint8Array([byte]));
    while (true) {
        const byte = await src.readByte();
        if (byte === null) {
            break;
        }
        buf.push(byte);
        if (buf.length < 3) {
            continue;
        }
        if (readMode === ReadMode.Normal) {
            if (buf[0] === Codes.Begin && buf[1] === Codes.Percent) {
                switch (buf[2]) {
                    case Codes.Escaped:
                        readMode = ReadMode.Escaped;
                        break;
                    case Codes.Raw:
                        readMode = ReadMode.Raw;
                        break;
                    case Codes.Comment:
                        readMode = ReadMode.Comment;
                        break;
                    default:
                        readMode = ReadMode.Evaluate;
                        break;
                }
                statements.push(`;$$OUTPUT.push(\`${await bufToStrWithSanitize(statementBuf)}\`);`);
                statementBuf.reset();
                buf.splice(0);
                continue;
            }
            if (buf.length > 2) {
                await statementBufWrite(buf.shift());
            }
            continue;
        }
        if (buf[1] === Codes.Percent && buf[2] === Codes.End) {
            statementBufWrite(buf.shift());
            buf.splice(0);
            if (readMode !== ReadMode.Comment) {
                switch (readMode) {
                    case ReadMode.Raw:
                        statements.push(`;$$OUTPUT.push(${removeLastSemi(await bufToStr(statementBuf))});`);
                        break;
                    case ReadMode.Escaped:
                        statements.push(`;$$OUTPUT.push($$ESCAPE(${removeLastSemi(await bufToStr(statementBuf))}));`);
                        break;
                    case ReadMode.Evaluate:
                        statements.push(await bufToStr(statementBuf));
                        break;
                }
            }
            statementBuf.reset();
            readMode = ReadMode.Normal;
            continue;
        }
        await statementBufWrite(buf.shift());
    }
    while (buf.length > 0) {
        await statementBufWrite(buf.shift());
    }
    statements.push(`$$OUTPUT.push(\`${await bufToStrWithSanitize(statementBuf)}\`);`);
    statementBuf.reset();
    return await NewTemplate(statements.join(""));
}
export async function renderToString(body, params) {
    const reader = new StringReader(body);
    const template = await compile(reader);
    return template(params);
}
export async function renderFileToString(path, params) {
    const file = await open(path);
    const template = await compile(file);
    file.close();
    return template(params);
}
export async function render(body, params) {
    const result = await renderToString(body, params);
    return new StringReader(result);
}
export async function renderFile(path, params) {
    const result = await renderFileToString(path, params);
    return new StringReader(result);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFFdEIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUNuRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFDbEUsT0FBTyxNQUFNLE1BQU0sNkNBQTZDLENBQUM7QUFPakUsSUFBSyxRQU1KO0FBTkQsV0FBSyxRQUFRO0lBQ1gsMkNBQU0sQ0FBQTtJQUNOLDZDQUFPLENBQUE7SUFDUCxxQ0FBRyxDQUFBO0lBQ0gsNkNBQU8sQ0FBQTtJQUNQLCtDQUFRLENBQUE7QUFDVixDQUFDLEVBTkksUUFBUSxLQUFSLFFBQVEsUUFNWjtBQUVELElBQUssS0FPSjtBQVBELFdBQUssS0FBSztJQUNSLG9DQUFVLENBQUE7SUFDVixnQ0FBUSxDQUFBO0lBQ1Isd0NBQVksQ0FBQTtJQUNaLHdDQUFZLENBQUE7SUFDWixnQ0FBUSxDQUFBO0lBQ1Isd0NBQVksQ0FBQTtBQUNkLENBQUMsRUFQSSxLQUFLLEtBQUwsS0FBSyxRQU9UO0FBTUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztBQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUV6QyxNQUFNLFlBQWEsU0FBUSxNQUFNO0lBQy9CLFlBQVksQ0FBUztRQUNuQixLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxDQUFDO0NBQ0Y7QUFFRCxLQUFLLFVBQVUsT0FBTyxDQUFDLElBQVksRUFBRSxNQUFjO0lBQ2pELE1BQU0sTUFBTSxHQUFHLE1BQU0sVUFBVSxDQUFDLElBQUksRUFBRSxN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QUFZLEVBQ1osTUFBYztJQUVkLE1BQU0sTUFBTSxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLGtCQUFrQixDQUN0QyxJQUFZLEVBQ1osTUFBYztJQUVkLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlCLE1BQU0sUUFBUSxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNiLE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLE1BQU0sQ0FBQyxJQUFZLEVBQUUsTUFBYztJQUN2RCxNQUFNLE1BQU0sR0FBRyxNQUFNLGNBQWMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDbEQsT0FBTyxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRUQsTUFBTSxDQUFDLEtBQUssVUFBVSxVQUFVLENBQzlCLElBQVksRUFDWixNQUFjO0lBRWQsTUFBTSxNQUFNLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEQsT0FBTyxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNsQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBvcGVuIH0gPSBEZW5vO1xudHlwZSBSZWFkZXIgPSBEZW5vLlJlYWRlcjtcbmltcG9ydCB7IEJ1ZlJlYWRlciB9IGZyb20gXCIuL3ZlbmRvci9odHRwcy9kZW5vLmxhbmQvc3RkL2lvL2J1ZmlvLnRzXCI7XG5pbXBvcnQgeyBCdWZmZXIgfSBmcm9tIFwiLi92ZW5kb3IvaHR0cHMvZGVuby5sYW5kL3N0ZC9pby9idWZmZXIudHNcIjtcbmltcG9ydCB7IHJlYWRBbGwgfSBmcm9tIFwiLi92ZW5kb3IvaHR0cHMvZGVuby5sYW5kL3N0ZC9pby91dGlsLnRzXCI7XG5pbXBvcnQgZXNjYXBlIGZyb20gXCIuL3ZlbmRvci9odHRwcy9kZW5vLmxhbmQveC9sb2Rhc2gvZXNjYXBlLmpzXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFyYW1zIHtcbiAgLy9kZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbmVudW0gUmVhZE1vZGUge1xuICBOb3JtYWwsXG4gIEVzY2FwZWQsXG4gIFJhdyxcbiAgQ29tbWVudCxcbiAgRXZhbHVhdGUsXG59XG5cbmVudW0gQ29kZXMge1xuICBCZWdpbiA9IDYwLCAvLyA8XG4gIEVuZCA9IDYyLCAvLyA+XG4gIFBlcmNlbnQgPSAzNywgLy8gJVxuICBFc2NhcGVkID0gNjEsIC8vID1cbiAgUmF3ID0gNDUsIC8vIC1cbiAgQ29tbWVudCA9IDM1LCAvLyAjXG59XG5cbmludGVyZmFjZSBUZW1wbGF0ZSB7XG4gIChwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8c3RyaW5nPjtcbn1cblxuY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpO1xuY29uc3QgZGVjb2RlciA9IG5ldyBUZXh0RGVjb2RlcihcInV0Zi04XCIpO1xuXG5jbGFzcyBTdHJpbmdSZWFkZXIgZXh0ZW5kcyBCdWZmZXIge1xuICBjb25zdHJ1Y3RvcihzOiBzdHJpbmcpIHtcbiAgICBzdXBlcihlbmNvZGVyLmVuY29kZShzKS5idWZmZXIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluY2x1ZGUocGF0aDogc3RyaW5nLCBwYXJhbXM6IFBhcmFtcyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlbmRlckZpbGUocGF0aCwgcGFyYW1zKTtcbiAgY29uc3QgYnVmID0gbmV3IEJ1ZmZlcigpO1xuICBhd2FpdCBidWYucmVhZEZyb20ocmVzdWx0KTtcbiAgcmV0dXJuIGF3YWl0IGJ1ZlRvU3RyKGJ1Zik7XG59XG5cbmZ1bmN0aW9uIHNhbml0aXplKHN0cjogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHN0clxuICAgIC5yZXBsYWNlKC9cXGAvZywgXCJcXFxcXFxgXCIpXG4gICAgLnJlcGxhY2UoL1xcJC9nLCBcIlxcXFxcXCRcIilcbiAgICAucmVwbGFjZSgvXFxcXCskLywgXCJcIik7IC8vIFRyaW0gYmFja3NsYXNoZXMgYXQgbGluZSBlbmQuIFRPRE86IEZpeCB0aGlzIHRvIHJlbmRlciBiYWNrc2xhc2hlcy5cbn1cblxuYXN5bmMgZnVuY3Rpb24gYnVmVG9TdHIoYnVmOiBCdWZmZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gZGVjb2Rlci5kZWNvZGUoYXdhaXQgcmVhZEFsbChidWYpKTtcbn1cblxuZnVuY3Rpb24gcmVtb3ZlTGFzdFNlbWkoczogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIHMudHJpbVJpZ2h0KCkucmVwbGFjZSgvOyQvLCBcIlwiKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gYnVmVG9TdHJXaXRoU2FuaXRpemUoYnVmOiBCdWZmZXIpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gc2FuaXRpemUoYXdhaXQgYnVmVG9TdHIoYnVmKSk7XG59XG5cbmZ1bmN0aW9uIE5ld1RlbXBsYXRlKHNjcmlwdDogc3RyaW5nKTogVGVtcGxhdGUge1xuICByZXR1cm4gYXN5bmMgKHBhcmFtczogUGFyYW1zKTogUHJvbWlzZTxzdHJpbmc+ID0+IHtcbiAgICBjb25zdCBvdXRwdXQ6IEFycmF5PHN0cmluZz4gPSBbXTtcbiAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCBhcmdzID0ge1xuICAgICAgICAuLi5wYXJhbXMsXG4gICAgICAgIGluY2x1ZGUsXG4gICAgICAgICQkT1VUUFVUOiBvdXRwdXQsXG4gICAgICAgICQkRklOSVNIRUQ6IHJlc29sdmUsXG4gICAgICAgICQkRVJST1I6IHJlamVjdCxcbiAgICAgICAgJCRFU0NBUEU6IGVzY2FwZSxcbiAgICAgIH07XG4gICAgICBjb25zdCBzcmMgPSBgKGFzeW5jKCkgPT4ge1xuICAgICAgICB0cnkgeyAke3NjcmlwdH0gfSBjYXRjaCAoZXJyb3IpIHsgJCRFUlJPUihlcnJvcikgfVxuICAgICAgICAkJEZJTklTSEVEKCk7XG4gICAgICB9KSgpO2A7XG4gICAgICBjb25zdCBmID0gbmV3IEZ1bmN0aW9uKC4uLk9iamVjdC5rZXlzKGFyZ3MpLCBzcmMpO1xuICAgICAgZiguLi5PYmplY3QudmFsdWVzKGFyZ3MpKTtcbiAgICB9KTtcbiAgICByZXR1cm4gb3V0cHV0LmpvaW4oXCJcIik7XG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb21waWxlKHJlYWRlcjogUmVhZGVyKTogUHJvbWlzZTxUZW1wbGF0ZT4ge1xuICBjb25zdCBzcmMgPSBuZXcgQnVmUmVhZGVyKHJlYWRlcik7XG4gIGNvbnN0IGJ1ZjogQXJyYXk8bnVtYmVyPiA9IFtdO1xuICBjb25zdCBzdGF0ZW1lbnRzOiBBcnJheTxzdHJpbmc+ID0gW107XG4gIGNvbnN0IHN0YXRlbWVudEJ1ZiA9IG5ldyBCdWZmZXIoKTtcbiAgbGV0IHJlYWRNb2RlOiBSZWFkTW9kZSA9IFJlYWRNb2RlLk5vcm1hbDtcbiAgY29uc3Qgc3RhdGVtZW50QnVmV3JpdGUgPSBhc3luYyAoYnl0ZTogbnVtYmVyKTogUHJvbWlzZTxudW1iZXI+ID0+XG4gICAgYXdhaXQgc3RhdGVtZW50QnVmLndyaXRlKG5ldyBVaW50OEFycmF5KFtieXRlXSkpO1xuXG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3QgYnl0ZSA9IGF3YWl0IHNyYy5yZWFkQnl0ZSgpO1xuICAgIGlmIChieXRlID09PSBudWxsKSB7XG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBidWYucHVzaChieXRlKTtcbiAgICBpZiAoYnVmLmxlbmd0aCA8IDMpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChyZWFkTW9kZSA9PT0gUmVhZE1vZGUuTm9ybWFsKSB7XG4gICAgICAvLyBEZXRlY3QgUmVhZE1vZGVcbiAgICAgIGlmIChidWZbMF0gPT09IENvZGVzLkJlZ2luICYmIGJ1ZlsxXSA9PT0gQ29kZXMuUGVyY2VudCkge1xuICAgICAgICBzd2l0Y2ggKGJ1ZlsyXSkge1xuICAgICAgICAgIGNhc2UgQ29kZXMuRXNjYXBlZDpcbiAgICAgICAgICAgIHJlYWRNb2RlID0gUmVhZE1vZGUuRXNjYXBlZDtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgQ29kZXMuUmF3OlxuICAgICAgICAgICAgcmVhZE1vZGUgPSBSZWFkTW9kZS5SYXc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIENvZGVzLkNvbW1lbnQ6XG4gICAgICAgICAgICByZWFkTW9kZSA9IFJlYWRNb2RlLkNvbW1lbnQ7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmVhZE1vZGUgPSBSZWFkTW9kZS5FdmFsdWF0ZTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHN0YXRlbWVudHMucHVzaChcbiAgICAgICAgICBgOyQkT1VUUFVULnB1c2goXFxgJHthd2FpdCBidWZUb1N0cldpdGhTYW5pdGl6ZShzdGF0ZW1lbnRCdWYpfVxcYCk7YCxcbiAgICAgICAgKTtcbiAgICAgICAgc3RhdGVtZW50QnVmLnJlc2V0KCk7XG4gICAgICAgIGJ1Zi5zcGxpY2UoMCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKGJ1Zi5sZW5ndGggPiAyKSB7XG4gICAgICAgIGF3YWl0IHN0YXRlbWVudEJ1ZldyaXRlKGJ1Zi5zaGlmdCgpIGFzIG51bWJlcik7XG4gICAgICB9XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICAvLyBGaW5pc2ggY3VycmVudCBSZWFkTW9kZVxuICAgIGlmIChidWZbMV0gPT09IENvZGVzLlBlcmNlbnQgJiYgYnVmWzJdID09PSBDb2Rlcy5FbmQpIHtcbiAgICAgIHN0YXRlbWVudEJ1ZldyaXRlKGJ1Zi5zaGlmdCgpIGFzIG51bWJlcik7XG4gICAgICBidWYuc3BsaWNlKDApO1xuICAgICAgLy8gRG9uJ3QgZXhlY3V0ZSBpZiBSZWFkTW9kZSBpcyBDb21tZW50LlxuICAgICAgaWYgKHJlYWRNb2RlICE9PSBSZWFkTW9kZS5Db21tZW50KSB7XG4gICAgICAgIHN3aXRjaCAocmVhZE1vZGUpIHtcbiAgICAgICAgICBjYXNlIFJlYWRNb2RlLlJhdzpcbiAgICAgICAgICAgIHN0YXRlbWVudHMucHVzaChcbiAgICAgICAgICAgICAgYDskJE9VVFBVVC5wdXNoKCR7XG4gICAgICAgICAgICAgICAgcmVtb3ZlTGFzdFNlbWkoYXdhaXQgYnVmVG9TdHIoc3RhdGVtZW50QnVmKSlcbiAgICAgICAgICAgICAgfSk7YCxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlIFJlYWRNb2RlLkVzY2FwZWQ6XG4gICAgICAgICAgICBzdGF0ZW1lbnRzLnB1c2goXG4gICAgICAgICAgICAgIGA7JCRPVVRQVVQucHVzaCgkJEVTQ0FQRSgke1xuICAgICAgICAgICAgICAgIHJlbW92ZUxhc3RTZW1pKGF3YWl0IGJ1ZlRvU3RyKHN0YXRlbWVudEJ1ZikpXG4gICAgICAgICAgICAgIH0pKTtgLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgUmVhZE1vZGUuRXZhbHVhdGU6XG4gICAgICAgICAgICBzdGF0ZW1lbnRzLnB1c2goYXdhaXQgYnVmVG9TdHIoc3RhdGVtZW50QnVmKSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgc3RhdGVtZW50QnVmLnJlc2V0KCk7XG4gICAgICByZWFkTW9kZSA9IFJlYWRNb2RlLk5vcm1hbDtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cbiAgICBhd2FpdCBzdGF0ZW1lbnRCdWZXcml0ZShidWYuc2hpZnQoKSBhcyBudW1iZXIpO1xuICB9XG5cbiAgLy8gRmx1c2ggYnVmZmVyXG4gIHdoaWxlIChidWYubGVuZ3RoID4gMCkge1xuICAgIGF3YWl0IHN0YXRlbWVudEJ1ZldyaXRlKGJ1Zi5zaGlmdCgpIGFzIG51bWJlcik7XG4gIH1cbiAgc3RhdGVtZW50cy5wdXNoKFxuICAgIGAkJE9VVFBVVC5wdXNoKFxcYCR7YXdhaXQgYnVmVG9TdHJXaXRoU2FuaXRpemUoc3RhdGVtZW50QnVmKX1cXGApO2AsXG4gICk7XG4gIHN0YXRlbWVudEJ1Zi5yZXNldCgpO1xuXG4gIHJldHVybiBhd2FpdCBOZXdUZW1wbGF0ZShzdGF0ZW1lbnRzLmpvaW4oXCJcIikpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyVG9TdHJpbmcoXG4gIGJvZHk6IHN0cmluZyxcbiAgcGFyYW1zOiBQYXJhbXMsXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCByZWFkZXIgPSBuZXcgU3RyaW5nUmVhZGVyKGJvZHkpO1xuICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IGNvbXBpbGUocmVhZGVyKTtcbiAgcmV0dXJuIHRlbXBsYXRlKHBhcmFtcyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXJGaWxlVG9TdHJpbmcoXG4gIHBhdGg6IHN0cmluZyxcbiAgcGFyYW1zOiBQYXJhbXMsXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBmaWxlID0gYXdhaXQgb3BlbihwYXRoKTtcbiAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCBjb21waWxlKGZpbGUpO1xuICBmaWxlLmNsb3NlKCk7XG4gIHJldHVybiB0ZW1wbGF0ZShwYXJhbXMpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyKGJvZHk6IHN0cmluZywgcGFyYW1zOiBQYXJhbXMpOiBQcm9taXNlPFJlYWRlcj4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCByZW5kZXJUb1N0cmluZyhib2R5LCBwYXJhbXMpO1xuICByZXR1cm4gbmV3IFN0cmluZ1JlYWRlcihyZXN1bHQpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyRmlsZShcbiAgcGF0aDogc3RyaW5nLFxuICBwYXJhbXM6IFBhcmFtcyxcbik6IFByb21pc2U8UmVhZGVyPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlbmRlckZpbGVUb1N0cmluZyhwYXRoLCBwYXJhbXMpO1xuICByZXR1cm4gbmV3IFN0cmluZ1JlYWRlcihyZXN1bHQpO1xufVxuIl19