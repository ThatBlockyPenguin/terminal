import { RequestBody } from "./body.ts";
import { preferredCharsets } from "./negotiation/charset.ts";
import { preferredEncodings } from "./negotiation/encoding.ts";
import { preferredLanguages } from "./negotiation/language.ts";
import { preferredMediaTypes } from "./negotiation/mediaType.ts";
const decoder = new TextDecoder();
export class Request {
    #body;
    #proxy;
    #secure;
    #serverRequest;
    #url;
    get hasBody() {
        return this.#body.has();
    }
    get headers() {
        return this.#serverRequest.headers;
    }
    get ip() {
        return this.#proxy
            ? this.ips[0]
            : this.#serverRequest.conn.remoteAddr.hostname;
    }
    get ips() {
        return this.#proxy
            ? (this.#serverRequest.headers.get("x-forwarded-for") ??
                this.#serverRequest.conn.remoteAddr.hostname).split(/\s*,\s*/)
            : [];
    }
    get method() {
        return this.#serverRequest.method;
    }
    get secure() {
        return this.#secure;
    }
    get serverRequest() {
        return this.#serverRequest;
    }
    get url() {
        if (!this.#url) {
            const serverRequest = this.#serverRequest;
            let proto;
            let host;
            if (this.#proxy) {
                proto = serverRequest
                    .headers.get("x-forwarded-proto")?.split(/\s*,\s*/, 1)[0] ??
                    "http";
                host = serverRequest.headers.get("x-forwarded-host") ??
                    serverRequest.headers.get("host") ?? "";
            }
            else {
                proto = this.#secure ? "https" : "http";
                host = serverRequest.headers.get("host") ?? "";
            }
            this.#url = new URL(`${proto}://${host}${serverRequest.url}`);
        }
        return this.#url;
    }
    constructor(serverRequest, proxy = false, secure = false) {
        this.#proxy = proxy;
        this.#secure = secure;
        this.#serverRequest = serverRequest;
        this.#body = new RequestBody(serverRequest);
    }
    accepts(...types) {
        const acceptValue = this.#serverRequest.headers.get("Accept");
        if (!acceptValue) {
            return;
        }
        if (types.length) {
            return preferredMediaTypes(acceptValue, types)[0];
        }
        return preferredMediaTypes(acceptValue);
    }
    acceptsCharsets(...charsets) {
        const acceptCharsetValue = this.#serverRequest.headers.get("Accept-Charset");
        if (!acceptCharsetValue) {
            return;
        }
        if (charsets.length) {
            return preferredCharsets(acceptCharsetValue, charsets)[0];
        }
        return preferredCharsets(acceptCharsetValue);
    }
    acceptsEncodings(...encodings) {
        const acceptEncodingValue = this.#serverRequest.headers.get("Accept-Encoding");
        if (!acceptEncodingValue) {
            return;
        }
        if (encodings.length) {
            return preferredEncodings(acceptEncodingValue, encodings)[0];
        }
        return preferredEncodings(acceptEncodingValue);
    }
    acceptsLanguages(...langs) {
        const acceptLanguageValue = this.#serverRequest.headers.get("Accept-Language");
        if (!acceptLanguageValue) {
            return;
        }
        if (langs.length) {
            return preferredLanguages(acceptLanguageValue, langs)[0];
        }
        return preferredLanguages(acceptLanguageValue);
    }
    body(options = {}) {
        return this.#body.get(options);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlcXVlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBWUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV4QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUVqRSxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0FBR2xDLE1BQU0sT0FBTyxPQUFPO0lBQ2xCLEtBQUssQ0FBYztJQUNuQixNQUFNLENBQVU7SUFDaEIsT0FBTyxDQUFVO0lBQ2pCLGNBQWMsQ0FBZ0I7SUFDOUIsSUFBSSxDQUFPO0lBR1gsSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFHRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDO0lBQ3JDLENBQUM7SUFLRCxJQUFJLEVBQUU7UUFDSixPQUFPLElBQUksQ0FBQyxNQUFNO1lBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNiLENBQUMsQ0FBRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUEyQixDQUFDLFFBQVEsQ0FBQztJQUNyRSxDQUFDO0lBS0QsSUFBSSxHQUFHO1FBQ0wsT0FBTyxJQUFJLENBQUMsTUFBTTtZQUNoQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUM7Z0JBQ2xELElBQUksQ0FBQyxjQUFjLENBQUMs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O0lBQy9DLENBQUM7SUFnQkQsZ0JBQWdCLENBQUMsR0FBRyxTQUFtQjtRQUNyQyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FDekQsaUJBQWlCLENBQ2xCLENBQUM7UUFDRixJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDeEIsT0FBTztTQUNSO1FBQ0QsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFO1lBQ3BCLE9BQU8sa0JBQWtCLENBQUMsbUJBQW1CLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDOUQ7UUFDRCxPQUFPLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDakQsQ0FBQztJQVdELGdCQUFnQixDQUFDLEdBQUcsS0FBZTtRQUNqQyxNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FDekQsaUJBQWlCLENBQ2xCLENBQUM7UUFDRixJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDeEIsT0FBTztTQUNSO1FBQ0QsSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ2hCLE9BQU8sa0JBQWtCLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDMUQ7UUFDRCxPQUFPLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDakQsQ0FBQztJQVNELElBQUksQ0FBQyxVQUF1QixFQUFFO1FBQzVCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDakMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyMCB0aGUgb2FrIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQgdHlwZSB7XG4gIEJvZHksXG4gIEJvZHlGb3JtLFxuICBCb2R5Rm9ybURhdGEsXG4gIEJvZHlKc29uLFxuICBCb2R5T3B0aW9ucyxcbiAgQm9keVJhdyxcbiAgQm9keVJlYWRlcixcbiAgQm9keVRleHQsXG59IGZyb20gXCIuL2JvZHkudHNcIjtcbmltcG9ydCB7IFJlcXVlc3RCb2R5IH0gZnJvbSBcIi4vYm9keS50c1wiO1xuaW1wb3J0IHR5cGUgeyBIVFRQTWV0aG9kcywgU2VydmVyUmVxdWVzdCB9IGZyb20gXCIuL3R5cGVzLmQudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZENoYXJzZXRzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vY2hhcnNldC50c1wiO1xuaW1wb3J0IHsgcHJlZmVycmVkRW5jb2RpbmdzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vZW5jb2RpbmcudHNcIjtcbmltcG9ydCB7IHByZWZlcnJlZExhbmd1YWdlcyB9IGZyb20gXCIuL25lZ290aWF0aW9uL2xhbmd1YWdlLnRzXCI7XG5pbXBvcnQgeyBwcmVmZXJyZWRNZWRpYVR5cGVzIH0gZnJvbSBcIi4vbmVnb3RpYXRpb24vbWVkaWFUeXBlLnRzXCI7XG5cbmNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTtcblxuLyoqIEFuIGludGVyZmFjZSB3aGljaCBwcm92aWRlcyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgY3VycmVudCByZXF1ZXN0LiAqL1xuZXhwb3J0IGNsYXNzIFJlcXVlc3Qge1xuICAjYm9keTogUmVxdWVzdEJvZHk7XG4gICNwcm94eTogYm9vbGVhbjtcbiAgI3NlY3VyZTogYm9vbGVhbjtcbiAgI3NlcnZlclJlcXVlc3Q6IFNlcnZlclJlcXVlc3Q7XG4gICN1cmw/OiBVUkw7XG5cbiAgLyoqIElzIGB0cnVlYCBpZiB0aGUgcmVxdWVzdCBoYXMgYSBib2R5LCBvdGhlcndpc2UgYGZhbHNlYC4gKi9cbiAgZ2V0IGhhc0JvZHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI2JvZHkuaGFzKCk7XG4gIH1cblxuICAvKiogVGhlIGBIZWFkZXJzYCBzdXBwbGllZCBpbiB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IGhlYWRlcnMoKTogSGVhZGVycyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QuaGVhZGVycztcbiAgfVxuXG4gIC8qKiBSZXF1ZXN0IHJlbW90ZSBhZGRyZXNzLiBXaGVuIHRoZSBhcHBsaWNhdGlvbidzIGAucHJveHlgIGlzIHRydWUsIHRoZVxuICAgKiBgWC1Gb3J3YXJkZWQtRm9yYCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHRoZSByZXF1ZXN0aW5nIHJlbW90ZSBhZGRyZXNzLlxuICAgKi9cbiAgZ2V0IGlwKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuI3Byb3h5XG4gICAgICA/IHRoaXMuaXBzWzBdXG4gICAgICA6ICh0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmNvbm4ucmVtb3RlQWRkciBhcyBEZW5vLk5ldEFkZHIpLmhvc3RuYW1lO1xuICB9XG5cbiAgLyoqIFdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgYC5wcm94eWAgaXMgYHRydWVgLCB0aGlzIHdpbGwgYmUgc2V0IHRvIGFuIGFycmF5IG9mXG4gICAqIElQcywgb3JkZXJlZCBmcm9tIHVwc3RyZWFtIHRvIGRvd25zdHJlYW0sIGJhc2VkIG9uIHRoZSB2YWx1ZSBvZiB0aGUgaGVhZGVyIFxuICAgKiBgWC1Gb3J3YXJkZWQtRm9yYC4gIFdoZW4gYGZhbHNlYCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZC4gKi9cbiAgZ2V0IGlwcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHRoaXMuI3Byb3h5XG4gICAgICA/ICh0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwieC1mb3J3YXJkZWQtZm9yXCIpID8/XG4gICAgICAgICh0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmNvbm4ucmVtb3RlQWRkciBhcyBEZW5vLk5ldEFkZHIpLmhvc3RuYW1lKS5zcGxpdChcbiAgICAgICAgICAvXFxzKixcXHMqLyxcbiAgICAgICAgKVxuICAgICAgOiBbXTtcbiAgfVxuXG4gIC8qKiBUaGUgSFRUUCBNZXRob2QgdXNlZCBieSB0aGUgcmVxdWVzdC4gKi9cbiAgZ2V0IG1ldGhvZCgpOiBIVFRQTWV0aG9kcyB7XG4gICAgcmV0dXJuIHRoaXMuI3NlcnZlclJlcXVlc3QubWV0aG9kIGFzIEhUVFBNZXRob2RzO1xuICB9XG5cbiAgLyoqIFNob3J0Y3V0IHRvIGByZXF1ZXN0LnVybC5wcm90b2NvbCA9PT0gXCJodHRwczpcImAuICovXG4gIGdldCBzZWN1cmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuI3NlY3VyZTtcbiAgfVxuXG4gIC8qKiBTZXQgdG8gdGhlIHZhbHVlIG9mIHRoZSBfb3JpZ2luYWxfIERlbm8gc2VydmVyIHJlcXVlc3QuICovXG4gIGdldCBzZXJ2ZXJSZXF1ZXN0KCk6IFNlcnZlclJlcXVlc3Qge1xuICAgIHJldHVybiB0aGlzLiNzZXJ2ZXJSZXF1ZXN0O1xuICB9XG5cbiAgLyoqIEEgcGFyc2VkIFVSTCBmb3IgdGhlIHJlcXVlc3Qgd2hpY2ggY29tcGxpZXMgd2l0aCB0aGUgYnJvd3NlciBzdGFuZGFyZHMuXG4gICAqIFdoZW4gdGhlIGFwcGxpY2F0aW9uJ3MgYC5wcm94eWAgaXMgYHRydWVgLCB0aGlzIHZhbHVlIHdpbGwgYmUgYmFzZWQgb2ZmIG9mXG4gICAqIHRoZSBgWC1Gb3J3YXJkZWQtUHJvdG9gIGFuZCBgWC1Gb3J3YXJkZWQtSG9zdGAgaGVhZGVyIHZhbHVlcyBpZiBwcmVzZW50IGluXG4gICAqIHRoZSByZXF1ZXN0LiAqL1xuICBnZXQgdXJsKCk6IFVSTCB7XG4gICAgaWYgKCF0aGlzLiN1cmwpIHtcbiAgICAgIGNvbnN0IHNlcnZlclJlcXVlc3QgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0O1xuICAgICAgbGV0IHByb3RvOiBzdHJpbmc7XG4gICAgICBsZXQgaG9zdDogc3RyaW5nO1xuICAgICAgaWYgKHRoaXMuI3Byb3h5KSB7XG4gICAgICAgIHByb3RvID0gc2VydmVyUmVxdWVzdFxuICAgICAgICAgIC5oZWFkZXJzLmdldChcIngtZm9yd2FyZGVkLXByb3RvXCIpPy5zcGxpdCgvXFxzKixcXHMqLywgMSlbMF0gPz9cbiAgICAgICAgICBcImh0dHBcIjtcbiAgICAgICAgaG9zdCA9IHNlcnZlclJlcXVlc3QuaGVhZGVycy5nZXQoXCJ4LWZvcndhcmRlZC1ob3N0XCIpID8/XG4gICAgICAgICAgc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcImhvc3RcIikgPz8gXCJcIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb3RvID0gdGhpcy4jc2VjdXJlID8gXCJodHRwc1wiIDogXCJodHRwXCI7XG4gICAgICAgIGhvc3QgPSBzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFwiaG9zdFwiKSA/PyBcIlwiO1xuICAgICAgfVxuICAgICAgdGhpcy4jdXJsID0gbmV3IFVSTChgJHtwcm90b306Ly8ke2hvc3R9JHtzZXJ2ZXJSZXF1ZXN0LnVybH1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuI3VybDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHNlcnZlclJlcXVlc3Q6IFNlcnZlclJlcXVlc3QsIHByb3h5ID0gZmFsc2UsIHNlY3VyZSA9IGZhbHNlKSB7XG4gICAgdGhpcy4jcHJveHkgPSBwcm94eTtcbiAgICB0aGlzLiNzZWN1cmUgPSBzZWN1cmU7XG4gICAgdGhpcy4jc2VydmVyUmVxdWVzdCA9IHNlcnZlclJlcXVlc3Q7XG4gICAgdGhpcy4jYm9keSA9IG5ldyBSZXF1ZXN0Qm9keShzZXJ2ZXJSZXF1ZXN0KTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGFycmF5IG9mIG1lZGlhIHR5cGVzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5ncyBzdXBwbGllZCBieSB0aGUgcmVxdWVzdG9yLFxuICAgKiBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC5cbiAgICovXG4gIGFjY2VwdHMoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgbWVkaWEgdHlwZXMsIHJldHVybiB0aGUgYmVzdCBtYXRjaCBhY2NlcHRlZCBieSB0aGVcbiAgICogcmVxdWVzdG9yLiAgSWYgdGhlcmUgYXJlIG5vIGVuY29kaW5nIHRoYXQgbWF0Y2gsIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zXG4gICAqIGB1bmRlZmluZWRgLlxuICAgKi9cbiAgYWNjZXB0cyguLi50eXBlczogc3RyaW5nW10pOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGFjY2VwdHMoLi4udHlwZXM6IHN0cmluZ1tdKTogc3RyaW5nIHwgc3RyaW5nW10gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFjY2VwdFZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcIkFjY2VwdFwiKTtcbiAgICBpZiAoIWFjY2VwdFZhbHVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0eXBlcy5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBwcmVmZXJyZWRNZWRpYVR5cGVzKGFjY2VwdFZhbHVlLCB0eXBlcylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRNZWRpYVR5cGVzKGFjY2VwdFZhbHVlKTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGFycmF5IG9mIGNoYXJzZXRzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGNoYXJzZXRzIHN1cHBsaWVkIGJ5IHRoZSByZXF1ZXN0b3IsXG4gICAqIGB1bmRlZmluZWRgIGlzIHJldHVybmVkLlxuICAgKi9cbiAgYWNjZXB0c0NoYXJzZXRzKCk6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICAvKiogRm9yIGEgZ2l2ZW4gc2V0IG9mIGNoYXJzZXRzLCByZXR1cm4gdGhlIGJlc3QgbWF0Y2ggYWNjZXB0ZWQgYnkgdGhlXG4gICAqIHJlcXVlc3Rvci4gIElmIHRoZXJlIGFyZSBubyBjaGFyc2V0cyB0aGF0IG1hdGNoLCB0aGVuIHRoZSBtZXRob2QgcmV0dXJuc1xuICAgKiBgdW5kZWZpbmVkYC4gKi9cbiAgYWNjZXB0c0NoYXJzZXRzKC4uLmNoYXJzZXRzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYWNjZXB0c0NoYXJzZXRzKC4uLmNoYXJzZXRzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBhY2NlcHRDaGFyc2V0VmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFxuICAgICAgXCJBY2NlcHQtQ2hhcnNldFwiLFxuICAgICk7XG4gICAgaWYgKCFhY2NlcHRDaGFyc2V0VmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNoYXJzZXRzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZENoYXJzZXRzKGFjY2VwdENoYXJzZXRWYWx1ZSwgY2hhcnNldHMpWzBdO1xuICAgIH1cbiAgICByZXR1cm4gcHJlZmVycmVkQ2hhcnNldHMoYWNjZXB0Q2hhcnNldFZhbHVlKTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGFuIGFycmF5IG9mIGVuY29kaW5ncywgYWNjZXB0ZWQgYnkgdGhlIHJlcXVlc3RvciwgaW4gb3JkZXIgb2ZcbiAgICogcHJlZmVyZW5jZS4gIElmIHRoZXJlIGFyZSBubyBlbmNvZGluZ3Mgc3VwcGxpZWQgYnkgdGhlIHJlcXVlc3RvcixcbiAgICogYHVuZGVmaW5lZGAgaXMgcmV0dXJuZWQuXG4gICAqL1xuICBhY2NlcHRzRW5jb2RpbmdzKCk6IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuICAvKiogRm9yIGEgZ2l2ZW4gc2V0IG9mIGVuY29kaW5ncywgcmV0dXJuIHRoZSBiZXN0IG1hdGNoIGFjY2VwdGVkIGJ5IHRoZVxuICAgKiByZXF1ZXN0b3IuICBJZiB0aGVyZSBhcmUgbm8gZW5jb2RpbmdzIHRoYXQgbWF0Y2gsIHRoZW4gdGhlIG1ldGhvZCByZXR1cm5zXG4gICAqIGB1bmRlZmluZWRgLlxuICAgKlxuICAgKiAqKk5PVEU6KiogWW91IHNob3VsZCBhbHdheXMgc3VwcGx5IGBpZGVudGl0eWAgYXMgb25lIG9mIHRoZSBlbmNvZGluZ3NcbiAgICogdG8gZW5zdXJlIHRoYXQgdGhlcmUgaXMgYSBtYXRjaCB3aGVuIHRoZSBgQWNjZXB0LUVuY29kaW5nYCBoZWFkZXIgaXMgcGFydFxuICAgKiBvZiB0aGUgcmVxdWVzdC5cbiAgICovXG4gIGFjY2VwdHNFbmNvZGluZ3MoLi4uZW5jb2RpbmdzOiBzdHJpbmdbXSk6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgYWNjZXB0c0VuY29kaW5ncyguLi5lbmNvZGluZ3M6IHN0cmluZ1tdKTogc3RyaW5nW10gfCBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGFjY2VwdEVuY29kaW5nVmFsdWUgPSB0aGlzLiNzZXJ2ZXJSZXF1ZXN0LmhlYWRlcnMuZ2V0KFxuICAgICAgXCJBY2NlcHQtRW5jb2RpbmdcIixcbiAgICApO1xuICAgIGlmICghYWNjZXB0RW5jb2RpbmdWYWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoZW5jb2RpbmdzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZEVuY29kaW5ncyhhY2NlcHRFbmNvZGluZ1ZhbHVlLCBlbmNvZGluZ3MpWzBdO1xuICAgIH1cbiAgICByZXR1cm4gcHJlZmVycmVkRW5jb2RpbmdzKGFjY2VwdEVuY29kaW5nVmFsdWUpO1xuICB9XG5cbiAgLyoqIFJldHVybnMgYW4gYXJyYXkgb2YgbGFuZ3VhZ2VzLCBhY2NlcHRlZCBieSB0aGUgcmVxdWVzdG9yLCBpbiBvcmRlciBvZlxuICAgKiBwcmVmZXJlbmNlLiAgSWYgdGhlcmUgYXJlIG5vIGxhbmd1YWdlcyBzdXBwbGllZCBieSB0aGUgcmVxdWVzdG9yLFxuICAgKiBgdW5kZWZpbmVkYCBpcyByZXR1cm5lZC5cbiAgICovXG4gIGFjY2VwdHNMYW5ndWFnZXMoKTogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gIC8qKiBGb3IgYSBnaXZlbiBzZXQgb2YgbGFuZ3VhZ2VzLCByZXR1cm4gdGhlIGJlc3QgbWF0Y2ggYWNjZXB0ZWQgYnkgdGhlXG4gICAqIHJlcXVlc3Rvci4gIElmIHRoZXJlIGFyZSBubyBsYW5ndWFnZXMgdGhhdCBtYXRjaCwgdGhlbiB0aGUgbWV0aG9kIHJldHVybnNcbiAgICogYHVuZGVmaW5lZGAuICovXG4gIGFjY2VwdHNMYW5ndWFnZXMoLi4ubGFuZ3M6IHN0cmluZ1tdKTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICBhY2NlcHRzTGFuZ3VhZ2VzKC4uLmxhbmdzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHwgc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBhY2NlcHRMYW5ndWFnZVZhbHVlID0gdGhpcy4jc2VydmVyUmVxdWVzdC5oZWFkZXJzLmdldChcbiAgICAgIFwiQWNjZXB0LUxhbmd1YWdlXCIsXG4gICAgKTtcbiAgICBpZiAoIWFjY2VwdExhbmd1YWdlVmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGxhbmdzLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZExhbmd1YWdlcyhhY2NlcHRMYW5ndWFnZVZhbHVlLCBsYW5ncylbMF07XG4gICAgfVxuICAgIHJldHVybiBwcmVmZXJyZWRMYW5ndWFnZXMoYWNjZXB0TGFuZ3VhZ2VWYWx1ZSk7XG4gIH1cblxuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwiZm9ybVwiPik6IEJvZHlGb3JtO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwiZm9ybS1kYXRhXCI+KTogQm9keUZvcm1EYXRhO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwianNvblwiPik6IEJvZHlKc29uO1xuICBib2R5KG9wdGlvbnM6IEJvZHlPcHRpb25zPFwicmF3XCI+KTogQm9keVJhdztcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9uczxcInJlYWRlclwiPik6IEJvZHlSZWFkZXI7XG4gIGJvZHkob3B0aW9uczogQm9keU9wdGlvbnM8XCJ0ZXh0XCI+KTogQm9keVRleHQ7XG4gIGJvZHkob3B0aW9ucz86IEJvZHlPcHRpb25zKTogQm9keTtcbiAgYm9keShvcHRpb25zOiBCb2R5T3B0aW9ucyA9IHt9KTogQm9keSB8IEJvZHlSZWFkZXIge1xuICAgIHJldHVybiB0aGlzLiNib2R5LmdldChvcHRpb25zKTtcbiAgfVxufVxuIl19