import { isAbsolute, join, normalize, sep, Sha1, Status } from "./deps.ts";
import { createHttpError } from "./httpError.ts";
const ENCODE_CHARS_REGEXP = /(?:[^\x21\x25\x26-\x3B\x3D\x3F-\x5B\x5D\x5F\x61-\x7A\x7E]|%(?:[^0-9A-Fa-f]|[0-9A-Fa-f][^0-9A-Fa-f]|$))+/g;
const HTAB = "\t".charCodeAt(0);
const SPACE = " ".charCodeAt(0);
const CR = "\r".charCodeAt(0);
const LF = "\n".charCodeAt(0);
const UNMATCHED_SURROGATE_PAIR_REGEXP = /(^|[^\uD800-\uDBFF])[\uDC00-\uDFFF]|[\uD800-\uDBFF]([^\uDC00-\uDFFF]|$)/g;
const UNMATCHED_SURROGATE_PAIR_REPLACE = "$1\uFFFD$2";
export function decodeComponent(text) {
    try {
        return decodeURIComponent(text);
    }
    catch {
        return text;
    }
}
export function encodeUrl(url) {
    return String(url)
        .replace(UNMATCHED_SURROGATE_PAIR_REGEXP, UNMATCHED_SURROGATE_PAIR_REPLACE)
        .replace(ENCODE_CHARS_REGEXP, encodeURI);
}
export function getRandomFilename(prefix = "", extension = "") {
    return `${prefix}${new Sha1().update(crypto.getRandomValues(new Uint8Array(256))).hex()}${extension ? `.${extension}` : ""}`;
}
export function isErrorStatus(value) {
    return [
        Status.BadRequest,
        Status.Unauthorized,
        Status.PaymentRequired,
        Status.Forbidden,
        Status.NotFound,
        Status.MethodNotAllowed,
        Status.NotAcceptable,
        Status.ProxyAuthRequired,
        Status.RequestTimeout,
        Status.Conflict,
        Status.Gone,
        Status.LengthRequired,
        Status.PreconditionFailed,
        Status.RequestEntityTooLarge,
        Status.RequestURITooLong,
        Status.UnsupportedMediaType,
        Status.RequestedRangeNotSatisfiable,
        Status.ExpectationFailed,
        Status.Teapot,
        Status.MisdirectedRequest,
        Status.UnprocessableEntity,
        Status.Locked,
        Status.FailedDependency,
        Status.UpgradeRequired,
        Status.PreconditionRequired,
        Status.TooManyRequests,
        Status.RequestHeaderFieldsTooLarge,
        Status.UnavailableForLegalReasons,
        Status.InternalServerError,
        Status.NotImplemented,
        Status.BadGateway,
        Status.ServiceUnavailable,
        Status.GatewayTimeout,
        Status.HTTPVersionNotSupported,
        Status.VariantAlsoNegotiates,
        Status.InsufficientStorage,
        Status.LoopDetected,
        Status.NotExtended,
        Status.NetworkAuthenticationRequired,
    ].includes(value);
}
export function isRedirectStatus(value) {
    return [
        Status.MultipleChoices,
        Status.MovedPermanently,
        Status.Found,
        Status.SeeOther,
        Status.UseProxy,
        Status.TemporaryRedirect,
        Status.PermanentRedirect,
    ].includes(value);
}
export function isHtml(value) {
    return /^\s*<(?:!DOCTYPE|html|body)/i.test(value);
}
export function skipLWSPChar(u8) {
    const result = new Uint8Array(u8.length);
    let j = 0;
    for (let i = 0; i < u8.length; i++) {
        if (u8[i] === SPACE || u8[i] === HTAB)
            continue;
        result[j++] = u8[i];
    }
    return result.slice(0, j);
}
export function stripEol(value) {
    if (value[value.byteLength - 1] == LF) {
        let drop = 1;
        if (value.byteLength > 1 && value[value.byteLength - 2] === CR) {
            drop = 2;
        }
        return value.subarray(0, value.byteLength - drop);
    }
    return value;
}
const UP_PATH_REGEXP = /(?:^|[\\/])\.\.(?:[\\/]|$)/;
export function resolvePath(rootPath, relativePath) {
    let path = relativePath;
    let root = rootPath;
    if (relativePath === undefined) {
        path = rootPath;
        root = ".";
    }
    if (path == null) {
        throw new TypeError("Argument relativePath is required.");
    }
    if (path.includes("\0")) {
        throw createHttpError(400, "Malicious Path");
    }
    if (isAbsolute(path)) {
        throw createHttpError(400, "Malicious Path");
    }
    if (UP_PATH_REGEXP.test(normalize("." + sep + path))) {
        throw createHttpError(403);
    }
    return normalize(join(root, path));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdqRCxNQUFNLG1CQUFtQixHQUN2QiwwR0FBMEcsQ0FBQztBQUM3RyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hDLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDaEMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM5QixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLE1BQU0sK0JBQStCLEdBQ25DLDBFQUEwRSxDQUFDO0FBQzdFLE1BQU0sZ0NBQWdDLEdBQUcsWUFBWSxDQUFDO0FBS3RELE1BQU0sVUFBVSxlQUFlLENBQUMsSUFBWTtJQUMxQyxJQUFJO1FBQ0YsT0FBTyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUNqQztJQUFDLE1BQU07UUFDTixPQUFPLElBQUksQ0FBQztLQUNiO0FBQ0gsQ0FBQztBQUdELE1BQU0sVUFBVSxTQUFTLENBQUMsR0FBVztJQUNuQyxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUM7U0FDZixPQUFPLENBQUMsK0JBQStCLEVBQUUsZ0NBQWdDLENBQUM7U0FDMUUsT0FBTyxDQUFDLG1CQUFtQixFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFFRCxNQUFNLFVBQVUsaUJBQWlCLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRSxTQUFTLEdBQUcsRUFBRTtJ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O1FBQ3BCLE1BQU0sZUFBZSxDQUFDLEdBQUcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0tBQzlDO0lBR0QsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUU7UUFDcEQsTUFBTSxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDNUI7SUFHRCxPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDckMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAyMDE4LTIwMjAgdGhlIG9hayBhdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLiBNSVQgbGljZW5zZS5cblxuaW1wb3J0IHsgaXNBYnNvbHV0ZSwgam9pbiwgbm9ybWFsaXplLCBzZXAsIFNoYTEsIFN0YXR1cyB9IGZyb20gXCIuL2RlcHMudHNcIjtcbmltcG9ydCB7IGNyZWF0ZUh0dHBFcnJvciB9IGZyb20gXCIuL2h0dHBFcnJvci50c1wiO1xuaW1wb3J0IHR5cGUgeyBFcnJvclN0YXR1cywgUmVkaXJlY3RTdGF0dXMgfSBmcm9tIFwiLi90eXBlcy5kLnRzXCI7XG5cbmNvbnN0IEVOQ09ERV9DSEFSU19SRUdFWFAgPVxuICAvKD86W15cXHgyMVxceDI1XFx4MjYtXFx4M0JcXHgzRFxceDNGLVxceDVCXFx4NURcXHg1RlxceDYxLVxceDdBXFx4N0VdfCUoPzpbXjAtOUEtRmEtZl18WzAtOUEtRmEtZl1bXjAtOUEtRmEtZl18JCkpKy9nO1xuY29uc3QgSFRBQiA9IFwiXFx0XCIuY2hhckNvZGVBdCgwKTtcbmNvbnN0IFNQQUNFID0gXCIgXCIuY2hhckNvZGVBdCgwKTtcbmNvbnN0IENSID0gXCJcXHJcIi5jaGFyQ29kZUF0KDApO1xuY29uc3QgTEYgPSBcIlxcblwiLmNoYXJDb2RlQXQoMCk7XG5jb25zdCBVTk1BVENIRURfU1VSUk9HQVRFX1BBSVJfUkVHRVhQID1cbiAgLyhefFteXFx1RDgwMC1cXHVEQkZGXSlbXFx1REMwMC1cXHVERkZGXXxbXFx1RDgwMC1cXHVEQkZGXShbXlxcdURDMDAtXFx1REZGRl18JCkvZztcbmNvbnN0IFVOTUFUQ0hFRF9TVVJST0dBVEVfUEFJUl9SRVBMQUNFID0gXCIkMVxcdUZGRkQkMlwiO1xuXG4vKiogU2FmZWx5IGRlY29kZSBhIFVSSSBjb21wb25lbnQsIHdoZXJlIGlmIGl0IGZhaWxzLCBpbnN0ZWFkIG9mIHRocm93aW5nLFxuICoganVzdCByZXR1cm5zIHRoZSBvcmlnaW5hbCBzdHJpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZUNvbXBvbmVudCh0ZXh0OiBzdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KHRleHQpO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gdGV4dDtcbiAgfVxufVxuXG4vKiogRW5jb2RlcyB0aGUgdXJsIHByZXZlbnRpbmcgZG91YmxlIGVuY29uZGluZyAqL1xuZXhwb3J0IGZ1bmN0aW9uIGVuY29kZVVybCh1cmw6IHN0cmluZykge1xuICByZXR1cm4gU3RyaW5nKHVybClcbiAgICAucmVwbGFjZShVTk1BVENIRURfU1VSUk9HQVRFX1BBSVJfUkVHRVhQLCBVTk1BVENIRURfU1VSUk9HQVRFX1BBSVJfUkVQTEFDRSlcbiAgICAucmVwbGFjZShFTkNPREVfQ0hBUlNfUkVHRVhQLCBlbmNvZGVVUkkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmFuZG9tRmlsZW5hbWUocHJlZml4ID0gXCJcIiwgZXh0ZW5zaW9uID0gXCJcIik6IHN0cmluZyB7XG4gIHJldHVybiBgJHtwcmVmaXh9JHtcbiAgICBuZXcgU2hhMSgpLnVwZGF0ZShjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKG5ldyBVaW50OEFycmF5KDI1NikpKS5oZXgoKVxuICB9JHtleHRlbnNpb24gPyBgLiR7ZXh0ZW5zaW9ufWAgOiBcIlwifWA7XG59XG5cbi8qKiBEZXRlcm1pbmVzIGlmIGEgSFRUUCBgU3RhdHVzYCBpcyBhbiBgRXJyb3JTdGF0dXNgICg0WFggb3IgNVhYKS4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc0Vycm9yU3RhdHVzKHZhbHVlOiBTdGF0dXMpOiB2YWx1ZSBpcyBFcnJvclN0YXR1cyB7XG4gIHJldHVybiBbXG4gICAgU3RhdHVzLkJhZFJlcXVlc3QsXG4gICAgU3RhdHVzLlVuYXV0aG9yaXplZCxcbiAgICBTdGF0dXMuUGF5bWVudFJlcXVpcmVkLFxuICAgIFN0YXR1cy5Gb3JiaWRkZW4sXG4gICAgU3RhdHVzLk5vdEZvdW5kLFxuICAgIFN0YXR1cy5NZXRob2ROb3RBbGxvd2VkLFxuICAgIFN0YXR1cy5Ob3RBY2NlcHRhYmxlLFxuICAgIFN0YXR1cy5Qcm94eUF1dGhSZXF1aXJlZCxcbiAgICBTdGF0dXMuUmVxdWVzdFRpbWVvdXQsXG4gICAgU3RhdHVzLkNvbmZsaWN0LFxuICAgIFN0YXR1cy5Hb25lLFxuICAgIFN0YXR1cy5MZW5ndGhSZXF1aXJlZCxcbiAgICBTdGF0dXMuUHJlY29uZGl0aW9uRmFpbGVkLFxuICAgIFN0YXR1cy5SZXF1ZXN0RW50aXR5VG9vTGFyZ2UsXG4gICAgU3RhdHVzLlJlcXVlc3RVUklUb29Mb25nLFxuICAgIFN0YXR1cy5VbnN1cHBvcnRlZE1lZGlhVHlwZSxcbiAgICBTdGF0dXMuUmVxdWVzdGVkUmFuZ2VOb3RTYXRpc2ZpYWJsZSxcbiAgICBTdGF0dXMuRXhwZWN0YXRpb25GYWlsZWQsXG4gICAgU3RhdHVzLlRlYXBvdCxcbiAgICBTdGF0dXMuTWlzZGlyZWN0ZWRSZXF1ZXN0LFxuICAgIFN0YXR1cy5VbnByb2Nlc3NhYmxlRW50aXR5LFxuICAgIFN0YXR1cy5Mb2NrZWQsXG4gICAgU3RhdHVzLkZhaWxlZERlcGVuZGVuY3ksXG4gICAgU3RhdHVzLlVwZ3JhZGVSZXF1aXJlZCxcbiAgICBTdGF0dXMuUHJlY29uZGl0aW9uUmVxdWlyZWQsXG4gICAgU3RhdHVzLlRvb01hbnlSZXF1ZXN0cyxcbiAgICBTdGF0dXMuUmVxdWVzdEhlYWRlckZpZWxkc1Rvb0xhcmdlLFxuICAgIFN0YXR1cy5VbmF2YWlsYWJsZUZvckxlZ2FsUmVhc29ucyxcbiAgICBTdGF0dXMuSW50ZXJuYWxTZXJ2ZXJFcnJvcixcbiAgICBTdGF0dXMuTm90SW1wbGVtZW50ZWQsXG4gICAgU3RhdHVzLkJhZEdhdGV3YXksXG4gICAgU3RhdHVzLlNlcnZpY2VVbmF2YWlsYWJsZSxcbiAgICBTdGF0dXMuR2F0ZXdheVRpbWVvdXQsXG4gICAgU3RhdHVzLkhUVFBWZXJzaW9uTm90U3VwcG9ydGVkLFxuICAgIFN0YXR1cy5WYXJpYW50QWxzb05lZ290aWF0ZXMsXG4gICAgU3RhdHVzLkluc3VmZmljaWVudFN0b3JhZ2UsXG4gICAgU3RhdHVzLkxvb3BEZXRlY3RlZCxcbiAgICBTdGF0dXMuTm90RXh0ZW5kZWQsXG4gICAgU3RhdHVzLk5ldHdvcmtBdXRoZW50aWNhdGlvblJlcXVpcmVkLFxuICBdLmluY2x1ZGVzKHZhbHVlKTtcbn1cblxuLyoqIERldGVybWluZXMgaWYgYSBIVFRQIGBTdGF0dXNgIGlzIGEgYFJlZGlyZWN0U3RhdHVzYCAoM1hYKS4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1JlZGlyZWN0U3RhdHVzKHZhbHVlOiBTdGF0dXMpOiB2YWx1ZSBpcyBSZWRpcmVjdFN0YXR1cyB7XG4gIHJldHVybiBbXG4gICAgU3RhdHVzLk11bHRpcGxlQ2hvaWNlcyxcbiAgICBTdGF0dXMuTW92ZWRQZXJtYW5lbnRseSxcbiAgICBTdGF0dXMuRm91bmQsXG4gICAgU3RhdHVzLlNlZU90aGVyLFxuICAgIFN0YXR1cy5Vc2VQcm94eSxcbiAgICBTdGF0dXMuVGVtcG9yYXJ5UmVkaXJlY3QsXG4gICAgU3RhdHVzLlBlcm1hbmVudFJlZGlyZWN0LFxuICBdLmluY2x1ZGVzKHZhbHVlKTtcbn1cblxuLyoqIERldGVybWluZXMgaWYgYSBzdHJpbmcgXCJsb29rc1wiIGxpa2UgSFRNTCAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzSHRtbCh2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gIHJldHVybiAvXlxccyo8KD86IURPQ1RZUEV8aHRtbHxib2R5KS9pLnRlc3QodmFsdWUpO1xufVxuXG4vKiogUmV0dXJucyBgdThgIHdpdGggbGVhZGluZyB3aGl0ZSBzcGFjZSByZW1vdmVkLiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHNraXBMV1NQQ2hhcih1ODogVWludDhBcnJheSk6IFVpbnQ4QXJyYXkge1xuICBjb25zdCByZXN1bHQgPSBuZXcgVWludDhBcnJheSh1OC5sZW5ndGgpO1xuICBsZXQgaiA9IDA7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgdTgubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAodThbaV0gPT09IFNQQUNFIHx8IHU4W2ldID09PSBIVEFCKSBjb250aW51ZTtcbiAgICByZXN1bHRbaisrXSA9IHU4W2ldO1xuICB9XG4gIHJldHVybiByZXN1bHQuc2xpY2UoMCwgaik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpcEVvbCh2YWx1ZTogVWludDhBcnJheSk6IFVpbnQ4QXJyYXkge1xuICBpZiAodmFsdWVbdmFsdWUuYnl0ZUxlbmd0aCAtIDFdID09IExGKSB7XG4gICAgbGV0IGRyb3AgPSAxO1xuICAgIGlmICh2YWx1ZS5ieXRlTGVuZ3RoID4gMSAmJiB2YWx1ZVt2YWx1ZS5ieXRlTGVuZ3RoIC0gMl0gPT09IENSKSB7XG4gICAgICBkcm9wID0gMjtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlLnN1YmFycmF5KDAsIHZhbHVlLmJ5dGVMZW5ndGggLSBkcm9wKTtcbiAgfVxuICByZXR1cm4gdmFsdWU7XG59XG5cbi8qIVxuICogQWRhcHRlZCBkaXJlY3RseSBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9waWxsYXJqcy9yZXNvbHZlLXBhdGhcbiAqIHdoaWNoIGlzIGxpY2Vuc2VkIGFzIGZvbGxvd3M6XG4gKlxuICogVGhlIE1JVCBMaWNlbnNlIChNSVQpXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDE0IEpvbmF0aGFuIE9uZyA8bWVAam9uZ2xlYmVycnkuY29tPlxuICogQ29weXJpZ2h0IChjKSAyMDE1LTIwMTggRG91Z2xhcyBDaHJpc3RvcGhlciBXaWxzb24gPGRvdWdAc29tZXRoaW5nZG91Zy5jb20+XG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nXG4gKiBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGVcbiAqICdTb2Z0d2FyZScpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmdcbiAqIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCxcbiAqIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0b1xuICogcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvXG4gKiB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmVcbiAqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAnQVMgSVMnLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELFxuICogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GXG4gKiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuXG4gKiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWVxuICogQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCxcbiAqIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFXG4gKiBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS5cbiAqL1xuXG5jb25zdCBVUF9QQVRIX1JFR0VYUCA9IC8oPzpefFtcXFxcL10pXFwuXFwuKD86W1xcXFwvXXwkKS87XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlUGF0aChyZWxhdGl2ZVBhdGg6IHN0cmluZyk6IHN0cmluZztcbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlUGF0aChyb290UGF0aDogc3RyaW5nLCByZWxhdGl2ZVBhdGg6IHN0cmluZyk6IHN0cmluZztcbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlUGF0aChyb290UGF0aDogc3RyaW5nLCByZWxhdGl2ZVBhdGg/OiBzdHJpbmcpOiBzdHJpbmcge1xuICBsZXQgcGF0aCA9IHJlbGF0aXZlUGF0aDtcbiAgbGV0IHJvb3QgPSByb290UGF0aDtcblxuICAvLyByb290IGlzIG9wdGlvbmFsLCBzaW1pbGFyIHRvIHJvb3QucmVzb2x2ZVxuICBpZiAocmVsYXRpdmVQYXRoID09PSB1bmRlZmluZWQpIHtcbiAgICBwYXRoID0gcm9vdFBhdGg7XG4gICAgcm9vdCA9IFwiLlwiO1xuICB9XG5cbiAgaWYgKHBhdGggPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJBcmd1bWVudCByZWxhdGl2ZVBhdGggaXMgcmVxdWlyZWQuXCIpO1xuICB9XG5cbiAgLy8gY29udGFpbmluZyBOVUxMIGJ5dGVzIGlzIG1hbGljaW91c1xuICBpZiAocGF0aC5pbmNsdWRlcyhcIlxcMFwiKSkge1xuICAgIHRocm93IGNyZWF0ZUh0dHBFcnJvcig0MDAsIFwiTWFsaWNpb3VzIFBhdGhcIik7XG4gIH1cblxuICAvLyBwYXRoIHNob3VsZCBuZXZlciBiZSBhYnNvbHV0ZVxuICBpZiAoaXNBYnNvbHV0ZShwYXRoKSkge1xuICAgIHRocm93IGNyZWF0ZUh0dHBFcnJvcig0MDAsIFwiTWFsaWNpb3VzIFBhdGhcIik7XG4gIH1cblxuICAvLyBwYXRoIG91dHNpZGUgcm9vdFxuICBpZiAoVVBfUEFUSF9SRUdFWFAudGVzdChub3JtYWxpemUoXCIuXCIgKyBzZXAgKyBwYXRoKSkpIHtcbiAgICB0aHJvdyBjcmVhdGVIdHRwRXJyb3IoNDAzKTtcbiAgfVxuXG4gIC8vIGpvaW4gdGhlIHJlbGF0aXZlIHBhdGhcbiAgcmV0dXJuIG5vcm1hbGl6ZShqb2luKHJvb3QsIHBhdGgpKTtcbn1cbiJdfQ==